<!--
 Copyright 2025 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="使用 Agent Development Kit (ADK) 建構強大的多代理系統">
      
      
      
        <link rel="canonical" href="https://google.github.io/adk-docs/tutorials/agent-team/">
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="../../agents/">
      
      
      <link rel="icon" href="../../assets/agent-development-kit.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>代理團隊 - Agent Development Kit</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Google+Sans:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Google Sans";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/custom.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-DKHZS27PHP"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-DKHZS27PHP",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-DKHZS27PHP",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script>
  

    
    
    
  <!-- HTML Meta Tags -->
  <title>Agent Development Kit</title>
  <meta name="description" content="Build powerful multi-agent systems with Agent Development Kit">

  <!-- Facebook Meta Tags -->
  <meta property="og:url" content="https://google.github.io/adk-docs">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Agent Development Kit">
  <meta property="og:description" content="Build powerful multi-agent systems with Agent Development Kit">
  <meta property="og:image" content="https://google.github.io/adk-docs/assets/adk-social-card.png">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="twitter:domain" content="google.github.io">
  <meta property="twitter:url" content="https://google.github.io/adk-docs">
  <meta name="twitter:title" content="Agent Development Kit">
  <meta name="twitter:description" content="Build powerful multi-agent systems with Agent Development Kit">
  <meta name="twitter:image" content="https://google.github.io/adk-docs/assets/adk-social-card.png">

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="white">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#adk" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      <!--
 Copyright 2025 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<!-- Determine classes -->


  


<!-- Header -->
<header class="md-header md-header--shadow" data-md-component="header">
  <nav
    class="md-header__inner md-grid"
    aria-label="Header"
  >

    <!-- Link to home -->
    <a
      href="../.."
      title="Agent Development Kit"
      class="md-header__button md-logo"
      aria-label="Agent Development Kit"
      data-md-component="logo"
    >
      
  <img src="../../assets/agent-development-kit.png" alt="logo">

    </a>

    <!-- Button to open drawer -->
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>

    <!-- Header title -->
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            <a
      href="../.."
      title="Agent Development Kit"
      aria-label="Agent Development Kit"
      data-md-component="logo"
    >
            Agent Development Kit
            </a>
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              代理團隊
            
            </a>
          </span>
        </div>
      </div>
    </div>

    <!-- Color palette toggle -->
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="white"  aria-label="切換至深色模式"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="切換至深色模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="white" data-md-color-accent="white"  aria-label="切換至淺色模式"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="切換至淺色模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    

    <!-- User preference: color palette -->
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    

    <!-- Site language selector -->
    

    <!-- Button to open search modal -->
    
      

      <!-- Check if search is actually enabled - see https://t.ly/DT_0V -->
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>

        <!-- Search interface -->
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    

    <!-- Repository information -->
    
      <div class="md-header__source">
        <!-- First Repository information -->
<a
  href="https://github.com/google/adk-python"
  title="Go to repository"
  class="md-source"
  data-md-component="source"
  style="margin-right: 10px;"
>
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    adk-python
  </div>
</a>

<!-- Second Repository information -->
<a
  href="https://github.com/google/adk-java"
  title="adk-java"
  class="md-source"
  data-md-component="source"
>
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    adk-java
  </div>
</a> 
      </div>
    
  </nav>

  <!-- Navigation tabs (sticky) -->
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Agent Development Kit" class="md-nav__button md-logo" aria-label="Agent Development Kit" data-md-component="logo">
      
  <img src="../../assets/agent-development-kit.png" alt="logo">

    </a>
    Agent Development Kit
  </label>
  
    <div class="md-nav__source">
      <!-- First Repository information -->
<a
  href="https://github.com/google/adk-python"
  title="Go to repository"
  class="md-source"
  data-md-component="source"
  style="margin-right: 10px;"
>
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    adk-python
  </div>
</a>

<!-- Second Repository information -->
<a
  href="https://github.com/google/adk-java"
  title="adk-java"
  class="md-source"
  data-md-component="source"
>
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    adk-java
  </div>
</a> 
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    首頁
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../get-started/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    快速開始
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            快速開始
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../get-started/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    安裝
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../get-started/quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    快速入門
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../get-started/streaming/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    快速入門（串流）
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            快速入門（串流）
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../get-started/streaming/quickstart-streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Python
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../get-started/streaming/quickstart-streaming-java/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../get-started/testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    測試
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/google/adk-samples" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    範例代理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../get-started/about/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    關於 ADK
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    教學課程
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            教學課程
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    代理團隊
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    代理團隊
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-agent" class="md-nav__link">
    <span class="md-ellipsis">
      步驟 1：你的第一個 Agent —— 基本天氣查詢
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-litellm" class="md-nav__link">
    <span class="md-ellipsis">
      步驟 2：使用 LiteLLM 實現多模型支援【選用】
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-agent-team" class="md-nav__link">
    <span class="md-ellipsis">
      步驟 3：打造 Agent Team —— 問候與道別的委派
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-session-state" class="md-nav__link">
    <span class="md-ellipsis">
      步驟 4：使用 Session State 增加記憶與個人化
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-before_model_callback-input-guardrail" class="md-nav__link">
    <span class="md-ellipsis">
      步驟 5：加入安全防護 - 透過 before_model_callback 實作輸入防線（Input Guardrail）
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-before_tool_callback" class="md-nav__link">
    <span class="md-ellipsis">
      步驟 6：新增安全性 - 工具參數防護欄（before_tool_callback）
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agent-team" class="md-nav__link">
    <span class="md-ellipsis">
      結論：你的 Agent Team 已經準備就緒！
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../agents/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    代理
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            代理
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/llm-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    大型語言模型 (LLM) 代理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../agents/workflow-agents/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    工作流程代理
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            工作流程代理
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/workflow-agents/sequential-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    序列代理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/workflow-agents/loop-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    迴圈代理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/workflow-agents/parallel-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    平行代理
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/custom-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    自訂代理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/multi-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    多代理系統
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    代理設定
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    模型與驗證
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../tools/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    工具
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            工具
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    函式工具
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            函式工具
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/function-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    概覽
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/performance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    工具效能
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/confirmation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    行動確認
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/built-in-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    內建工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/third-party-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    第三方工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/google-cloud-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Google Cloud 工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/mcp-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MCP 工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/openapi-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OpenAPI 工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/authentication/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    驗證
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../runtime/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    執行代理
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            執行代理
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../runtime/runconfig/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    執行環境設定
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../deploy/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    部署
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            部署
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deploy/agent-engine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    代理引擎
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deploy/cloud-run/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cloud Run
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deploy/gke/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GKE
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../sessions/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    工作階段與記憶體
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_8" id="__nav_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            工作階段與記憶體
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sessions/session/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    工作階段
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sessions/state/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    狀態
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sessions/memory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    記憶體
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sessions/express-mode/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Vertex AI Express 模式
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../callbacks/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    回呼
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9" id="__nav_9_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            回呼
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../callbacks/types-of-callbacks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    回呼類型
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../callbacks/design-patterns-and-best-practices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    回呼設計模式
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../artifacts/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    成品
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            成品
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../events/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    事件
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            事件
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../context/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    上下文
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            上下文
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    可觀測性
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            可觀測性
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../observability/logging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    日誌
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../observability/cloud-trace/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cloud Trace
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../observability/agentops/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AgentOps
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../observability/arize-ax/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Arize AX
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../observability/phoenix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Phoenix
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../observability/weave/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    W&B Weave
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../evaluate/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    評估
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_14">
            <span class="md-nav__icon md-icon"></span>
            評估
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_15" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../mcp/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    MCP
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_15_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_15">
            <span class="md-nav__icon md-icon"></span>
            MCP
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_16" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../plugins/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    外掛
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_16_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_16">
            <span class="md-nav__icon md-icon"></span>
            外掛
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_17" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../streaming/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    雙向串流（即時）
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_17" id="__nav_17_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_17_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_17">
            <span class="md-nav__icon md-icon"></span>
            雙向串流（即時）
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../get-started/streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    串流快速開始
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../streaming/custom-streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    自訂音訊雙向串流應用範例（SSE）
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../streaming/custom-streaming-ws/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    自訂音訊雙向串流應用範例（WebSockets）
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../streaming/dev-guide/part1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    雙向串流開發指南系列
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../streaming/streaming-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    串流工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../streaming/configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    雙向串流行為設定
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://medium.com/google-cloud/google-adk-vertex-ai-live-api-125238982d5e" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Google ADK + Vertex AI Live API（部落格文章）
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_18" >
        
          
          <label class="md-nav__link" for="__nav_18" id="__nav_18_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Grounding
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_18_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_18">
            <span class="md-nav__icon md-icon"></span>
            Grounding
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../grounding/google_search_grounding/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    認識 Google Search Grounding
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../grounding/vertex_ai_search_grounding/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    認識 Vertex AI Search Grounding
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../safety/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    安全與資安
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_20" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../a2a/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    A2A 協定
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_20" id="__nav_20_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_20_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_20">
            <span class="md-nav__icon md-icon"></span>
            A2A 協定
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../a2a/intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    A2A 介紹
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../a2a/quickstart-exposing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    A2A 快速入門（Exposing）
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../a2a/quickstart-consuming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    A2A 快速入門（Consuming）
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://a2a-protocol.org" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    A2A 協定文件
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../community/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    社群資源
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    貢獻指南
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_23" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../api-reference/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    API 參考
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_23" id="__nav_23_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_23_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_23">
            <span class="md-nav__icon md-icon"></span>
            API 參考
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api-reference/python/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Python ADK
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api-reference/java/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java ADK
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api-reference/cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CLI 參考
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api-reference/agentconfig/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Agent Config 參考
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api-reference/rest/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    REST API
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-agent" class="md-nav__link">
    <span class="md-ellipsis">
      步驟 1：你的第一個 Agent —— 基本天氣查詢
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-litellm" class="md-nav__link">
    <span class="md-ellipsis">
      步驟 2：使用 LiteLLM 實現多模型支援【選用】
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-agent-team" class="md-nav__link">
    <span class="md-ellipsis">
      步驟 3：打造 Agent Team —— 問候與道別的委派
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-session-state" class="md-nav__link">
    <span class="md-ellipsis">
      步驟 4：使用 Session State 增加記憶與個人化
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-before_model_callback-input-guardrail" class="md-nav__link">
    <span class="md-ellipsis">
      步驟 5：加入安全防護 - 透過 before_model_callback 實作輸入防線（Input Guardrail）
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-before_tool_callback" class="md-nav__link">
    <span class="md-ellipsis">
      步驟 6：新增安全性 - 工具參數防護欄（before_tool_callback）
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agent-team" class="md-nav__link">
    <span class="md-ellipsis">
      結論：你的 Agent Team 已經準備就緒！
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="adk">建立你的第一個智慧型代理團隊：使用 ADK 打造漸進式天氣機器人<a class="headerlink" href="#adk" title="Permanent link">&para;</a></h1>
<!-- Optional outer container for overall padding/spacing -->
<div style="padding: 10px 0;">

  <!-- Line 1: Open in Colab -->
  <!-- This div ensures the link takes up its own line and adds space below -->
  <div style="margin-bottom: 10px;">
    <a href="https://colab.research.google.com/github/google/adk-docs/blob/main/examples/python/tutorial/agent_team/adk_tutorial.ipynb"" target="_blank" style="display: inline-flex; align-items: center; gap: 5px; text-decoration: none; color: #4285F4;">
      <img width="32px" src="https://www.gstatic.com/pantheon/images/bigquery/welcome_page/colab-logo.svg"" alt="Google Colaboratory logo">
      <span>在 Colab 開啟</span>
    </a>
  </div>

  <!-- Line 2: Share Links -->
  <!-- This div acts as a flex container for the "Share to" text and icons -->
  <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
    <!-- Share Text -->
    <span style="font-weight: bold;">分享至：</span>

    <!-- Social Media Links -->
    <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A//github/google/adk-docs/blob/main/examples/python/tutorial/agent_team/adk_tutorial.ipynb" target="_blank" title="Share on LinkedIn">
      <img width="20px" src="https://upload.wikimedia.org/wikipedia/commons/8/81/LinkedIn_icon.svg" alt="LinkedIn logo" style="vertical-align: middle;">
    </a>
    <a href="https://bsky.app/intent/compose?text=https%3A//github/google/adk-docs/blob/main/examples/python/tutorial/agent_team/adk_tutorial.ipynb" target="_blank" title="Share on Bluesky">
      <img width="20px" src="https://upload.wikimedia.org/wikipedia/commons/7/7a/Bluesky_Logo.svg" alt="Bluesky logo" style="vertical-align: middle;">
    </a>
    <a href="https://twitter.com/intent/tweet?url=https%3A//github/google/adk-docs/blob/main/examples/python/tutorial/agent_team/adk_tutorial.ipynb" target="_blank" title="Share on X (Twitter)">
      <img width="20px" src="https://upload.wikimedia.org/wikipedia/commons/5/5a/X_icon_2.svg" alt="X logo" style="vertical-align: middle;">
    </a>
    <a href="https://reddit.com/submit?url=https%3A//github/google/adk-docs/blob/main/examples/python/tutorial/agent_team/adk_tutorial.ipynb" target="_blank" title="Share on Reddit">
      <img width="20px" src="https://redditinc.com/hubfs/Reddit%20Inc/Brand/Reddit_Logo.png" alt="Reddit logo" style="vertical-align: middle;">
    </a>
    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//github/google/adk-docs/blob/main/examples/python/tutorial/agent_team/adk_tutorial.ipynb" target="_blank" title="Share on Facebook">
      <img width="20px" src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg" alt="Facebook logo" style="vertical-align: middle;">
    </a>
  </div>

</div>

<p>本教學延伸自 <a href="https://doggy8088.github.io/adk-docs/get-started/quickstart/">快速開始範例</a>，適用於 <a href="https://doggy8088.github.io/adk-docs/get-started/">Agent Development Kit (ADK)</a>。現在，你已經準備好更深入探索，並構建一個更進階的 <strong>多 agent 系統</strong>。</p>
<p>我們將著手打造一個 <strong>Weather Bot agent 團隊</strong>，從簡單基礎逐步加入進階功能。起初是一個能查詢天氣的單一 agent，接著會逐步新增以下能力：</p>
<ul>
<li>利用不同的大型語言模型 (LLM)（如 Gemini、GPT、Claude）。</li>
<li>為不同任務（如問候與道別）設計專門的子 agent。</li>
<li>讓 agent 之間能夠智慧地分工協作。</li>
<li>透過持久化 session state，賦予 agent 記憶能力。</li>
<li>使用 Callbacks 實作關鍵的安全防護措施。</li>
</ul>
<p><strong>為什麼選擇 Weather Bot 團隊？</strong></p>
<p>這個案例雖然看似簡單，但它提供了一個實用且易於理解的場景，讓你能深入學習構建複雜、真實世界 agent 應用時，所需的 ADK 核心概念。你將學會如何設計互動流程、管理狀態、確保安全，以及協調多個 AI「大腦」共同運作。</p>
<p><strong>ADK 是什麼？</strong></p>
<p>再次提醒，Agent Development Kit (ADK) 是一套專為簡化大型語言模型 (Large Language Model, LLM) 應用開發而設計的 Python 框架。它提供強大的基礎組件，讓你能夠建立具備推理、規劃、工具運用、動態與使用者互動，以及團隊協作能力的 agent。</p>
<p><strong>在本進階教學中，你將學會：</strong></p>
<ul>
<li>✅ <strong>工具定義與使用：</strong> 編寫 Python 函式（<code>tools</code>），賦予 agent 特定能力（如取得資料），並教導 agent 如何有效運用這些工具。</li>
<li>✅ <strong>多 LLM 彈性切換：</strong> 透過 LiteLLM 整合，設定 agent 使用多種主流 LLM（Gemini、GPT-4o、Claude Sonnet），讓你能針對不同任務選擇最佳模型。</li>
<li>✅ <strong>agent 分工與協作：</strong> 設計專業分工的子 agent，並啟用自動路由（<code>auto flow</code>），將使用者請求分派給團隊中最合適的 agent。</li>
<li>✅ <strong>Session State 記憶功能：</strong> 利用 <code>Session State</code> 與 <code>ToolContext</code>，讓 agent 能夠在多輪對話中記住資訊，實現更具情境感的互動。</li>
<li>✅ <strong>安全防護（Guardrails）與 Callbacks：</strong> 實作 <code>before_model_callback</code> 與 <code>before_tool_callback</code>，根據預設規則檢查、修改或阻擋請求／工具使用，提升應用安全性與可控性。</li>
</ul>
<p><strong>最終成果預期：</strong></p>
<p>完成本教學後，你將打造出一個功能完整的多 agent Weather Bot 系統。這個系統不僅能提供天氣資訊，還能處理對話禮節、記住最後查詢的城市，並在明確的安全界限內運作，所有流程皆由 ADK 協調實現。</p>
<p><strong>先決條件：</strong></p>
<ul>
<li>✅ <strong>具備紮實的 Python 程式設計基礎。</strong></li>
<li>✅ <strong>熟悉大型語言模型 (LLM)、API 與 agent 概念。</strong></li>
<li>❗ <strong>最重要：已完成 ADK 快速開始教學，或具備等同 ADK 基礎知識（Agent、Runner、SessionService、基本工具使用）。</strong> 本教學將直接建立在這些概念之上。</li>
<li>✅ <strong>你預計使用的 LLM 之 API KEY</strong>（例如：Gemini 需 Google AI Studio、OpenAI Platform、Anthropic Console）。</li>
</ul>
<hr />
<p><strong>執行環境說明：</strong></p>
<p>本教學設計適用於 Google Colab、Colab Enterprise 或 Jupyter notebook 等互動式 notebook 環境。請注意以下事項：</p>
<ul>
<li><strong>執行非同步程式碼：</strong> notebook 環境對非同步程式碼的處理方式有所不同。你會看到範例同時使用 <code>await</code>（適用於已經有 event loop 的 notebook 環境）或 <code>asyncio.run()</code>（通常用於獨立 <code>.py</code> 腳本或特定 notebook 設定）。程式碼區塊會針對兩種情境提供指引。</li>
<li><strong>手動建立 Runner／Session：</strong> 步驟中會明確建立 <code>Runner</code> 與 <code>SessionService</code> 實例。這種做法能讓你細緻掌控 agent 的執行生命週期、session 管理與狀態持久化。</li>
</ul>
<p><strong>替代方案：使用 ADK 內建工具（Web UI／CLI／API Server）</strong></p>
<p>如果你偏好自動處理 runner 與 session 管理的標準化流程，可參考 <a href="https://github.com/google/adk-docs/tree/main/examples/python/tutorial/agent_team/adk-tutorial">這裡</a> 提供的等效程式碼。該版本設計可直接用 <code>adk web</code>（啟動網頁 UI）、<code>adk run</code>（命令列互動）或 <code>adk api_server</code>（開放 API）等指令執行。請依照該資源中的 <code>README.md</code> 指示操作。</p>
<hr />
<p><strong>準備好打造你的 agent 團隊了嗎？讓我們開始吧！</strong></p>
<blockquote>
<p><strong>注意：</strong> 本教學適用於 adk 1.0.0 以上版本</p>
</blockquote>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># @title Step 0: Setup and Installation</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="c1"># Install ADK and LiteLLM for multi-model support</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">google</span><span class="o">-</span><span class="n">adk</span> <span class="o">-</span><span class="n">q</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">litellm</span> <span class="o">-</span><span class="n">q</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Installation complete.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># @title Import necessary libraries</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">Agent</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.models.lite_llm</span><span class="w"> </span><span class="kn">import</span> <span class="n">LiteLlm</span> <span class="c1"># For multi-model support</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.sessions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemorySessionService</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.runners</span><span class="w"> </span><span class="kn">import</span> <span class="n">Runner</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.genai</span><span class="w"> </span><span class="kn">import</span> <span class="n">types</span> <span class="c1"># For creating message Content/Parts</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="c1"># Ignore all warnings</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Libraries imported.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># @title Configure API Keys (Replace with your actual keys!)</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="c1"># --- IMPORTANT: Replace placeholders with your real API keys ---</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="c1"># Gemini API Key (Get from Google AI Studio: https://aistudio.google.com/app/apikey)</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;GOOGLE_API_KEY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;YOUR_GOOGLE_API_KEY&quot;</span> <span class="c1"># &lt;--- REPLACE</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="c1"># [Optional]</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="c1"># OpenAI API Key (Get from OpenAI Platform: https://platform.openai.com/api-keys)</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OPENAI_API_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;YOUR_OPENAI_API_KEY&#39;</span> <span class="c1"># &lt;--- REPLACE</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="c1"># [Optional]</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="c1"># Anthropic API Key (Get from Anthropic Console: https://console.anthropic.com/settings/keys)</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ANTHROPIC_API_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;YOUR_ANTHROPIC_API_KEY&#39;</span> <span class="c1"># &lt;--- REPLACE</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="c1"># --- Verify Keys (Optional Check) ---</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;API Keys Set:&quot;</span><span class="p">)</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Google API Key set: </span><span class="si">{</span><span class="s1">&#39;Yes&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GOOGLE_API_KEY&#39;</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;GOOGLE_API_KEY&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;YOUR_GOOGLE_API_KEY&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;No (REPLACE PLACEHOLDER!)&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OpenAI API Key set: </span><span class="si">{</span><span class="s1">&#39;Yes&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OPENAI_API_KEY&#39;</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OPENAI_API_KEY&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;YOUR_OPENAI_API_KEY&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;No (REPLACE PLACEHOLDER!)&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Anthropic API Key set: </span><span class="si">{</span><span class="s1">&#39;Yes&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ANTHROPIC_API_KEY&#39;</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ANTHROPIC_API_KEY&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;YOUR_ANTHROPIC_API_KEY&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;No (REPLACE PLACEHOLDER!)&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="c1"># Configure ADK to use API keys directly (not Vertex AI for this multi-model setup)</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;GOOGLE_GENAI_USE_VERTEXAI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;False&quot;</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="c1"># @markdown **Security Note:** It&#39;s best practice to manage API keys securely (e.g., using Colab Secrets or environment variables) rather than hardcoding them directly in the notebook. Replace the placeholder strings above.</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># --- Define Model Constants for easier use ---</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="c1"># More supported models can be referenced here: https://ai.google.dev/gemini-api/docs/models#model-variations</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="n">MODEL_GEMINI_2_0_FLASH</span> <span class="o">=</span> <span class="s2">&quot;gemini-2.0-flash&quot;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="c1"># More supported models can be referenced here: https://docs.litellm.ai/docs/providers/openai#openai-chat-completion-models</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="n">MODEL_GPT_4O</span> <span class="o">=</span> <span class="s2">&quot;openai/gpt-4.1&quot;</span> <span class="c1"># You can also try: gpt-4.1-mini, gpt-4o etc.</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="c1"># More supported models can be referenced here: https://docs.litellm.ai/docs/providers/anthropic</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="n">MODEL_CLAUDE_SONNET</span> <span class="o">=</span> <span class="s2">&quot;anthropic/claude-sonnet-4-20250514&quot;</span> <span class="c1"># You can also try: claude-opus-4-20250514 , claude-3-7-sonnet-20250219 etc</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Environment configured.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h2 id="1-agent">步驟 1：你的第一個 Agent —— 基本天氣查詢<a class="headerlink" href="#1-agent" title="Permanent link">&para;</a></h2>
<p>我們先從建立 Weather Bot 的基礎元件開始：一個能夠執行特定任務的 agent——查詢天氣資訊。這包含兩個核心部分：</p>
<ol>
<li><strong>工具（Tool）：</strong> 一個 Python 函式，賦予 agent 取得天氣資料的<em>能力</em>。  </li>
<li><strong>Agent：</strong> 理解使用者需求、知道自己擁有天氣工具，並能決定何時及如何使用該工具的 AI「大腦」。</li>
</ol>
<hr />
<p><strong>1. 定義工具（<code>get_weather</code>）</strong></p>
<p>在 Agent Development Kit (ADK) 中，<strong>工具（Tools）</strong> 是讓 agent 具備具體能力的基石，超越單純的文字生成。工具通常是執行特定動作的標準 Python 函式，例如呼叫 API、查詢資料庫或進行計算。</p>
<p>我們的第一個工具將提供<em>模擬</em>天氣報告。這讓我們可以專注於 agent 的架構設計，而暫時不需要外部 API 金鑰。日後，你可以輕鬆將這個模擬函式替換為真正呼叫天氣服務的版本。</p>
<p><strong>關鍵概念：Docstring 非常重要！</strong> agent 所用的大型語言模型 (LLM) 極度依賴函式的<strong>docstring</strong>來理解：</p>
<ul>
<li>這個工具<em>做什麼</em>。  </li>
<li>什麼時候<em>該使用</em>它。  </li>
<li>它需要哪些<em>參數</em>（<code>city: str</code>）。  </li>
<li>它會<em>回傳什麼資訊</em>。</li>
</ul>
<p><strong>最佳實踐：</strong> 為你的工具撰寫清楚、具描述性且準確的 docstring。這對於 LLM 能否正確使用該工具至關重要。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># @title Define the get_weather Tool</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_weather</span><span class="p">(</span><span class="n">city</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieves the current weather report for a specified city.</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="sd">    Args:</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="sd">        city (str): The name of the city (e.g., &quot;New York&quot;, &quot;London&quot;, &quot;Tokyo&quot;).</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="sd">    Returns:</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="sd">        dict: A dictionary containing the weather information.</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="sd">              Includes a &#39;status&#39; key (&#39;success&#39; or &#39;error&#39;).</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="sd">              If &#39;success&#39;, includes a &#39;report&#39; key with weather details.</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="sd">              If &#39;error&#39;, includes an &#39;error_message&#39; key.</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: get_weather called for city: </span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span> <span class="c1"># Log tool execution</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>    <span class="n">city_normalized</span> <span class="o">=</span> <span class="n">city</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="c1"># Basic normalization</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>    <span class="c1"># Mock weather data</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>    <span class="n">mock_weather_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>        <span class="s2">&quot;newyork&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;report&quot;</span><span class="p">:</span> <span class="s2">&quot;The weather in New York is sunny with a temperature of 25°C.&quot;</span><span class="p">},</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>        <span class="s2">&quot;london&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;report&quot;</span><span class="p">:</span> <span class="s2">&quot;It&#39;s cloudy in London with a temperature of 15°C.&quot;</span><span class="p">},</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>        <span class="s2">&quot;tokyo&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;report&quot;</span><span class="p">:</span> <span class="s2">&quot;Tokyo is experiencing light rain and a temperature of 18°C.&quot;</span><span class="p">},</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>    <span class="p">}</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>    <span class="k">if</span> <span class="n">city_normalized</span> <span class="ow">in</span> <span class="n">mock_weather_db</span><span class="p">:</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>        <span class="k">return</span> <span class="n">mock_weather_db</span><span class="p">[</span><span class="n">city_normalized</span><span class="p">]</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;error_message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Sorry, I don&#39;t have weather information for &#39;</span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">}</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a><span class="c1"># Example tool usage (optional test)</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a><span class="nb">print</span><span class="p">(</span><span class="n">get_weather</span><span class="p">(</span><span class="s2">&quot;New York&quot;</span><span class="p">))</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a><span class="nb">print</span><span class="p">(</span><span class="n">get_weather</span><span class="p">(</span><span class="s2">&quot;Paris&quot;</span><span class="p">))</span>
</span></code></pre></div>
<hr />
<p><strong>2. 定義 Agent（<code>weather_agent</code>）</strong></p>
<p>現在，讓我們來建立 <strong>Agent</strong> 本身。在 Agent Development Kit (ADK) 中，<code>Agent</code> 負責協調使用者、大型語言模型 (LLM) 以及可用工具（tools）之間的互動。</p>
<p>我們會以幾個關鍵參數來設定它：</p>
<ul>
<li><code>name</code>：此 agent 的唯一識別碼（例如："weather_agent_v1"）。</li>
<li><code>model</code>：指定要使用哪個大型語言模型 (LLM)（例如：<code>MODEL_GEMINI_2_0_FLASH</code>）。我們這裡會以特定的 Gemini 模型作為起點。</li>
<li><code>description</code>：簡明扼要地說明此 agent 的整體用途。當其他 agent 需要判斷是否要將任務委派給<em>這個</em> agent 時，這一點會變得非常重要。</li>
<li><code>instruction</code>：針對大型語言模型 (LLM) 的詳細指引，包含其行為、角色設定、目標，以及<em>如何與何時</em>使用其指派的<code>tools</code>。</li>
<li><code>tools</code>：一個列表，包含此 agent 被允許使用的實際 Python 工具函式（例如：<code>[get_weather]</code>）。</li>
</ul>
<p><strong>最佳實踐：</strong> 請提供明確且具體的 <code>instruction</code> 提示。說明越詳細，大型語言模型 (LLM) 越能理解其角色，以及如何有效運用其工具。若有錯誤處理需求，也請明確說明。</p>
<p><strong>最佳實踐：</strong> 請選擇具描述性的 <code>name</code> 與 <code>description</code> 值。這些值會在 ADK 內部使用，並對於自動委派等功能（後續會介紹）非常重要。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># @title Define the Weather Agent</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="c1"># Use one of the model constants defined earlier</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="n">AGENT_MODEL</span> <span class="o">=</span> <span class="n">MODEL_GEMINI_2_0_FLASH</span> <span class="c1"># Starting with Gemini</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="n">weather_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_agent_v1&quot;</span><span class="p">,</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    <span class="n">model</span><span class="o">=</span><span class="n">AGENT_MODEL</span><span class="p">,</span> <span class="c1"># Can be a string for Gemini or a LiteLlm object</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Provides weather information for specific cities.&quot;</span><span class="p">,</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>    <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are a helpful weather assistant. &quot;</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>                <span class="s2">&quot;When the user asks for the weather in a specific city, &quot;</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>                <span class="s2">&quot;use the &#39;get_weather&#39; tool to find the information. &quot;</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>                <span class="s2">&quot;If the tool returns an error, inform the user politely. &quot;</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>                <span class="s2">&quot;If the tool is successful, present the weather report clearly.&quot;</span><span class="p">,</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">get_weather</span><span class="p">],</span> <span class="c1"># Pass the function directly</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="p">)</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent &#39;</span><span class="si">{</span><span class="n">weather_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; created using model &#39;</span><span class="si">{</span><span class="n">AGENT_MODEL</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p><strong>3. 設定 Runner 與 Session Service</strong></p>
<p>為了管理對話並執行 agent，我們還需要另外兩個元件：</p>
<ul>
<li><code>SessionService</code>：負責管理不同使用者與 session 的對話歷史與狀態。<code>InMemorySessionService</code> 是一個簡單的實作，會將所有資料儲存在記憶體中，適合用於測試與簡單應用。它會追蹤所有交換的訊息。我們會在步驟 4 更深入探討狀態持久化（state persistence）。</li>
<li><code>Runner</code>：協調互動流程的引擎。它接收使用者輸入，將其路由到適當的 agent，依據 agent 的邏輯管理對大型語言模型 (LLM) 與 tools 的呼叫，透過 <code>SessionService</code> 處理 session 更新，並產生代表互動進度的事件（events）。</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># @title Setup Session Service and Runner</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="c1"># --- Session Management ---</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="c1"># Key Concept: SessionService stores conversation history &amp; state.</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="c1"># InMemorySessionService is simple, non-persistent storage for this tutorial.</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="n">session_service</span> <span class="o">=</span> <span class="n">InMemorySessionService</span><span class="p">()</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="c1"># Define constants for identifying the interaction context</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="n">APP_NAME</span> <span class="o">=</span> <span class="s2">&quot;weather_tutorial_app&quot;</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="n">USER_ID</span> <span class="o">=</span> <span class="s2">&quot;user_1&quot;</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="n">SESSION_ID</span> <span class="o">=</span> <span class="s2">&quot;session_001&quot;</span> <span class="c1"># Using a fixed ID for simplicity</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="c1"># Create the specific session where the conversation will happen</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="n">session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>    <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>    <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>    <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="p">)</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session created: App=&#39;</span><span class="si">{</span><span class="n">APP_NAME</span><span class="si">}</span><span class="s2">&#39;, User=&#39;</span><span class="si">{</span><span class="n">USER_ID</span><span class="si">}</span><span class="s2">&#39;, Session=&#39;</span><span class="si">{</span><span class="n">SESSION_ID</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="c1"># --- Runner ---</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="c1"># Key Concept: Runner orchestrates the agent execution loop.</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="n">runner</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>    <span class="n">agent</span><span class="o">=</span><span class="n">weather_agent</span><span class="p">,</span> <span class="c1"># The agent we want to run</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>    <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>   <span class="c1"># Associates runs with our app</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>    <span class="n">session_service</span><span class="o">=</span><span class="n">session_service</span> <span class="c1"># Uses our session manager</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a><span class="p">)</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runner created for agent &#39;</span><span class="si">{</span><span class="n">runner</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p><strong>4. 與 agent 互動</strong></p>
<p>我們需要一種方式來傳送訊息給 agent 並接收其回應。由於大型語言模型 (LLM) 呼叫與工具執行可能需要一些時間，Agent Development Kit (ADK) 的 <code>Runner</code> 是以非同步方式運作的。</p>
<p>我們將定義一個 <code>async</code> 輔助函式（<code>call_agent_async</code>），其功能如下：</p>
<ol>
<li>接收使用者查詢字串。</li>
<li>將其包裝成 ADK 的 <code>Content</code> 格式。</li>
<li>呼叫 <code>runner.run_async</code>，並提供使用者／session context 以及新的訊息。</li>
<li>迭代 ADK runner 所產生的 <strong>Events</strong>。每個 Event 代表 agent 執行過程中的一個步驟（例如：工具呼叫 (tool calls) 請求、收到工具結果、中間 LLM 思考、最終回應）。</li>
<li>使用 <code>event.is_final_response()</code> 辨識並印出 <strong>最終回應</strong> 的 event。</li>
</ol>
<p><strong>為什麼要用 <code>async</code>？</strong> 與大型語言模型 (LLM) 及潛在工具（如外部 API）的互動屬於 I/O 密集操作。使用 <code>asyncio</code> 可以讓程式有效率地處理這些操作，而不會阻塞執行流程。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># @title Define Agent Interaction Function</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.genai</span><span class="w"> </span><span class="kn">import</span> <span class="n">types</span> <span class="c1"># For creating message Content/Parts</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">runner</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">  </span><span class="sd">&quot;&quot;&quot;Sends a query to the agent and prints the final response.&quot;&quot;&quot;</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&gt;&gt;&gt; User Query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>  <span class="c1"># Prepare the user&#39;s message in ADK format</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>  <span class="n">content</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">Content</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">parts</span><span class="o">=</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">Part</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">query</span><span class="p">)])</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>  <span class="n">final_response_text</span> <span class="o">=</span> <span class="s2">&quot;Agent did not produce a final response.&quot;</span> <span class="c1"># Default</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>  <span class="c1"># Key Concept: run_async executes the agent logic and yields Events.</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>  <span class="c1"># We iterate through events to find the final answer.</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>  <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">run_async</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span> <span class="n">new_message</span><span class="o">=</span><span class="n">content</span><span class="p">):</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>      <span class="c1"># You can uncomment the line below to see *all* events during execution</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>      <span class="c1"># print(f&quot;  [Event] Author: {event.author}, Type: {type(event).__name__}, Final: {event.is_final_response()}, Content: {event.content}&quot;)</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>      <span class="c1"># Key Concept: is_final_response() marks the concluding message for the turn.</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>      <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">is_final_response</span><span class="p">():</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>          <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">content</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>             <span class="c1"># Assuming text response in the first part</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>             <span class="n">final_response_text</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>          <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">actions</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">escalate</span><span class="p">:</span> <span class="c1"># Handle potential errors/escalations</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>             <span class="n">final_response_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Agent escalated: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">error_message</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;No specific message.&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>          <span class="c1"># Add more checks here if needed (e.g., specific error codes)</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>          <span class="k">break</span> <span class="c1"># Stop processing events once the final response is found</span>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;&lt;&lt; Agent Response: </span><span class="si">{</span><span class="n">final_response_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p><strong>5. 執行對話</strong></p>
<p>最後，讓我們透過向 agent 發送幾個查詢來測試我們的設定。我們將 <code>async</code> 呼叫包裝在主要的 <code>async</code> 函式中，並使用 <code>await</code> 執行它。</p>
<p>請觀察輸出結果：</p>
<ul>
<li>查看使用者查詢。  </li>
<li>注意當 agent 使用工具時的 <code>--- Tool: get_weather called... ---</code> 日誌。  </li>
<li>觀察 agent 的最終回應，包括它如何處理無法取得天氣資料（如巴黎）的情況。</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># @title Run the Initial Conversation</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="c1"># We need an async function to await our interaction helper</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_conversation</span><span class="p">():</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>    <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="s2">&quot;What is the weather like in London?&quot;</span><span class="p">,</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>                                       <span class="n">runner</span><span class="o">=</span><span class="n">runner</span><span class="p">,</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>                                       <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>                                       <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>    <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="s2">&quot;How about Paris?&quot;</span><span class="p">,</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>                                       <span class="n">runner</span><span class="o">=</span><span class="n">runner</span><span class="p">,</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>                                       <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>                                       <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span> <span class="c1"># Expecting the tool&#39;s error message</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>    <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="s2">&quot;Tell me the weather in New York&quot;</span><span class="p">,</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>                                       <span class="n">runner</span><span class="o">=</span><span class="n">runner</span><span class="p">,</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>                                       <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>                                       <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="c1"># Execute the conversation using await in an async context (like Colab/Jupyter)</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="k">await</span> <span class="n">run_conversation</span><span class="p">()</span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span class="c1"># --- OR ---</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a><span class="c1"># Uncomment the following lines if running as a standard Python script (.py file):</span>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a><span class="c1"># import asyncio</span>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a><span class="c1"># if __name__ == &quot;__main__&quot;:</span>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a><span class="c1">#     try:</span>
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a><span class="c1">#         asyncio.run(run_conversation())</span>
</span><span id="__span-8-30"><a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a><span class="c1">#     except Exception as e:</span>
</span><span id="__span-8-31"><a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a><span class="c1">#         print(f&quot;An error occurred: {e}&quot;)</span>
</span></code></pre></div>
<hr />
<p>恭喜你！你已成功建立並與你的第一個 Agent Development Kit (ADK) agent 互動。它能理解使用者的請求，使用工具來查找資訊，並根據工具的結果做出適當回應。</p>
<p>在下一步中，我們將探索如何輕鬆切換這個 agent 背後所使用的語言模型（Language Model）。</p>
<h2 id="2-litellm">步驟 2：使用 LiteLLM 實現多模型支援【選用】<a class="headerlink" href="#2-litellm" title="Permanent link">&para;</a></h2>
<p>在步驟 1 中，我們建立了一個由特定 Gemini 模型驅動的天氣 agent。雖然這樣已經很有效，但在實際應用中，能夠靈活使用<em>不同</em>的大型語言模型（LLM）通常會帶來更多好處。為什麼呢？</p>
<ul>
<li><strong>效能：</strong> 某些模型在特定任務上表現更佳（例如：程式設計、推理、創意寫作）。</li>
<li><strong>成本：</strong> 不同模型的價格各不相同。</li>
<li><strong>功能：</strong> 各模型提供多樣的功能、上下文視窗大小，以及微調選項。</li>
<li><strong>可用性／備援：</strong> 擁有多個選擇可確保你的應用程式即使某個服務供應商出現問題時仍可運作。</li>
</ul>
<p>ADK 透過與 <a href="https://github.com/BerriAI/litellm"><strong>LiteLLM</strong></a> 函式庫的整合，讓模型切換變得無縫。LiteLLM 作為統一介面，支援超過 100 種不同的大型語言模型（LLM）。</p>
<p><strong>在本步驟中，我們將會：</strong></p>
<ol>
<li>學習如何設定 ADK <code>Agent</code>，利用 <code>LiteLlm</code> 包裝器來使用 OpenAI（GPT）、Anthropic（Claude）等供應商的模型。</li>
<li>定義並分別設定（包含各自的 session 與 runner）多個 Weather Agent 實例，並立即測試，每個實例都由不同的 LLM 支援。</li>
<li>與這些不同的 agent 互動，觀察即使使用相同工具，其回應可能出現的差異。</li>
</ol>
<hr />
<p><strong>1. 匯入 <code>LiteLlm</code></strong></p>
<p>我們在初始設定（步驟 0）時已經匯入過這個元件，但它是支援多模型功能的關鍵組件：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># @title 1. Import LiteLlm</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.models.lite_llm</span><span class="w"> </span><span class="kn">import</span> <span class="n">LiteLlm</span>
</span></code></pre></div>
<p><strong>2. 定義並測試多模型 agent</strong></p>
<p>與其只傳遞模型名稱字串（預設為 Google 的 Gemini 模型），我們會將想要的模型識別字串包裝在 <code>LiteLlm</code> 類別中。</p>
<ul>
<li><strong>重點概念：<code>LiteLlm</code> 包裝器：</strong> <code>LiteLlm(model="provider/model_name")</code> 語法會告訴 Agent Development Kit (ADK) 透過 LiteLLM 函式庫，將此 agent 的請求路由到指定的模型提供者。</li>
</ul>
<p>請確保你已在步驟 0 設定好 OpenAI 和 Anthropic 所需的 API 金鑰。我們將使用 <code>call_agent_async</code> 函式（前面已定義，現在可接受 <code>runner</code>、<code>user_id</code> 和 <code>session_id</code>）來在每個 agent 設定完成後立即與其互動。</p>
<p>以下每個區塊都會：</p>
<ul>
<li>使用特定的 LiteLLM 模型（<code>MODEL_GPT_4O</code> 或 <code>MODEL_CLAUDE_SONNET</code>）定義 agent。</li>
<li>為該 agent 的測試執行個別建立<em>全新且獨立</em>的 <code>InMemorySessionService</code> 和 session。這樣可讓對話歷史在本示範中彼此隔離。</li>
<li>建立一個針對該 agent 及其 session 服務所設定的 <code>Runner</code>。</li>
<li>立即呼叫 <code>call_agent_async</code>，傳送查詢並測試該 agent。</li>
</ul>
<p><strong>最佳實踐：</strong> 建議將模型名稱（如步驟 0 定義的 <code>MODEL_GPT_4O</code>、<code>MODEL_CLAUDE_SONNET</code>）設為常數，以避免拼寫錯誤並方便程式碼管理。</p>
<p><strong>錯誤處理：</strong> 我們會將 agent 定義包在 <code>try...except</code> 區塊中。這樣即使某個模型提供者的 API 金鑰遺失或無效，也不會導致整個程式碼區塊失敗，讓教學能繼續執行已正確設定的模型。</p>
<p>首先，讓我們使用 OpenAI 的 GPT-4o 來建立並測試 agent。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1"># @title Define and Test GPT Agent</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="c1"># Make sure &#39;get_weather&#39; function from Step 1 is defined in your environment.</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="c1"># Make sure &#39;call_agent_async&#39; is defined from earlier.</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="c1"># --- Agent using GPT-4o ---</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="n">weather_agent_gpt</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Initialize to None</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="n">runner_gpt</span> <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># Initialize runner to None</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>    <span class="n">weather_agent_gpt</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_agent_gpt&quot;</span><span class="p">,</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>        <span class="c1"># Key change: Wrap the LiteLLM model identifier</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>        <span class="n">model</span><span class="o">=</span><span class="n">LiteLlm</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">MODEL_GPT_4O</span><span class="p">),</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Provides weather information (using GPT-4o).&quot;</span><span class="p">,</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are a helpful weather assistant powered by GPT-4o. &quot;</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>                    <span class="s2">&quot;Use the &#39;get_weather&#39; tool for city weather requests. &quot;</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>                    <span class="s2">&quot;Clearly present successful reports or polite error messages based on the tool&#39;s output status.&quot;</span><span class="p">,</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">get_weather</span><span class="p">],</span> <span class="c1"># Re-use the same tool</span>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>    <span class="p">)</span>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent &#39;</span><span class="si">{</span><span class="n">weather_agent_gpt</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; created using model &#39;</span><span class="si">{</span><span class="n">MODEL_GPT_4O</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>    <span class="c1"># InMemorySessionService is simple, non-persistent storage for this tutorial.</span>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>    <span class="n">session_service_gpt</span> <span class="o">=</span> <span class="n">InMemorySessionService</span><span class="p">()</span> <span class="c1"># Create a dedicated service</span>
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a>    <span class="c1"># Define constants for identifying the interaction context</span>
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a>    <span class="n">APP_NAME_GPT</span> <span class="o">=</span> <span class="s2">&quot;weather_tutorial_app_gpt&quot;</span> <span class="c1"># Unique app name for this test</span>
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a>    <span class="n">USER_ID_GPT</span> <span class="o">=</span> <span class="s2">&quot;user_1_gpt&quot;</span>
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a>    <span class="n">SESSION_ID_GPT</span> <span class="o">=</span> <span class="s2">&quot;session_001_gpt&quot;</span> <span class="c1"># Using a fixed ID for simplicity</span>
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a>
</span><span id="__span-10-31"><a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a>    <span class="c1"># Create the specific session where the conversation will happen</span>
</span><span id="__span-10-32"><a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a>    <span class="n">session_gpt</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service_gpt</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span>
</span><span id="__span-10-33"><a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a>        <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME_GPT</span><span class="p">,</span>
</span><span id="__span-10-34"><a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a>        <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_GPT</span><span class="p">,</span>
</span><span id="__span-10-35"><a id="__codelineno-10-35" name="__codelineno-10-35" href="#__codelineno-10-35"></a>        <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_GPT</span>
</span><span id="__span-10-36"><a id="__codelineno-10-36" name="__codelineno-10-36" href="#__codelineno-10-36"></a>    <span class="p">)</span>
</span><span id="__span-10-37"><a id="__codelineno-10-37" name="__codelineno-10-37" href="#__codelineno-10-37"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session created: App=&#39;</span><span class="si">{</span><span class="n">APP_NAME_GPT</span><span class="si">}</span><span class="s2">&#39;, User=&#39;</span><span class="si">{</span><span class="n">USER_ID_GPT</span><span class="si">}</span><span class="s2">&#39;, Session=&#39;</span><span class="si">{</span><span class="n">SESSION_ID_GPT</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="__span-10-38"><a id="__codelineno-10-38" name="__codelineno-10-38" href="#__codelineno-10-38"></a>
</span><span id="__span-10-39"><a id="__codelineno-10-39" name="__codelineno-10-39" href="#__codelineno-10-39"></a>    <span class="c1"># Create a runner specific to this agent and its session service</span>
</span><span id="__span-10-40"><a id="__codelineno-10-40" name="__codelineno-10-40" href="#__codelineno-10-40"></a>    <span class="n">runner_gpt</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
</span><span id="__span-10-41"><a id="__codelineno-10-41" name="__codelineno-10-41" href="#__codelineno-10-41"></a>        <span class="n">agent</span><span class="o">=</span><span class="n">weather_agent_gpt</span><span class="p">,</span>
</span><span id="__span-10-42"><a id="__codelineno-10-42" name="__codelineno-10-42" href="#__codelineno-10-42"></a>        <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME_GPT</span><span class="p">,</span>       <span class="c1"># Use the specific app name</span>
</span><span id="__span-10-43"><a id="__codelineno-10-43" name="__codelineno-10-43" href="#__codelineno-10-43"></a>        <span class="n">session_service</span><span class="o">=</span><span class="n">session_service_gpt</span> <span class="c1"># Use the specific session service</span>
</span><span id="__span-10-44"><a id="__codelineno-10-44" name="__codelineno-10-44" href="#__codelineno-10-44"></a>        <span class="p">)</span>
</span><span id="__span-10-45"><a id="__codelineno-10-45" name="__codelineno-10-45" href="#__codelineno-10-45"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runner created for agent &#39;</span><span class="si">{</span><span class="n">runner_gpt</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="__span-10-46"><a id="__codelineno-10-46" name="__codelineno-10-46" href="#__codelineno-10-46"></a>
</span><span id="__span-10-47"><a id="__codelineno-10-47" name="__codelineno-10-47" href="#__codelineno-10-47"></a>    <span class="c1"># --- Test the GPT Agent ---</span>
</span><span id="__span-10-48"><a id="__codelineno-10-48" name="__codelineno-10-48" href="#__codelineno-10-48"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Testing GPT Agent ---&quot;</span><span class="p">)</span>
</span><span id="__span-10-49"><a id="__codelineno-10-49" name="__codelineno-10-49" href="#__codelineno-10-49"></a>    <span class="c1"># Ensure call_agent_async uses the correct runner, user_id, session_id</span>
</span><span id="__span-10-50"><a id="__codelineno-10-50" name="__codelineno-10-50" href="#__codelineno-10-50"></a>    <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;What&#39;s the weather in Tokyo?&quot;</span><span class="p">,</span>
</span><span id="__span-10-51"><a id="__codelineno-10-51" name="__codelineno-10-51" href="#__codelineno-10-51"></a>                           <span class="n">runner</span><span class="o">=</span><span class="n">runner_gpt</span><span class="p">,</span>
</span><span id="__span-10-52"><a id="__codelineno-10-52" name="__codelineno-10-52" href="#__codelineno-10-52"></a>                           <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_GPT</span><span class="p">,</span>
</span><span id="__span-10-53"><a id="__codelineno-10-53" name="__codelineno-10-53" href="#__codelineno-10-53"></a>                           <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_GPT</span><span class="p">)</span>
</span><span id="__span-10-54"><a id="__codelineno-10-54" name="__codelineno-10-54" href="#__codelineno-10-54"></a>    <span class="c1"># --- OR ---</span>
</span><span id="__span-10-55"><a id="__codelineno-10-55" name="__codelineno-10-55" href="#__codelineno-10-55"></a>
</span><span id="__span-10-56"><a id="__codelineno-10-56" name="__codelineno-10-56" href="#__codelineno-10-56"></a>    <span class="c1"># Uncomment the following lines if running as a standard Python script (.py file):</span>
</span><span id="__span-10-57"><a id="__codelineno-10-57" name="__codelineno-10-57" href="#__codelineno-10-57"></a>    <span class="c1"># import asyncio</span>
</span><span id="__span-10-58"><a id="__codelineno-10-58" name="__codelineno-10-58" href="#__codelineno-10-58"></a>    <span class="c1"># if __name__ == &quot;__main__&quot;:</span>
</span><span id="__span-10-59"><a id="__codelineno-10-59" name="__codelineno-10-59" href="#__codelineno-10-59"></a>    <span class="c1">#     try:</span>
</span><span id="__span-10-60"><a id="__codelineno-10-60" name="__codelineno-10-60" href="#__codelineno-10-60"></a>    <span class="c1">#         asyncio.run(call_agent_async(query = &quot;What&#39;s the weather in Tokyo?&quot;,</span>
</span><span id="__span-10-61"><a id="__codelineno-10-61" name="__codelineno-10-61" href="#__codelineno-10-61"></a>    <span class="c1">#                      runner=runner_gpt,</span>
</span><span id="__span-10-62"><a id="__codelineno-10-62" name="__codelineno-10-62" href="#__codelineno-10-62"></a>    <span class="c1">#                       user_id=USER_ID_GPT,</span>
</span><span id="__span-10-63"><a id="__codelineno-10-63" name="__codelineno-10-63" href="#__codelineno-10-63"></a>    <span class="c1">#                       session_id=SESSION_ID_GPT)</span>
</span><span id="__span-10-64"><a id="__codelineno-10-64" name="__codelineno-10-64" href="#__codelineno-10-64"></a>    <span class="c1">#     except Exception as e:</span>
</span><span id="__span-10-65"><a id="__codelineno-10-65" name="__codelineno-10-65" href="#__codelineno-10-65"></a>    <span class="c1">#         print(f&quot;An error occurred: {e}&quot;)</span>
</span><span id="__span-10-66"><a id="__codelineno-10-66" name="__codelineno-10-66" href="#__codelineno-10-66"></a>
</span><span id="__span-10-67"><a id="__codelineno-10-67" name="__codelineno-10-67" href="#__codelineno-10-67"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-10-68"><a id="__codelineno-10-68" name="__codelineno-10-68" href="#__codelineno-10-68"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Could not create or run GPT agent &#39;</span><span class="si">{</span><span class="n">MODEL_GPT_4O</span><span class="si">}</span><span class="s2">&#39;. Check API Key and model name. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>接下來，我們也會針對 Anthropic 的 Claude Sonnet 執行相同的操作。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1"># @title Define and Test Claude Agent</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="c1"># Make sure &#39;get_weather&#39; function from Step 1 is defined in your environment.</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="c1"># Make sure &#39;call_agent_async&#39; is defined from earlier.</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="c1"># --- Agent using Claude Sonnet ---</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="n">weather_agent_claude</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Initialize to None</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="n">runner_claude</span> <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># Initialize runner to None</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>    <span class="n">weather_agent_claude</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_agent_claude&quot;</span><span class="p">,</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>        <span class="c1"># Key change: Wrap the LiteLLM model identifier</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>        <span class="n">model</span><span class="o">=</span><span class="n">LiteLlm</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">MODEL_CLAUDE_SONNET</span><span class="p">),</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Provides weather information (using Claude Sonnet).&quot;</span><span class="p">,</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are a helpful weather assistant powered by Claude Sonnet. &quot;</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>                    <span class="s2">&quot;Use the &#39;get_weather&#39; tool for city weather requests. &quot;</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>                    <span class="s2">&quot;Analyze the tool&#39;s dictionary output (&#39;status&#39;, &#39;report&#39;/&#39;error_message&#39;). &quot;</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>                    <span class="s2">&quot;Clearly present successful reports or polite error messages.&quot;</span><span class="p">,</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">get_weather</span><span class="p">],</span> <span class="c1"># Re-use the same tool</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>    <span class="p">)</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent &#39;</span><span class="si">{</span><span class="n">weather_agent_claude</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; created using model &#39;</span><span class="si">{</span><span class="n">MODEL_CLAUDE_SONNET</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>    <span class="c1"># InMemorySessionService is simple, non-persistent storage for this tutorial.</span>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>    <span class="n">session_service_claude</span> <span class="o">=</span> <span class="n">InMemorySessionService</span><span class="p">()</span> <span class="c1"># Create a dedicated service</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>    <span class="c1"># Define constants for identifying the interaction context</span>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>    <span class="n">APP_NAME_CLAUDE</span> <span class="o">=</span> <span class="s2">&quot;weather_tutorial_app_claude&quot;</span> <span class="c1"># Unique app name</span>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a>    <span class="n">USER_ID_CLAUDE</span> <span class="o">=</span> <span class="s2">&quot;user_1_claude&quot;</span>
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a>    <span class="n">SESSION_ID_CLAUDE</span> <span class="o">=</span> <span class="s2">&quot;session_001_claude&quot;</span> <span class="c1"># Using a fixed ID for simplicity</span>
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a>
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a>    <span class="c1"># Create the specific session where the conversation will happen</span>
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a>    <span class="n">session_claude</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service_claude</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span>
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a>        <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME_CLAUDE</span><span class="p">,</span>
</span><span id="__span-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a>        <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_CLAUDE</span><span class="p">,</span>
</span><span id="__span-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a>        <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_CLAUDE</span>
</span><span id="__span-11-37"><a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a>    <span class="p">)</span>
</span><span id="__span-11-38"><a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session created: App=&#39;</span><span class="si">{</span><span class="n">APP_NAME_CLAUDE</span><span class="si">}</span><span class="s2">&#39;, User=&#39;</span><span class="si">{</span><span class="n">USER_ID_CLAUDE</span><span class="si">}</span><span class="s2">&#39;, Session=&#39;</span><span class="si">{</span><span class="n">SESSION_ID_CLAUDE</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="__span-11-39"><a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a>
</span><span id="__span-11-40"><a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a>    <span class="c1"># Create a runner specific to this agent and its session service</span>
</span><span id="__span-11-41"><a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a>    <span class="n">runner_claude</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
</span><span id="__span-11-42"><a id="__codelineno-11-42" name="__codelineno-11-42" href="#__codelineno-11-42"></a>        <span class="n">agent</span><span class="o">=</span><span class="n">weather_agent_claude</span><span class="p">,</span>
</span><span id="__span-11-43"><a id="__codelineno-11-43" name="__codelineno-11-43" href="#__codelineno-11-43"></a>        <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME_CLAUDE</span><span class="p">,</span>       <span class="c1"># Use the specific app name</span>
</span><span id="__span-11-44"><a id="__codelineno-11-44" name="__codelineno-11-44" href="#__codelineno-11-44"></a>        <span class="n">session_service</span><span class="o">=</span><span class="n">session_service_claude</span> <span class="c1"># Use the specific session service</span>
</span><span id="__span-11-45"><a id="__codelineno-11-45" name="__codelineno-11-45" href="#__codelineno-11-45"></a>        <span class="p">)</span>
</span><span id="__span-11-46"><a id="__codelineno-11-46" name="__codelineno-11-46" href="#__codelineno-11-46"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runner created for agent &#39;</span><span class="si">{</span><span class="n">runner_claude</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="__span-11-47"><a id="__codelineno-11-47" name="__codelineno-11-47" href="#__codelineno-11-47"></a>
</span><span id="__span-11-48"><a id="__codelineno-11-48" name="__codelineno-11-48" href="#__codelineno-11-48"></a>    <span class="c1"># --- Test the Claude Agent ---</span>
</span><span id="__span-11-49"><a id="__codelineno-11-49" name="__codelineno-11-49" href="#__codelineno-11-49"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Testing Claude Agent ---&quot;</span><span class="p">)</span>
</span><span id="__span-11-50"><a id="__codelineno-11-50" name="__codelineno-11-50" href="#__codelineno-11-50"></a>    <span class="c1"># Ensure call_agent_async uses the correct runner, user_id, session_id</span>
</span><span id="__span-11-51"><a id="__codelineno-11-51" name="__codelineno-11-51" href="#__codelineno-11-51"></a>    <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;Weather in London please.&quot;</span><span class="p">,</span>
</span><span id="__span-11-52"><a id="__codelineno-11-52" name="__codelineno-11-52" href="#__codelineno-11-52"></a>                           <span class="n">runner</span><span class="o">=</span><span class="n">runner_claude</span><span class="p">,</span>
</span><span id="__span-11-53"><a id="__codelineno-11-53" name="__codelineno-11-53" href="#__codelineno-11-53"></a>                           <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_CLAUDE</span><span class="p">,</span>
</span><span id="__span-11-54"><a id="__codelineno-11-54" name="__codelineno-11-54" href="#__codelineno-11-54"></a>                           <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_CLAUDE</span><span class="p">)</span>
</span><span id="__span-11-55"><a id="__codelineno-11-55" name="__codelineno-11-55" href="#__codelineno-11-55"></a>
</span><span id="__span-11-56"><a id="__codelineno-11-56" name="__codelineno-11-56" href="#__codelineno-11-56"></a>    <span class="c1"># --- OR ---</span>
</span><span id="__span-11-57"><a id="__codelineno-11-57" name="__codelineno-11-57" href="#__codelineno-11-57"></a>
</span><span id="__span-11-58"><a id="__codelineno-11-58" name="__codelineno-11-58" href="#__codelineno-11-58"></a>    <span class="c1"># Uncomment the following lines if running as a standard Python script (.py file):</span>
</span><span id="__span-11-59"><a id="__codelineno-11-59" name="__codelineno-11-59" href="#__codelineno-11-59"></a>    <span class="c1"># import asyncio</span>
</span><span id="__span-11-60"><a id="__codelineno-11-60" name="__codelineno-11-60" href="#__codelineno-11-60"></a>    <span class="c1"># if __name__ == &quot;__main__&quot;:</span>
</span><span id="__span-11-61"><a id="__codelineno-11-61" name="__codelineno-11-61" href="#__codelineno-11-61"></a>    <span class="c1">#     try:</span>
</span><span id="__span-11-62"><a id="__codelineno-11-62" name="__codelineno-11-62" href="#__codelineno-11-62"></a>    <span class="c1">#         asyncio.run(call_agent_async(query = &quot;Weather in London please.&quot;,</span>
</span><span id="__span-11-63"><a id="__codelineno-11-63" name="__codelineno-11-63" href="#__codelineno-11-63"></a>    <span class="c1">#                      runner=runner_claude,</span>
</span><span id="__span-11-64"><a id="__codelineno-11-64" name="__codelineno-11-64" href="#__codelineno-11-64"></a>    <span class="c1">#                       user_id=USER_ID_CLAUDE,</span>
</span><span id="__span-11-65"><a id="__codelineno-11-65" name="__codelineno-11-65" href="#__codelineno-11-65"></a>    <span class="c1">#                       session_id=SESSION_ID_CLAUDE)</span>
</span><span id="__span-11-66"><a id="__codelineno-11-66" name="__codelineno-11-66" href="#__codelineno-11-66"></a>    <span class="c1">#     except Exception as e:</span>
</span><span id="__span-11-67"><a id="__codelineno-11-67" name="__codelineno-11-67" href="#__codelineno-11-67"></a>    <span class="c1">#         print(f&quot;An error occurred: {e}&quot;)</span>
</span><span id="__span-11-68"><a id="__codelineno-11-68" name="__codelineno-11-68" href="#__codelineno-11-68"></a>
</span><span id="__span-11-69"><a id="__codelineno-11-69" name="__codelineno-11-69" href="#__codelineno-11-69"></a>
</span><span id="__span-11-70"><a id="__codelineno-11-70" name="__codelineno-11-70" href="#__codelineno-11-70"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-11-71"><a id="__codelineno-11-71" name="__codelineno-11-71" href="#__codelineno-11-71"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Could not create or run Claude agent &#39;</span><span class="si">{</span><span class="n">MODEL_CLAUDE_SONNET</span><span class="si">}</span><span class="s2">&#39;. Check API Key and model name. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>請仔細觀察這兩個程式碼區塊的輸出結果。你應該會看到：</p>
<ol>
<li>每個 agent（<code>weather_agent_gpt</code>、<code>weather_agent_claude</code>）都成功建立（若 API 金鑰有效）。</li>
<li>每個 agent 都分別設置了專屬的 session 和 Runner。</li>
<li>每個 agent 在處理查詢時，都能正確判斷需要使用 <code>get_weather</code> 工具（你會看到 <code>--- Tool: get_weather called... ---</code> 的日誌）。</li>
<li><em>底層工具邏輯</em> 完全相同，始終回傳我們的模擬資料。</li>
<li>但每個 agent 最終產生的<strong>文字回應</strong>在措辭、語氣或格式上可能略有不同。這是因為指令提示詞是由不同的大型語言模型 (LLM)（GPT-4o 與 Claude Sonnet）來解讀與執行。</li>
</ol>
<p>這個步驟展示了 Agent Development Kit (ADK) 與 LiteLLM 所帶來的強大彈性。你可以輕鬆地用不同的大型語言模型 (LLM) 實驗及部署 agent，同時讓你的核心應用邏輯（工具、基本 agent 結構）保持一致。</p>
<p>在下一步，我們將從單一 agent 擴展，打造一個小型團隊，讓 agent 之間能夠彼此委派任務！</p>
<hr />
<h2 id="3-agent-team">步驟 3：打造 Agent Team —— 問候與道別的委派<a class="headerlink" href="#3-agent-team" title="Permanent link">&para;</a></h2>
<p>在步驟 1 和 2 中，我們建立並測試了一個專注於天氣查詢的單一 agent。雖然這對於特定任務很有效，但實際應用中常常需要處理更多元的使用者互動。我們<em>可以</em>不斷為單一天氣 agent 增加更多工具和複雜指令，但這很快就會變得難以維護且效率低落。</p>
<p>更健全的做法是建立一個<strong>Agent Team</strong>。這包含：</p>
<ol>
<li>建立多個<strong>專業化 agent</strong>，每個 agent 針對特定能力設計（例如：一個負責天氣、一個負責問候、一個負責計算）。</li>
<li>指定一個<strong>root agent</strong>（或協調者），負責接收使用者的初始請求。</li>
<li>讓 root agent 能根據使用者意圖，<strong>自動委派</strong>請求給最合適的專業 sub-agent。</li>
</ol>
<p><strong>為什麼要建立 Agent Team？</strong></p>
<ul>
<li><strong>模組化：</strong> 更容易開發、測試與維護各個 agent。</li>
<li><strong>專業化：</strong> 每個 agent 可針對其任務（指令、模型選擇）進行最佳化。</li>
<li><strong>可擴展性：</strong> 新增功能時，只需加入新的 agent 即可。</li>
<li><strong>效率：</strong> 對於簡單任務（如問候），可選用更簡單／成本更低的模型。</li>
</ul>
<p><strong>在本步驟中，我們將會：</strong></p>
<ol>
<li>定義處理問候（<code>say_hello</code>）與道別（<code>say_goodbye</code>）的簡單工具。</li>
<li>建立兩個新的專業 sub-agent：<code>greeting_agent</code> 和 <code>farewell_agent</code>。</li>
<li>將我們的主要天氣 agent（<code>weather_agent_v2</code>）升級為<strong>root agent</strong>。</li>
<li>為 root agent 配置 sub-agent，啟用<strong>自動委派</strong>功能。</li>
<li>透過向 root agent 發送不同類型的請求，測試委派流程。</li>
</ol>
<hr />
<p><strong>1. 為 Sub-Agent 定義工具</strong></p>
<p>首先，讓我們建立將作為新專業 agent 工具的簡單 Python 函式。請記得，清楚的 docstring 對於 agent 使用這些工具非常重要。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1"># @title Define Tools for Greeting and Farewell Agents</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span> <span class="c1"># Make sure to import Optional</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="c1"># Ensure &#39;get_weather&#39; from Step 1 is available if running this step independently.</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="c1"># def get_weather(city: str) -&gt; dict: ... (from Step 1)</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">say_hello</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Provides a simple greeting. If a name is provided, it will be used.</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="sd">    Args:</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="sd">        name (str, optional): The name of the person to greet. Defaults to a generic greeting if not provided.</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="sd">    Returns:</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="sd">        str: A friendly greeting message.</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>    <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>        <span class="n">greeting</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Hello, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">!&quot;</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: say_hello called with name: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>        <span class="n">greeting</span> <span class="o">=</span> <span class="s2">&quot;Hello there!&quot;</span> <span class="c1"># Default greeting if name is None or not explicitly passed</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: say_hello called without a specific name (name_arg_value: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">) ---&quot;</span><span class="p">)</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>    <span class="k">return</span> <span class="n">greeting</span>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a><span class="k">def</span><span class="w"> </span><span class="nf">say_goodbye</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Provides a simple farewell message to conclude the conversation.&quot;&quot;&quot;</span>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: say_goodbye called ---&quot;</span><span class="p">)</span>
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>    <span class="k">return</span> <span class="s2">&quot;Goodbye! Have a great day.&quot;</span>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Greeting and Farewell tools defined.&quot;</span><span class="p">)</span>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a><span class="c1"># Optional self-test</span>
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a><span class="nb">print</span><span class="p">(</span><span class="n">say_hello</span><span class="p">(</span><span class="s2">&quot;Alice&quot;</span><span class="p">))</span>
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a><span class="nb">print</span><span class="p">(</span><span class="n">say_hello</span><span class="p">())</span> <span class="c1"># Test with no argument (should use default &quot;Hello there!&quot;)</span>
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a><span class="nb">print</span><span class="p">(</span><span class="n">say_hello</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span> <span class="c1"># Test with name explicitly as None (should use default &quot;Hello there!&quot;)</span>
</span></code></pre></div>
<hr />
<p><strong>2. 定義子 agent（Greeting &amp; Farewell）</strong></p>
<p>現在，為我們的專家建立 <code>Agent</code> 實例。請注意他們高度聚焦的 <code>instruction</code>，以及最重要的，他們明確的 <code>description</code>。<code>description</code> 是 <em>root agent</em> 用來決定<em>何時</em>將任務委派給這些子 agent 的主要資訊。</p>
<p><strong>最佳實踐：</strong>子 agent 的 <code>description</code> 欄位應準確且簡明地總結其特定能力。這對於自動有效委派至關重要。</p>
<p><strong>最佳實踐：</strong>子 agent 的 <code>instruction</code> 欄位應針對其有限範疇量身打造，明確告訴他們該做什麼，以及<em>不該</em>做什麼（例如：「你的<em>唯一</em>任務是……」）。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># @title Define Greeting and Farewell Sub-Agents</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="c1"># If you want to use models other than Gemini, Ensure LiteLlm is imported and API keys are set (from Step 0/2)</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="c1"># from google.adk.models.lite_llm import LiteLlm</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="c1"># MODEL_GPT_4O, MODEL_CLAUDE_SONNET etc. should be defined</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="c1"># Or else, continue to use: model = MODEL_GEMINI_2_0_FLASH</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="c1"># --- Greeting Agent ---</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="n">greeting_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>    <span class="n">greeting_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>        <span class="c1"># Using a potentially different/cheaper model for a simple task</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>        <span class="c1"># model=LiteLlm(model=MODEL_GPT_4O), # If you would like to experiment with other models</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;greeting_agent&quot;</span><span class="p">,</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the Greeting Agent. Your ONLY task is to provide a friendly greeting to the user. &quot;</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>                    <span class="s2">&quot;Use the &#39;say_hello&#39; tool to generate the greeting. &quot;</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>                    <span class="s2">&quot;If the user provides their name, make sure to pass it to the tool. &quot;</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>                    <span class="s2">&quot;Do not engage in any other conversation or tasks.&quot;</span><span class="p">,</span>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Handles simple greetings and hellos using the &#39;say_hello&#39; tool.&quot;</span><span class="p">,</span> <span class="c1"># Crucial for delegation</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">say_hello</span><span class="p">],</span>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>    <span class="p">)</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Agent &#39;</span><span class="si">{</span><span class="n">greeting_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; created using model &#39;</span><span class="si">{</span><span class="n">greeting_agent</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Could not create Greeting agent. Check API Key (</span><span class="si">{</span><span class="n">greeting_agent</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">). Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="c1"># --- Farewell Agent ---</span>
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a><span class="n">farewell_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>    <span class="n">farewell_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>        <span class="c1"># Can use the same or a different model</span>
</span><span id="__span-13-32"><a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
</span><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a>        <span class="c1"># model=LiteLlm(model=MODEL_GPT_4O), # If you would like to experiment with other models</span>
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;farewell_agent&quot;</span><span class="p">,</span>
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the Farewell Agent. Your ONLY task is to provide a polite goodbye message. &quot;</span>
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a>                    <span class="s2">&quot;Use the &#39;say_goodbye&#39; tool when the user indicates they are leaving or ending the conversation &quot;</span>
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a>                    <span class="s2">&quot;(e.g., using words like &#39;bye&#39;, &#39;goodbye&#39;, &#39;thanks bye&#39;, &#39;see you&#39;). &quot;</span>
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38" href="#__codelineno-13-38"></a>                    <span class="s2">&quot;Do not perform any other actions.&quot;</span><span class="p">,</span>
</span><span id="__span-13-39"><a id="__codelineno-13-39" name="__codelineno-13-39" href="#__codelineno-13-39"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Handles simple farewells and goodbyes using the &#39;say_goodbye&#39; tool.&quot;</span><span class="p">,</span> <span class="c1"># Crucial for delegation</span>
</span><span id="__span-13-40"><a id="__codelineno-13-40" name="__codelineno-13-40" href="#__codelineno-13-40"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">say_goodbye</span><span class="p">],</span>
</span><span id="__span-13-41"><a id="__codelineno-13-41" name="__codelineno-13-41" href="#__codelineno-13-41"></a>    <span class="p">)</span>
</span><span id="__span-13-42"><a id="__codelineno-13-42" name="__codelineno-13-42" href="#__codelineno-13-42"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Agent &#39;</span><span class="si">{</span><span class="n">farewell_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; created using model &#39;</span><span class="si">{</span><span class="n">farewell_agent</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="__span-13-43"><a id="__codelineno-13-43" name="__codelineno-13-43" href="#__codelineno-13-43"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-13-44"><a id="__codelineno-13-44" name="__codelineno-13-44" href="#__codelineno-13-44"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Could not create Farewell agent. Check API Key (</span><span class="si">{</span><span class="n">farewell_agent</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">). Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p><strong>3. 定義 Root Agent（Weather Agent v2）及其子代理</strong></p>
<p>現在，我們要升級<code>weather_agent</code>。主要變更如下：</p>
<ul>
<li>新增<code>sub_agents</code>參數：我們傳入一個包含剛剛建立的<code>greeting_agent</code>和<code>farewell_agent</code>實例的清單。</li>
<li>更新<code>instruction</code>：我們明確告訴 root agent 關於其子代理的資訊，以及<em>何時</em>應該將任務委派給它們。</li>
</ul>
<p><strong>關鍵概念：自動委派（Auto Flow）</strong><br />
透過提供<code>sub_agents</code>清單，Agent Development Kit (ADK) 能夠啟用自動委派。當 root agent 收到使用者查詢時，其大型語言模型 (LLM) 不僅會考慮自身的指令和工具，還會參考每個子代理的<code>description</code>。如果 LLM 判斷某個查詢更符合某個子代理所描述的能力（例如：「處理簡單問候語」），它會自動產生一個特殊的內部動作，<em>將控制權轉移</em>給該子代理處理本回合。子代理會使用自己的模型、指令和工具來處理該查詢。</p>
<p><strong>最佳實踐：</strong><br />
請確保 root agent 的指令能明確引導其委派決策。請以名稱提及子代理，並描述應該在何種情況下進行委派。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># @title Define the Root Agent with Sub-Agents</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="c1"># Ensure sub-agents were created successfully before defining the root agent.</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="c1"># Also ensure the original &#39;get_weather&#39; tool is defined.</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="n">root_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="n">runner_root</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Initialize runner</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="k">if</span> <span class="n">greeting_agent</span> <span class="ow">and</span> <span class="n">farewell_agent</span> <span class="ow">and</span> <span class="s1">&#39;get_weather&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>    <span class="c1"># Let&#39;s use a capable Gemini model for the root agent to handle orchestration</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>    <span class="n">root_agent_model</span> <span class="o">=</span> <span class="n">MODEL_GEMINI_2_0_FLASH</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>    <span class="n">weather_agent_team</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_agent_v2&quot;</span><span class="p">,</span> <span class="c1"># Give it a new version name</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>        <span class="n">model</span><span class="o">=</span><span class="n">root_agent_model</span><span class="p">,</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The main coordinator agent. Handles weather requests and delegates greetings/farewells to specialists.&quot;</span><span class="p">,</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the main Weather Agent coordinating a team. Your primary responsibility is to provide weather information. &quot;</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>                    <span class="s2">&quot;Use the &#39;get_weather&#39; tool ONLY for specific weather requests (e.g., &#39;weather in London&#39;). &quot;</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>                    <span class="s2">&quot;You have specialized sub-agents: &quot;</span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>                    <span class="s2">&quot;1. &#39;greeting_agent&#39;: Handles simple greetings like &#39;Hi&#39;, &#39;Hello&#39;. Delegate to it for these. &quot;</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>                    <span class="s2">&quot;2. &#39;farewell_agent&#39;: Handles simple farewells like &#39;Bye&#39;, &#39;See you&#39;. Delegate to it for these. &quot;</span>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a>                    <span class="s2">&quot;Analyze the user&#39;s query. If it&#39;s a greeting, delegate to &#39;greeting_agent&#39;. If it&#39;s a farewell, delegate to &#39;farewell_agent&#39;. &quot;</span>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>                    <span class="s2">&quot;If it&#39;s a weather request, handle it yourself using &#39;get_weather&#39;. &quot;</span>
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a>                    <span class="s2">&quot;For anything else, respond appropriately or state you cannot handle it.&quot;</span><span class="p">,</span>
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">get_weather</span><span class="p">],</span> <span class="c1"># Root agent still needs the weather tool for its core task</span>
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a>        <span class="c1"># Key change: Link the sub-agents here!</span>
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a>        <span class="n">sub_agents</span><span class="o">=</span><span class="p">[</span><span class="n">greeting_agent</span><span class="p">,</span> <span class="n">farewell_agent</span><span class="p">]</span>
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a>    <span class="p">)</span>
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Root Agent &#39;</span><span class="si">{</span><span class="n">weather_agent_team</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; created using model &#39;</span><span class="si">{</span><span class="n">root_agent_model</span><span class="si">}</span><span class="s2">&#39; with sub-agents: </span><span class="si">{</span><span class="p">[</span><span class="n">sa</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">weather_agent_team</span><span class="o">.</span><span class="n">sub_agents</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a>
</span><span id="__span-14-30"><a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-14-31"><a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ Cannot create root agent because one or more sub-agents failed to initialize or &#39;get_weather&#39; tool is missing.&quot;</span><span class="p">)</span>
</span><span id="__span-14-32"><a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">greeting_agent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - Greeting Agent is missing.&quot;</span><span class="p">)</span>
</span><span id="__span-14-33"><a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">farewell_agent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - Farewell Agent is missing.&quot;</span><span class="p">)</span>
</span><span id="__span-14-34"><a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a>    <span class="k">if</span> <span class="s1">&#39;get_weather&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - get_weather function is missing.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p><strong>4. 與 Agent Team 互動</strong></p>
<p>現在我們已經定義好根 agent（<code>weather_agent_team</code> —— <em>注意：請確保這個變數名稱與前一個程式碼區塊中定義的名稱一致，很可能是 <code># @title Define the Root Agent with Sub-Agents</code>，也許被命名為 <code>root_agent</code></em>），並且包含了其專門的子 agent，接下來我們來測試委派（delegation）機制。</p>
<p>以下程式碼區塊將會：</p>
<ol>
<li>定義一個 <code>async</code> 函式 <code>run_team_conversation</code>。</li>
<li>在這個函式內，建立一個<em>全新且專用</em>的 <code>InMemorySessionService</code> 以及一個專屬的 session（<code>session_001_agent_team</code>），僅用於這次測試。這樣可以將對話歷史隔離，方便測試 Agent Team 的互動動態。</li>
<li>建立一個 <code>Runner</code>（<code>runner_agent_team</code>），並設定為使用我們的 <code>weather_agent_team</code>（根 agent）以及專用的 session service。</li>
<li>使用我們更新過的 <code>call_agent_async</code> 函式，向 <code>runner_agent_team</code> 發送不同類型的查詢（問候、天氣查詢、道別）。我們會明確傳入 runner、user ID 和 session ID，以便針對這次測試。</li>
<li>立即執行 <code>run_team_conversation</code> 函式。</li>
</ol>
<p>預期流程如下：</p>
<ol>
<li>「Hello there!」查詢會傳送到 <code>runner_agent_team</code>。</li>
<li>根 agent（<code>weather_agent_team</code>）收到查詢後，根據其指令以及 <code>greeting_agent</code> 的描述，將任務委派出去。</li>
<li><code>greeting_agent</code> 處理該查詢，呼叫其 <code>say_hello</code> 工具，並產生回應。</li>
<li>「What is the weather in New York?」查詢<em>不會</em>被委派，而是由根 agent 直接使用其 <code>get_weather</code> 工具處理。</li>
<li>「Thanks, bye!」查詢則會被委派給 <code>farewell_agent</code>，並由其 <code>say_goodbye</code> 工具處理。</li>
</ol>
<div class="language-python highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># @title Interact with the Agent Team</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span> <span class="c1"># Ensure asyncio is imported</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="c1"># Ensure the root agent (e.g., &#39;weather_agent_team&#39; or &#39;root_agent&#39; from the previous cell) is defined.</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="c1"># Ensure the call_agent_async function is defined.</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="c1"># Check if the root agent variable exists before defining the conversation function</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="n">root_agent_var_name</span> <span class="o">=</span> <span class="s1">&#39;root_agent&#39;</span> <span class="c1"># Default name from Step 3 guide</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="k">if</span> <span class="s1">&#39;weather_agent_team&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span> <span class="c1"># Check if user used this name instead</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>    <span class="n">root_agent_var_name</span> <span class="o">=</span> <span class="s1">&#39;weather_agent_team&#39;</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="k">elif</span> <span class="s1">&#39;root_agent&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ Root agent (&#39;root_agent&#39; or &#39;weather_agent_team&#39;) not found. Cannot define run_team_conversation.&quot;</span><span class="p">)</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>    <span class="c1"># Assign a dummy value to prevent NameError later if the code block runs anyway</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>    <span class="n">root_agent</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Or set a flag to prevent execution</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="c1"># Only define and run if the root agent exists</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="k">if</span> <span class="n">root_agent_var_name</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">root_agent_var_name</span><span class="p">]:</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>    <span class="c1"># Define the main async function for the conversation logic.</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>    <span class="c1"># The &#39;await&#39; keywords INSIDE this function are necessary for async operations.</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_team_conversation</span><span class="p">():</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Testing Agent Team Delegation ---&quot;</span><span class="p">)</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a>        <span class="n">session_service</span> <span class="o">=</span> <span class="n">InMemorySessionService</span><span class="p">()</span>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a>        <span class="n">APP_NAME</span> <span class="o">=</span> <span class="s2">&quot;weather_tutorial_agent_team&quot;</span>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a>        <span class="n">USER_ID</span> <span class="o">=</span> <span class="s2">&quot;user_1_agent_team&quot;</span>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a>        <span class="n">SESSION_ID</span> <span class="o">=</span> <span class="s2">&quot;session_001_agent_team&quot;</span>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a>        <span class="n">session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a>            <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a>        <span class="p">)</span>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session created: App=&#39;</span><span class="si">{</span><span class="n">APP_NAME</span><span class="si">}</span><span class="s2">&#39;, User=&#39;</span><span class="si">{</span><span class="n">USER_ID</span><span class="si">}</span><span class="s2">&#39;, Session=&#39;</span><span class="si">{</span><span class="n">SESSION_ID</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a>
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a>        <span class="n">actual_root_agent</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">root_agent_var_name</span><span class="p">]</span>
</span><span id="__span-15-32"><a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a>        <span class="n">runner_agent_team</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span> <span class="c1"># Or use InMemoryRunner</span>
</span><span id="__span-15-33"><a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a>            <span class="n">agent</span><span class="o">=</span><span class="n">actual_root_agent</span><span class="p">,</span>
</span><span id="__span-15-34"><a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a>            <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-15-35"><a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a>            <span class="n">session_service</span><span class="o">=</span><span class="n">session_service</span>
</span><span id="__span-15-36"><a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a>        <span class="p">)</span>
</span><span id="__span-15-37"><a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runner created for agent &#39;</span><span class="si">{</span><span class="n">actual_root_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="__span-15-38"><a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a>
</span><span id="__span-15-39"><a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a>        <span class="c1"># --- Interactions using await (correct within async def) ---</span>
</span><span id="__span-15-40"><a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a>        <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;Hello there!&quot;</span><span class="p">,</span>
</span><span id="__span-15-41"><a id="__codelineno-15-41" name="__codelineno-15-41" href="#__codelineno-15-41"></a>                               <span class="n">runner</span><span class="o">=</span><span class="n">runner_agent_team</span><span class="p">,</span>
</span><span id="__span-15-42"><a id="__codelineno-15-42" name="__codelineno-15-42" href="#__codelineno-15-42"></a>                               <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
</span><span id="__span-15-43"><a id="__codelineno-15-43" name="__codelineno-15-43" href="#__codelineno-15-43"></a>                               <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span>
</span><span id="__span-15-44"><a id="__codelineno-15-44" name="__codelineno-15-44" href="#__codelineno-15-44"></a>        <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;What is the weather in New York?&quot;</span><span class="p">,</span>
</span><span id="__span-15-45"><a id="__codelineno-15-45" name="__codelineno-15-45" href="#__codelineno-15-45"></a>                               <span class="n">runner</span><span class="o">=</span><span class="n">runner_agent_team</span><span class="p">,</span>
</span><span id="__span-15-46"><a id="__codelineno-15-46" name="__codelineno-15-46" href="#__codelineno-15-46"></a>                               <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
</span><span id="__span-15-47"><a id="__codelineno-15-47" name="__codelineno-15-47" href="#__codelineno-15-47"></a>                               <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span>
</span><span id="__span-15-48"><a id="__codelineno-15-48" name="__codelineno-15-48" href="#__codelineno-15-48"></a>        <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;Thanks, bye!&quot;</span><span class="p">,</span>
</span><span id="__span-15-49"><a id="__codelineno-15-49" name="__codelineno-15-49" href="#__codelineno-15-49"></a>                               <span class="n">runner</span><span class="o">=</span><span class="n">runner_agent_team</span><span class="p">,</span>
</span><span id="__span-15-50"><a id="__codelineno-15-50" name="__codelineno-15-50" href="#__codelineno-15-50"></a>                               <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
</span><span id="__span-15-51"><a id="__codelineno-15-51" name="__codelineno-15-51" href="#__codelineno-15-51"></a>                               <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span>
</span><span id="__span-15-52"><a id="__codelineno-15-52" name="__codelineno-15-52" href="#__codelineno-15-52"></a>
</span><span id="__span-15-53"><a id="__codelineno-15-53" name="__codelineno-15-53" href="#__codelineno-15-53"></a>    <span class="c1"># --- Execute the `run_team_conversation` async function ---</span>
</span><span id="__span-15-54"><a id="__codelineno-15-54" name="__codelineno-15-54" href="#__codelineno-15-54"></a>    <span class="c1"># Choose ONE of the methods below based on your environment.</span>
</span><span id="__span-15-55"><a id="__codelineno-15-55" name="__codelineno-15-55" href="#__codelineno-15-55"></a>    <span class="c1"># Note: This may require API keys for the models used!</span>
</span><span id="__span-15-56"><a id="__codelineno-15-56" name="__codelineno-15-56" href="#__codelineno-15-56"></a>
</span><span id="__span-15-57"><a id="__codelineno-15-57" name="__codelineno-15-57" href="#__codelineno-15-57"></a>    <span class="c1"># METHOD 1: Direct await (Default for Notebooks/Async REPLs)</span>
</span><span id="__span-15-58"><a id="__codelineno-15-58" name="__codelineno-15-58" href="#__codelineno-15-58"></a>    <span class="c1"># If your environment supports top-level await (like Colab/Jupyter notebooks),</span>
</span><span id="__span-15-59"><a id="__codelineno-15-59" name="__codelineno-15-59" href="#__codelineno-15-59"></a>    <span class="c1"># it means an event loop is already running, so you can directly await the function.</span>
</span><span id="__span-15-60"><a id="__codelineno-15-60" name="__codelineno-15-60" href="#__codelineno-15-60"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attempting execution using &#39;await&#39; (default for notebooks)...&quot;</span><span class="p">)</span>
</span><span id="__span-15-61"><a id="__codelineno-15-61" name="__codelineno-15-61" href="#__codelineno-15-61"></a>    <span class="k">await</span> <span class="n">run_team_conversation</span><span class="p">()</span>
</span><span id="__span-15-62"><a id="__codelineno-15-62" name="__codelineno-15-62" href="#__codelineno-15-62"></a>
</span><span id="__span-15-63"><a id="__codelineno-15-63" name="__codelineno-15-63" href="#__codelineno-15-63"></a>    <span class="c1"># METHOD 2: asyncio.run (For Standard Python Scripts [.py])</span>
</span><span id="__span-15-64"><a id="__codelineno-15-64" name="__codelineno-15-64" href="#__codelineno-15-64"></a>    <span class="c1"># If running this code as a standard Python script from your terminal,</span>
</span><span id="__span-15-65"><a id="__codelineno-15-65" name="__codelineno-15-65" href="#__codelineno-15-65"></a>    <span class="c1"># the script context is synchronous. `asyncio.run()` is needed to</span>
</span><span id="__span-15-66"><a id="__codelineno-15-66" name="__codelineno-15-66" href="#__codelineno-15-66"></a>    <span class="c1"># create and manage an event loop to execute your async function.</span>
</span><span id="__span-15-67"><a id="__codelineno-15-67" name="__codelineno-15-67" href="#__codelineno-15-67"></a>    <span class="c1"># To use this method:</span>
</span><span id="__span-15-68"><a id="__codelineno-15-68" name="__codelineno-15-68" href="#__codelineno-15-68"></a>    <span class="c1"># 1. Comment out the `await run_team_conversation()` line above.</span>
</span><span id="__span-15-69"><a id="__codelineno-15-69" name="__codelineno-15-69" href="#__codelineno-15-69"></a>    <span class="c1"># 2. Uncomment the following block:</span>
</span><span id="__span-15-70"><a id="__codelineno-15-70" name="__codelineno-15-70" href="#__codelineno-15-70"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-15-71"><a id="__codelineno-15-71" name="__codelineno-15-71" href="#__codelineno-15-71"></a><span class="sd">    import asyncio</span>
</span><span id="__span-15-72"><a id="__codelineno-15-72" name="__codelineno-15-72" href="#__codelineno-15-72"></a><span class="sd">    if __name__ == &quot;__main__&quot;: # Ensures this runs only when script is executed directly</span>
</span><span id="__span-15-73"><a id="__codelineno-15-73" name="__codelineno-15-73" href="#__codelineno-15-73"></a><span class="sd">        print(&quot;Executing using &#39;asyncio.run()&#39; (for standard Python scripts)...&quot;)</span>
</span><span id="__span-15-74"><a id="__codelineno-15-74" name="__codelineno-15-74" href="#__codelineno-15-74"></a><span class="sd">        try:</span>
</span><span id="__span-15-75"><a id="__codelineno-15-75" name="__codelineno-15-75" href="#__codelineno-15-75"></a><span class="sd">            # This creates an event loop, runs your async function, and closes the loop.</span>
</span><span id="__span-15-76"><a id="__codelineno-15-76" name="__codelineno-15-76" href="#__codelineno-15-76"></a><span class="sd">            asyncio.run(run_team_conversation())</span>
</span><span id="__span-15-77"><a id="__codelineno-15-77" name="__codelineno-15-77" href="#__codelineno-15-77"></a><span class="sd">        except Exception as e:</span>
</span><span id="__span-15-78"><a id="__codelineno-15-78" name="__codelineno-15-78" href="#__codelineno-15-78"></a><span class="sd">            print(f&quot;An error occurred: {e}&quot;)</span>
</span><span id="__span-15-79"><a id="__codelineno-15-79" name="__codelineno-15-79" href="#__codelineno-15-79"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-15-80"><a id="__codelineno-15-80" name="__codelineno-15-80" href="#__codelineno-15-80"></a>
</span><span id="__span-15-81"><a id="__codelineno-15-81" name="__codelineno-15-81" href="#__codelineno-15-81"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-15-82"><a id="__codelineno-15-82" name="__codelineno-15-82" href="#__codelineno-15-82"></a>    <span class="c1"># This message prints if the root agent variable wasn&#39;t found earlier</span>
</span><span id="__span-15-83"><a id="__codelineno-15-83" name="__codelineno-15-83" href="#__codelineno-15-83"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⚠️ Skipping agent team conversation execution as the root agent was not successfully defined in a previous step.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p>請仔細觀察輸出日誌，特別是 <code>--- Tool: ... called ---</code> 訊息。你應該會看到：</p>
<ul>
<li>對於 "Hello there!"，呼叫了 <code>say_hello</code> 工具（表示由 <code>greeting_agent</code> 處理）。</li>
<li>對於 "What is the weather in New York?"，呼叫了 <code>get_weather</code> 工具（表示由 root agent 處理）。</li>
<li>對於 "Thanks, bye!"，呼叫了 <code>say_goodbye</code> 工具（表示由 <code>farewell_agent</code> 處理）。</li>
</ul>
<p>這證實了<strong>自動委派（automatic delegation）</strong>已成功運作！root agent 在其指令與其 <code>sub_agents</code> 的 <code>description</code> 指引下，能正確地將使用者請求路由給團隊中合適的專家 agent。</p>
<p>你現在已經將應用程式架構成多個協作的 agent。這種模組化設計是打造更複雜且更強大 agent 系統的基礎。在下一步中，我們將讓 agent 具備在多輪對話間記憶資訊的能力，透過 session state 實現。</p>
<h2 id="4-session-state">步驟 4：使用 Session State 增加記憶與個人化<a class="headerlink" href="#4-session-state" title="Permanent link">&para;</a></h2>
<p>到目前為止，我們的 agent 團隊可以透過委派處理不同任務，但每次互動都會從頭開始——agent 在同一個 session 內無法記住過去的對話或使用者偏好。若要創造更精緻且具情境感知的體驗，agent 需要<strong>記憶</strong>。Agent Development Kit (ADK) 透過<strong>session state</strong>來實現這一點。</p>
<p><strong>什麼是 Session State？</strong></p>
<ul>
<li>它是一個與特定使用者 session 綁定的 Python 字典（<code>session.state</code>）（由 <code>APP_NAME</code>、<code>USER_ID</code>、<code>SESSION_ID</code> 識別）。</li>
<li>它能在同一 session 內<em>跨多輪對話</em>持續保存資訊。</li>
<li>agent 與工具（tools）都可以讀取與寫入這個 state，讓他們能記住細節、調整行為並個人化回應。</li>
</ul>
<p><strong>agent 如何與 state 互動：</strong></p>
<ol>
<li><strong><code>ToolContext</code>（主要方法）：</strong> 工具可以接受一個 <code>ToolContext</code> 物件（如果宣告為最後一個參數，ADK 會自動提供）。這個物件能透過 <code>tool_context.state</code> 直接存取 session state，讓工具在執行<em>過程中</em>讀取偏好或儲存結果。</li>
<li><strong><code>output_key</code>（自動儲存 agent 回應）：</strong> <code>Agent</code> 可以設定 <code>output_key="your_key"</code>。此時 ADK 會自動將該回合 agent 的最終文字回應儲存到 <code>session.state["your_key"]</code>。</li>
</ol>
<p><strong>在這個步驟中，我們將透過以下方式強化 Weather Bot 團隊：</strong></p>
<ol>
<li>使用<strong>新的</strong> <code>InMemorySessionService</code>，單獨展示 state 的運作。</li>
<li>以使用者的 <code>temperature_unit</code> 偏好初始化 session state。</li>
<li>建立一個具備 state 感知能力的 weather 工具（<code>get_weather_stateful</code>），可透過 <code>ToolContext</code> 讀取這個偏好，並調整其輸出格式（攝氏／華氏）。</li>
<li>更新 root agent，改用這個有 state 功能的工具，並設定 <code>output_key</code>，讓最終天氣報告自動儲存到 session state。</li>
<li>執行一段對話，觀察初始 state 如何影響工具、手動變更 state 如何改變後續行為，以及 <code>output_key</code> 如何持久化 agent 的回應。</li>
</ol>
<hr />
<p><strong>1. 初始化新的 Session Service 與 State</strong></p>
<p>為了清楚展示 state 管理且不受前面步驟影響，我們將實例化一個新的 <code>InMemorySessionService</code>。同時，建立一個 session，並以使用者偏好的溫度單位初始化 state。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1"># @title 1. Initialize New Session Service and State</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="c1"># Import necessary session components</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.sessions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemorySessionService</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="c1"># Create a NEW session service instance for this state demonstration</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="n">session_service_stateful</span> <span class="o">=</span> <span class="n">InMemorySessionService</span><span class="p">()</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ New InMemorySessionService created for state demonstration.&quot;</span><span class="p">)</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="c1"># Define a NEW session ID for this part of the tutorial</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="n">SESSION_ID_STATEFUL</span> <span class="o">=</span> <span class="s2">&quot;session_state_demo_001&quot;</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="n">USER_ID_STATEFUL</span> <span class="o">=</span> <span class="s2">&quot;user_state_demo&quot;</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="c1"># Define initial state data - user prefers Celsius initially</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>    <span class="s2">&quot;user_preference_temperature_unit&quot;</span><span class="p">:</span> <span class="s2">&quot;Celsius&quot;</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="p">}</span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="c1"># Create the session, providing the initial state</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="n">session_stateful</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service_stateful</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>    <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span> <span class="c1"># Use the consistent app name</span>
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>    <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a>    <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a>    <span class="n">state</span><span class="o">=</span><span class="n">initial_state</span> <span class="c1"># &lt;&lt;&lt; Initialize state during creation</span>
</span><span id="__span-16-25"><a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a><span class="p">)</span>
</span><span id="__span-16-26"><a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Session &#39;</span><span class="si">{</span><span class="n">SESSION_ID_STATEFUL</span><span class="si">}</span><span class="s2">&#39; created for user &#39;</span><span class="si">{</span><span class="n">USER_ID_STATEFUL</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="__span-16-27"><a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a>
</span><span id="__span-16-28"><a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a><span class="c1"># Verify the initial state was set correctly</span>
</span><span id="__span-16-29"><a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a><span class="n">retrieved_session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service_stateful</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-16-30"><a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a>                                                         <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-16-31"><a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a>                                                         <span class="n">session_id</span> <span class="o">=</span> <span class="n">SESSION_ID_STATEFUL</span><span class="p">)</span>
</span><span id="__span-16-32"><a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Initial Session State ---&quot;</span><span class="p">)</span>
</span><span id="__span-16-33"><a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a><span class="k">if</span> <span class="n">retrieved_session</span><span class="p">:</span>
</span><span id="__span-16-34"><a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">retrieved_session</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
</span><span id="__span-16-35"><a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-16-36"><a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Could not retrieve session.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p><strong>2. 建立具備狀態感知的天氣工具（<code>get_weather_stateful</code>）</strong></p>
<p>現在，我們要建立新版的天氣工具。其主要特色是接受<code>tool_context: ToolContext</code>，讓它能夠存取<code>tool_context.state</code>。它會讀取<code>user_preference_temperature_unit</code>，並依據內容格式化溫度顯示。</p>
<ul>
<li>
<p><strong>關鍵概念：<code>ToolContext</code></strong> 這個物件是讓你的工具邏輯能與 session 的 context 互動的橋樑，包括讀取與寫入狀態變數。如果你的工具函式將它定義為最後一個參數，Agent Development Kit (ADK) 會自動注入它。</p>
</li>
<li>
<p><strong>最佳實踐：</strong> 當從 state 讀取資料時，請使用<code>dictionary.get('key', default_value)</code>來處理 key 尚未存在的情況，確保你的工具不會因此當機。</p>
</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.tools.tool_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToolContext</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_weather_stateful</span><span class="p">(</span><span class="n">city</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_context</span><span class="p">:</span> <span class="n">ToolContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieves weather, converts temp unit based on session state.&quot;&quot;&quot;</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: get_weather_stateful called for </span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>    <span class="c1"># --- Read preference from state ---</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>    <span class="n">preferred_unit</span> <span class="o">=</span> <span class="n">tool_context</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_preference_temperature_unit&quot;</span><span class="p">,</span> <span class="s2">&quot;Celsius&quot;</span><span class="p">)</span> <span class="c1"># Default to Celsius</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: Reading state &#39;user_preference_temperature_unit&#39;: </span><span class="si">{</span><span class="n">preferred_unit</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>    <span class="n">city_normalized</span> <span class="o">=</span> <span class="n">city</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>    <span class="c1"># Mock weather data (always stored in Celsius internally)</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>    <span class="n">mock_weather_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>        <span class="s2">&quot;newyork&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;temp_c&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;sunny&quot;</span><span class="p">},</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>        <span class="s2">&quot;london&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;temp_c&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;cloudy&quot;</span><span class="p">},</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a>        <span class="s2">&quot;tokyo&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;temp_c&quot;</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span> <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;light rain&quot;</span><span class="p">},</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>    <span class="p">}</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a>    <span class="k">if</span> <span class="n">city_normalized</span> <span class="ow">in</span> <span class="n">mock_weather_db</span><span class="p">:</span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">mock_weather_db</span><span class="p">[</span><span class="n">city_normalized</span><span class="p">]</span>
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a>        <span class="n">temp_c</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;temp_c&quot;</span><span class="p">]</span>
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a>        <span class="n">condition</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span>
</span><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a>
</span><span id="__span-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a>        <span class="c1"># Format temperature based on state preference</span>
</span><span id="__span-17-26"><a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a>        <span class="k">if</span> <span class="n">preferred_unit</span> <span class="o">==</span> <span class="s2">&quot;Fahrenheit&quot;</span><span class="p">:</span>
</span><span id="__span-17-27"><a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a>            <span class="n">temp_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_c</span> <span class="o">*</span> <span class="mi">9</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">32</span> <span class="c1"># Calculate Fahrenheit</span>
</span><span id="__span-17-28"><a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a>            <span class="n">temp_unit</span> <span class="o">=</span> <span class="s2">&quot;°F&quot;</span>
</span><span id="__span-17-29"><a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a>        <span class="k">else</span><span class="p">:</span> <span class="c1"># Default to Celsius</span>
</span><span id="__span-17-30"><a id="__codelineno-17-30" name="__codelineno-17-30" href="#__codelineno-17-30"></a>            <span class="n">temp_value</span> <span class="o">=</span> <span class="n">temp_c</span>
</span><span id="__span-17-31"><a id="__codelineno-17-31" name="__codelineno-17-31" href="#__codelineno-17-31"></a>            <span class="n">temp_unit</span> <span class="o">=</span> <span class="s2">&quot;°C&quot;</span>
</span><span id="__span-17-32"><a id="__codelineno-17-32" name="__codelineno-17-32" href="#__codelineno-17-32"></a>
</span><span id="__span-17-33"><a id="__codelineno-17-33" name="__codelineno-17-33" href="#__codelineno-17-33"></a>        <span class="n">report</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The weather in </span><span class="si">{</span><span class="n">city</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">condition</span><span class="si">}</span><span class="s2"> with a temperature of </span><span class="si">{</span><span class="n">temp_value</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}{</span><span class="n">temp_unit</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="__span-17-34"><a id="__codelineno-17-34" name="__codelineno-17-34" href="#__codelineno-17-34"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;report&quot;</span><span class="p">:</span> <span class="n">report</span><span class="p">}</span>
</span><span id="__span-17-35"><a id="__codelineno-17-35" name="__codelineno-17-35" href="#__codelineno-17-35"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: Generated report in </span><span class="si">{</span><span class="n">preferred_unit</span><span class="si">}</span><span class="s2">. Result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
</span><span id="__span-17-36"><a id="__codelineno-17-36" name="__codelineno-17-36" href="#__codelineno-17-36"></a>
</span><span id="__span-17-37"><a id="__codelineno-17-37" name="__codelineno-17-37" href="#__codelineno-17-37"></a>        <span class="c1"># Example of writing back to state (optional for this tool)</span>
</span><span id="__span-17-38"><a id="__codelineno-17-38" name="__codelineno-17-38" href="#__codelineno-17-38"></a>        <span class="n">tool_context</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;last_city_checked_stateful&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">city</span>
</span><span id="__span-17-39"><a id="__codelineno-17-39" name="__codelineno-17-39" href="#__codelineno-17-39"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: Updated state &#39;last_city_checked_stateful&#39;: </span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
</span><span id="__span-17-40"><a id="__codelineno-17-40" name="__codelineno-17-40" href="#__codelineno-17-40"></a>
</span><span id="__span-17-41"><a id="__codelineno-17-41" name="__codelineno-17-41" href="#__codelineno-17-41"></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="__span-17-42"><a id="__codelineno-17-42" name="__codelineno-17-42" href="#__codelineno-17-42"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-17-43"><a id="__codelineno-17-43" name="__codelineno-17-43" href="#__codelineno-17-43"></a>        <span class="c1"># Handle city not found</span>
</span><span id="__span-17-44"><a id="__codelineno-17-44" name="__codelineno-17-44" href="#__codelineno-17-44"></a>        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Sorry, I don&#39;t have weather information for &#39;</span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
</span><span id="__span-17-45"><a id="__codelineno-17-45" name="__codelineno-17-45" href="#__codelineno-17-45"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: City &#39;</span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2">&#39; not found. ---&quot;</span><span class="p">)</span>
</span><span id="__span-17-46"><a id="__codelineno-17-46" name="__codelineno-17-46" href="#__codelineno-17-46"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;error_message&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}</span>
</span><span id="__span-17-47"><a id="__codelineno-17-47" name="__codelineno-17-47" href="#__codelineno-17-47"></a>
</span><span id="__span-17-48"><a id="__codelineno-17-48" name="__codelineno-17-48" href="#__codelineno-17-48"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ State-aware &#39;get_weather_stateful&#39; tool defined.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p><strong>3. 重新定義子 agent 並更新 Root Agent</strong></p>
<p>為了確保此步驟是自洽且能正確建構，我們首先會將 <code>greeting_agent</code> 和 <code>farewell_agent</code> 完全按照步驟 3 的方式重新定義。接著，我們會定義新的 root agent（<code>weather_agent_v4_stateful</code>）：</p>
<ul>
<li>它會使用新的 <code>get_weather_stateful</code> 工具。  </li>
<li>它包含 greeting 和 farewell 子 agent 以便委派任務。  </li>
<li><strong>最重要的是</strong>，它會設定 <code>output_key="last_weather_report"</code>，自動將最終的天氣回應儲存到 session state 中。</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1"># @title 3. Redefine Sub-Agents and Update Root Agent with output_key</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="c1"># Ensure necessary imports: Agent, LiteLlm, Runner</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">Agent</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.models.lite_llm</span><span class="w"> </span><span class="kn">import</span> <span class="n">LiteLlm</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.runners</span><span class="w"> </span><span class="kn">import</span> <span class="n">Runner</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="c1"># Ensure tools &#39;say_hello&#39;, &#39;say_goodbye&#39; are defined (from Step 3)</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="c1"># Ensure model constants MODEL_GPT_4O, MODEL_GEMINI_2_0_FLASH etc. are defined</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="c1"># --- Redefine Greeting Agent (from Step 3) ---</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="n">greeting_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>    <span class="n">greeting_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>        <span class="n">model</span><span class="o">=</span><span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;greeting_agent&quot;</span><span class="p">,</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the Greeting Agent. Your ONLY task is to provide a friendly greeting using the &#39;say_hello&#39; tool. Do nothing else.&quot;</span><span class="p">,</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Handles simple greetings and hellos using the &#39;say_hello&#39; tool.&quot;</span><span class="p">,</span>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">say_hello</span><span class="p">],</span>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>    <span class="p">)</span>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Agent &#39;</span><span class="si">{</span><span class="n">greeting_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; redefined.&quot;</span><span class="p">)</span>
</span><span id="__span-18-21"><a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-18-22"><a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Could not redefine Greeting agent. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-18-23"><a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a>
</span><span id="__span-18-24"><a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="c1"># --- Redefine Farewell Agent (from Step 3) ---</span>
</span><span id="__span-18-25"><a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="n">farewell_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-18-26"><a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-18-27"><a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a>    <span class="n">farewell_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-18-28"><a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a>        <span class="n">model</span><span class="o">=</span><span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
</span><span id="__span-18-29"><a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;farewell_agent&quot;</span><span class="p">,</span>
</span><span id="__span-18-30"><a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the Farewell Agent. Your ONLY task is to provide a polite goodbye message using the &#39;say_goodbye&#39; tool. Do not perform any other actions.&quot;</span><span class="p">,</span>
</span><span id="__span-18-31"><a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Handles simple farewells and goodbyes using the &#39;say_goodbye&#39; tool.&quot;</span><span class="p">,</span>
</span><span id="__span-18-32"><a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">say_goodbye</span><span class="p">],</span>
</span><span id="__span-18-33"><a id="__codelineno-18-33" name="__codelineno-18-33" href="#__codelineno-18-33"></a>    <span class="p">)</span>
</span><span id="__span-18-34"><a id="__codelineno-18-34" name="__codelineno-18-34" href="#__codelineno-18-34"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Agent &#39;</span><span class="si">{</span><span class="n">farewell_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; redefined.&quot;</span><span class="p">)</span>
</span><span id="__span-18-35"><a id="__codelineno-18-35" name="__codelineno-18-35" href="#__codelineno-18-35"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-18-36"><a id="__codelineno-18-36" name="__codelineno-18-36" href="#__codelineno-18-36"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Could not redefine Farewell agent. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-18-37"><a id="__codelineno-18-37" name="__codelineno-18-37" href="#__codelineno-18-37"></a>
</span><span id="__span-18-38"><a id="__codelineno-18-38" name="__codelineno-18-38" href="#__codelineno-18-38"></a><span class="c1"># --- Define the Updated Root Agent ---</span>
</span><span id="__span-18-39"><a id="__codelineno-18-39" name="__codelineno-18-39" href="#__codelineno-18-39"></a><span class="n">root_agent_stateful</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-18-40"><a id="__codelineno-18-40" name="__codelineno-18-40" href="#__codelineno-18-40"></a><span class="n">runner_root_stateful</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Initialize runner</span>
</span><span id="__span-18-41"><a id="__codelineno-18-41" name="__codelineno-18-41" href="#__codelineno-18-41"></a>
</span><span id="__span-18-42"><a id="__codelineno-18-42" name="__codelineno-18-42" href="#__codelineno-18-42"></a><span class="c1"># Check prerequisites before creating the root agent</span>
</span><span id="__span-18-43"><a id="__codelineno-18-43" name="__codelineno-18-43" href="#__codelineno-18-43"></a><span class="k">if</span> <span class="n">greeting_agent</span> <span class="ow">and</span> <span class="n">farewell_agent</span> <span class="ow">and</span> <span class="s1">&#39;get_weather_stateful&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
</span><span id="__span-18-44"><a id="__codelineno-18-44" name="__codelineno-18-44" href="#__codelineno-18-44"></a>
</span><span id="__span-18-45"><a id="__codelineno-18-45" name="__codelineno-18-45" href="#__codelineno-18-45"></a>    <span class="n">root_agent_model</span> <span class="o">=</span> <span class="n">MODEL_GEMINI_2_0_FLASH</span> <span class="c1"># Choose orchestration model</span>
</span><span id="__span-18-46"><a id="__codelineno-18-46" name="__codelineno-18-46" href="#__codelineno-18-46"></a>
</span><span id="__span-18-47"><a id="__codelineno-18-47" name="__codelineno-18-47" href="#__codelineno-18-47"></a>    <span class="n">root_agent_stateful</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-18-48"><a id="__codelineno-18-48" name="__codelineno-18-48" href="#__codelineno-18-48"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_agent_v4_stateful&quot;</span><span class="p">,</span> <span class="c1"># New version name</span>
</span><span id="__span-18-49"><a id="__codelineno-18-49" name="__codelineno-18-49" href="#__codelineno-18-49"></a>        <span class="n">model</span><span class="o">=</span><span class="n">root_agent_model</span><span class="p">,</span>
</span><span id="__span-18-50"><a id="__codelineno-18-50" name="__codelineno-18-50" href="#__codelineno-18-50"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Main agent: Provides weather (state-aware unit), delegates greetings/farewells, saves report to state.&quot;</span><span class="p">,</span>
</span><span id="__span-18-51"><a id="__codelineno-18-51" name="__codelineno-18-51" href="#__codelineno-18-51"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the main Weather Agent. Your job is to provide weather using &#39;get_weather_stateful&#39;. &quot;</span>
</span><span id="__span-18-52"><a id="__codelineno-18-52" name="__codelineno-18-52" href="#__codelineno-18-52"></a>                    <span class="s2">&quot;The tool will format the temperature based on user preference stored in state. &quot;</span>
</span><span id="__span-18-53"><a id="__codelineno-18-53" name="__codelineno-18-53" href="#__codelineno-18-53"></a>                    <span class="s2">&quot;Delegate simple greetings to &#39;greeting_agent&#39; and farewells to &#39;farewell_agent&#39;. &quot;</span>
</span><span id="__span-18-54"><a id="__codelineno-18-54" name="__codelineno-18-54" href="#__codelineno-18-54"></a>                    <span class="s2">&quot;Handle only weather requests, greetings, and farewells.&quot;</span><span class="p">,</span>
</span><span id="__span-18-55"><a id="__codelineno-18-55" name="__codelineno-18-55" href="#__codelineno-18-55"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">get_weather_stateful</span><span class="p">],</span> <span class="c1"># Use the state-aware tool</span>
</span><span id="__span-18-56"><a id="__codelineno-18-56" name="__codelineno-18-56" href="#__codelineno-18-56"></a>        <span class="n">sub_agents</span><span class="o">=</span><span class="p">[</span><span class="n">greeting_agent</span><span class="p">,</span> <span class="n">farewell_agent</span><span class="p">],</span> <span class="c1"># Include sub-agents</span>
</span><span id="__span-18-57"><a id="__codelineno-18-57" name="__codelineno-18-57" href="#__codelineno-18-57"></a>        <span class="n">output_key</span><span class="o">=</span><span class="s2">&quot;last_weather_report&quot;</span> <span class="c1"># &lt;&lt;&lt; Auto-save agent&#39;s final weather response</span>
</span><span id="__span-18-58"><a id="__codelineno-18-58" name="__codelineno-18-58" href="#__codelineno-18-58"></a>    <span class="p">)</span>
</span><span id="__span-18-59"><a id="__codelineno-18-59" name="__codelineno-18-59" href="#__codelineno-18-59"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Root Agent &#39;</span><span class="si">{</span><span class="n">root_agent_stateful</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; created using stateful tool and output_key.&quot;</span><span class="p">)</span>
</span><span id="__span-18-60"><a id="__codelineno-18-60" name="__codelineno-18-60" href="#__codelineno-18-60"></a>
</span><span id="__span-18-61"><a id="__codelineno-18-61" name="__codelineno-18-61" href="#__codelineno-18-61"></a>    <span class="c1"># --- Create Runner for this Root Agent &amp; NEW Session Service ---</span>
</span><span id="__span-18-62"><a id="__codelineno-18-62" name="__codelineno-18-62" href="#__codelineno-18-62"></a>    <span class="n">runner_root_stateful</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
</span><span id="__span-18-63"><a id="__codelineno-18-63" name="__codelineno-18-63" href="#__codelineno-18-63"></a>        <span class="n">agent</span><span class="o">=</span><span class="n">root_agent_stateful</span><span class="p">,</span>
</span><span id="__span-18-64"><a id="__codelineno-18-64" name="__codelineno-18-64" href="#__codelineno-18-64"></a>        <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-18-65"><a id="__codelineno-18-65" name="__codelineno-18-65" href="#__codelineno-18-65"></a>        <span class="n">session_service</span><span class="o">=</span><span class="n">session_service_stateful</span> <span class="c1"># Use the NEW stateful session service</span>
</span><span id="__span-18-66"><a id="__codelineno-18-66" name="__codelineno-18-66" href="#__codelineno-18-66"></a>    <span class="p">)</span>
</span><span id="__span-18-67"><a id="__codelineno-18-67" name="__codelineno-18-67" href="#__codelineno-18-67"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Runner created for stateful root agent &#39;</span><span class="si">{</span><span class="n">runner_root_stateful</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; using stateful session service.&quot;</span><span class="p">)</span>
</span><span id="__span-18-68"><a id="__codelineno-18-68" name="__codelineno-18-68" href="#__codelineno-18-68"></a>
</span><span id="__span-18-69"><a id="__codelineno-18-69" name="__codelineno-18-69" href="#__codelineno-18-69"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-18-70"><a id="__codelineno-18-70" name="__codelineno-18-70" href="#__codelineno-18-70"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ Cannot create stateful root agent. Prerequisites missing.&quot;</span><span class="p">)</span>
</span><span id="__span-18-71"><a id="__codelineno-18-71" name="__codelineno-18-71" href="#__codelineno-18-71"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">greeting_agent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - greeting_agent definition missing.&quot;</span><span class="p">)</span>
</span><span id="__span-18-72"><a id="__codelineno-18-72" name="__codelineno-18-72" href="#__codelineno-18-72"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">farewell_agent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - farewell_agent definition missing.&quot;</span><span class="p">)</span>
</span><span id="__span-18-73"><a id="__codelineno-18-73" name="__codelineno-18-73" href="#__codelineno-18-73"></a>    <span class="k">if</span> <span class="s1">&#39;get_weather_stateful&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - get_weather_stateful tool missing.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p><strong>4. 互動與測試 State 流程</strong></p>
<p>現在，讓我們執行一段對話，來測試 state 互動，這裡會使用 <code>runner_root_stateful</code>（與我們的 stateful agent 以及 <code>session_service_stateful</code> 相關聯）。我們將使用前面定義的 <code>call_agent_async</code> 函式，並確保傳入正確的 Runner、使用者 ID（<code>USER_ID_STATEFUL</code>）以及 session ID（<code>SESSION_ID_STATEFUL</code>）。</p>
<p>對話流程如下：</p>
<ol>
<li><strong>查詢天氣（倫敦）：</strong> <code>get_weather_stateful</code> 工具應該會從在第 1 節初始化的 session state 讀取初始的「Celsius」偏好設定。root agent 的最終回應（攝氏天氣報告）應該會透過 <code>output_key</code> 設定儲存到 <code>state['last_weather_report']</code>。</li>
<li><strong>手動更新 state：</strong> 我們將<em>直接修改</em>儲存在 <code>InMemorySessionService</code> 實例（<code>session_service_stateful</code>）內的 state。<ul>
<li><strong>為什麼要直接修改？</strong> <code>session_service.get_session()</code> 方法會回傳 session 的<em>複本</em>。修改該複本不會影響後續 agent 執行時所使用的 state。針對這個與 <code>InMemorySessionService</code> 相關的測試情境，我們會存取內部的 <code>sessions</code> 字典，將實際儲存的 <code>user_preference_temperature_unit</code> state 值變更為「Fahrenheit」。<em>注意：在實際應用中，state 的變更通常是由工具或 agent 邏輯回傳 <code>EventActions(state_delta=...)</code> 來觸發，而不是直接手動更新。</em></li>
</ul>
</li>
<li><strong>再次查詢天氣（紐約）：</strong> <code>get_weather_stateful</code> 工具現在應該會從 state 讀取更新後的「Fahrenheit」偏好設定，並據此轉換溫度。root agent 的<em>新</em>回應（華氏天氣報告）會因 <code>output_key</code> 而覆蓋掉之前儲存在 <code>state['last_weather_report']</code> 的值。</li>
<li><strong>向 agent 問好：</strong> 驗證委派給 <code>greeting_agent</code> 的功能在進行 stateful 操作時仍能正確運作。這次互動將會成為本次流程中由 <code>output_key</code> 儲存的<em>最後</em>一個回應。</li>
<li><strong>檢查最終 state：</strong> 對話結束後，我們會最後一次取得 session（獲得一個複本），並列印其 state，以確認 <code>user_preference_temperature_unit</code> 的值確實是「Fahrenheit」，觀察由 <code>output_key</code> 儲存的最終值（這次會是問候語），以及查看工具寫入的 <code>last_city_checked_stateful</code> 值。</li>
</ol>
<div class="language-python highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c1"># @title 4. Interact to Test State Flow and output_key</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span> <span class="c1"># Ensure asyncio is imported</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="c1"># Ensure the stateful runner (runner_root_stateful) is available from the previous cell</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="c1"># Ensure call_agent_async, USER_ID_STATEFUL, SESSION_ID_STATEFUL, APP_NAME are defined</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="k">if</span> <span class="s1">&#39;runner_root_stateful&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">runner_root_stateful</span><span class="p">:</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>    <span class="c1"># Define the main async function for the stateful conversation logic.</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>    <span class="c1"># The &#39;await&#39; keywords INSIDE this function are necessary for async operations.</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_stateful_conversation</span><span class="p">():</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Testing State: Temp Unit Conversion &amp; output_key ---&quot;</span><span class="p">)</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>        <span class="c1"># 1. Check weather (Uses initial state: Celsius)</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Turn 1: Requesting weather in London (expect Celsius) ---&quot;</span><span class="p">)</span>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a>        <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="o">=</span> <span class="s2">&quot;What&#39;s the weather in London?&quot;</span><span class="p">,</span>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a>                               <span class="n">runner</span><span class="o">=</span><span class="n">runner_root_stateful</span><span class="p">,</span>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a>                               <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a>                               <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_STATEFUL</span>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a>                              <span class="p">)</span>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a>
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a>        <span class="c1"># 2. Manually update state preference to Fahrenheit - DIRECTLY MODIFY STORAGE</span>
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Manually Updating State: Setting unit to Fahrenheit ---&quot;</span><span class="p">)</span>
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-19-24"><a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a>            <span class="c1"># Access the internal storage directly - THIS IS SPECIFIC TO InMemorySessionService for testing</span>
</span><span id="__span-19-25"><a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a>            <span class="c1"># NOTE: In production with persistent services (Database, VertexAI), you would</span>
</span><span id="__span-19-26"><a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a>            <span class="c1"># typically update state via agent actions or specific service APIs if available,</span>
</span><span id="__span-19-27"><a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a>            <span class="c1"># not by direct manipulation of internal storage.</span>
</span><span id="__span-19-28"><a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a>            <span class="n">stored_session</span> <span class="o">=</span> <span class="n">session_service_stateful</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">APP_NAME</span><span class="p">][</span><span class="n">USER_ID_STATEFUL</span><span class="p">][</span><span class="n">SESSION_ID_STATEFUL</span><span class="p">]</span>
</span><span id="__span-19-29"><a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a>            <span class="n">stored_session</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;user_preference_temperature_unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Fahrenheit&quot;</span>
</span><span id="__span-19-30"><a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a>            <span class="c1"># Optional: You might want to update the timestamp as well if any logic depends on it</span>
</span><span id="__span-19-31"><a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a>            <span class="c1"># import time</span>
</span><span id="__span-19-32"><a id="__codelineno-19-32" name="__codelineno-19-32" href="#__codelineno-19-32"></a>            <span class="c1"># stored_session.last_update_time = time.time()</span>
</span><span id="__span-19-33"><a id="__codelineno-19-33" name="__codelineno-19-33" href="#__codelineno-19-33"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Stored session state updated. Current &#39;user_preference_temperature_unit&#39;: </span><span class="si">{</span><span class="n">stored_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_preference_temperature_unit&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Not Set&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span> <span class="c1"># Added .get for safety</span>
</span><span id="__span-19-34"><a id="__codelineno-19-34" name="__codelineno-19-34" href="#__codelineno-19-34"></a>        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="__span-19-35"><a id="__codelineno-19-35" name="__codelineno-19-35" href="#__codelineno-19-35"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Error: Could not retrieve session &#39;</span><span class="si">{</span><span class="n">SESSION_ID_STATEFUL</span><span class="si">}</span><span class="s2">&#39; from internal storage for user &#39;</span><span class="si">{</span><span class="n">USER_ID_STATEFUL</span><span class="si">}</span><span class="s2">&#39; in app &#39;</span><span class="si">{</span><span class="n">APP_NAME</span><span class="si">}</span><span class="s2">&#39; to update state. Check IDs and if session was created. ---&quot;</span><span class="p">)</span>
</span><span id="__span-19-36"><a id="__codelineno-19-36" name="__codelineno-19-36" href="#__codelineno-19-36"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-19-37"><a id="__codelineno-19-37" name="__codelineno-19-37" href="#__codelineno-19-37"></a>             <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Error updating internal session state: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
</span><span id="__span-19-38"><a id="__codelineno-19-38" name="__codelineno-19-38" href="#__codelineno-19-38"></a>
</span><span id="__span-19-39"><a id="__codelineno-19-39" name="__codelineno-19-39" href="#__codelineno-19-39"></a>        <span class="c1"># 3. Check weather again (Tool should now use Fahrenheit)</span>
</span><span id="__span-19-40"><a id="__codelineno-19-40" name="__codelineno-19-40" href="#__codelineno-19-40"></a>        <span class="c1"># This will also update &#39;last_weather_report&#39; via output_key</span>
</span><span id="__span-19-41"><a id="__codelineno-19-41" name="__codelineno-19-41" href="#__codelineno-19-41"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Turn 2: Requesting weather in New York (expect Fahrenheit) ---&quot;</span><span class="p">)</span>
</span><span id="__span-19-42"><a id="__codelineno-19-42" name="__codelineno-19-42" href="#__codelineno-19-42"></a>        <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="o">=</span> <span class="s2">&quot;Tell me the weather in New York.&quot;</span><span class="p">,</span>
</span><span id="__span-19-43"><a id="__codelineno-19-43" name="__codelineno-19-43" href="#__codelineno-19-43"></a>                               <span class="n">runner</span><span class="o">=</span><span class="n">runner_root_stateful</span><span class="p">,</span>
</span><span id="__span-19-44"><a id="__codelineno-19-44" name="__codelineno-19-44" href="#__codelineno-19-44"></a>                               <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-19-45"><a id="__codelineno-19-45" name="__codelineno-19-45" href="#__codelineno-19-45"></a>                               <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_STATEFUL</span>
</span><span id="__span-19-46"><a id="__codelineno-19-46" name="__codelineno-19-46" href="#__codelineno-19-46"></a>                              <span class="p">)</span>
</span><span id="__span-19-47"><a id="__codelineno-19-47" name="__codelineno-19-47" href="#__codelineno-19-47"></a>
</span><span id="__span-19-48"><a id="__codelineno-19-48" name="__codelineno-19-48" href="#__codelineno-19-48"></a>        <span class="c1"># 4. Test basic delegation (should still work)</span>
</span><span id="__span-19-49"><a id="__codelineno-19-49" name="__codelineno-19-49" href="#__codelineno-19-49"></a>        <span class="c1"># This will update &#39;last_weather_report&#39; again, overwriting the NY weather report</span>
</span><span id="__span-19-50"><a id="__codelineno-19-50" name="__codelineno-19-50" href="#__codelineno-19-50"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Turn 3: Sending a greeting ---&quot;</span><span class="p">)</span>
</span><span id="__span-19-51"><a id="__codelineno-19-51" name="__codelineno-19-51" href="#__codelineno-19-51"></a>        <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="o">=</span> <span class="s2">&quot;Hi!&quot;</span><span class="p">,</span>
</span><span id="__span-19-52"><a id="__codelineno-19-52" name="__codelineno-19-52" href="#__codelineno-19-52"></a>                               <span class="n">runner</span><span class="o">=</span><span class="n">runner_root_stateful</span><span class="p">,</span>
</span><span id="__span-19-53"><a id="__codelineno-19-53" name="__codelineno-19-53" href="#__codelineno-19-53"></a>                               <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-19-54"><a id="__codelineno-19-54" name="__codelineno-19-54" href="#__codelineno-19-54"></a>                               <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_STATEFUL</span>
</span><span id="__span-19-55"><a id="__codelineno-19-55" name="__codelineno-19-55" href="#__codelineno-19-55"></a>                              <span class="p">)</span>
</span><span id="__span-19-56"><a id="__codelineno-19-56" name="__codelineno-19-56" href="#__codelineno-19-56"></a>
</span><span id="__span-19-57"><a id="__codelineno-19-57" name="__codelineno-19-57" href="#__codelineno-19-57"></a>    <span class="c1"># --- Execute the `run_stateful_conversation` async function ---</span>
</span><span id="__span-19-58"><a id="__codelineno-19-58" name="__codelineno-19-58" href="#__codelineno-19-58"></a>    <span class="c1"># Choose ONE of the methods below based on your environment.</span>
</span><span id="__span-19-59"><a id="__codelineno-19-59" name="__codelineno-19-59" href="#__codelineno-19-59"></a>
</span><span id="__span-19-60"><a id="__codelineno-19-60" name="__codelineno-19-60" href="#__codelineno-19-60"></a>    <span class="c1"># METHOD 1: Direct await (Default for Notebooks/Async REPLs)</span>
</span><span id="__span-19-61"><a id="__codelineno-19-61" name="__codelineno-19-61" href="#__codelineno-19-61"></a>    <span class="c1"># If your environment supports top-level await (like Colab/Jupyter notebooks),</span>
</span><span id="__span-19-62"><a id="__codelineno-19-62" name="__codelineno-19-62" href="#__codelineno-19-62"></a>    <span class="c1"># it means an event loop is already running, so you can directly await the function.</span>
</span><span id="__span-19-63"><a id="__codelineno-19-63" name="__codelineno-19-63" href="#__codelineno-19-63"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attempting execution using &#39;await&#39; (default for notebooks)...&quot;</span><span class="p">)</span>
</span><span id="__span-19-64"><a id="__codelineno-19-64" name="__codelineno-19-64" href="#__codelineno-19-64"></a>    <span class="k">await</span> <span class="n">run_stateful_conversation</span><span class="p">()</span>
</span><span id="__span-19-65"><a id="__codelineno-19-65" name="__codelineno-19-65" href="#__codelineno-19-65"></a>
</span><span id="__span-19-66"><a id="__codelineno-19-66" name="__codelineno-19-66" href="#__codelineno-19-66"></a>    <span class="c1"># METHOD 2: asyncio.run (For Standard Python Scripts [.py])</span>
</span><span id="__span-19-67"><a id="__codelineno-19-67" name="__codelineno-19-67" href="#__codelineno-19-67"></a>    <span class="c1"># If running this code as a standard Python script from your terminal,</span>
</span><span id="__span-19-68"><a id="__codelineno-19-68" name="__codelineno-19-68" href="#__codelineno-19-68"></a>    <span class="c1"># the script context is synchronous. `asyncio.run()` is needed to</span>
</span><span id="__span-19-69"><a id="__codelineno-19-69" name="__codelineno-19-69" href="#__codelineno-19-69"></a>    <span class="c1"># create and manage an event loop to execute your async function.</span>
</span><span id="__span-19-70"><a id="__codelineno-19-70" name="__codelineno-19-70" href="#__codelineno-19-70"></a>    <span class="c1"># To use this method:</span>
</span><span id="__span-19-71"><a id="__codelineno-19-71" name="__codelineno-19-71" href="#__codelineno-19-71"></a>    <span class="c1"># 1. Comment out the `await run_stateful_conversation()` line above.</span>
</span><span id="__span-19-72"><a id="__codelineno-19-72" name="__codelineno-19-72" href="#__codelineno-19-72"></a>    <span class="c1"># 2. Uncomment the following block:</span>
</span><span id="__span-19-73"><a id="__codelineno-19-73" name="__codelineno-19-73" href="#__codelineno-19-73"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-19-74"><a id="__codelineno-19-74" name="__codelineno-19-74" href="#__codelineno-19-74"></a><span class="sd">    import asyncio</span>
</span><span id="__span-19-75"><a id="__codelineno-19-75" name="__codelineno-19-75" href="#__codelineno-19-75"></a><span class="sd">    if __name__ == &quot;__main__&quot;: # Ensures this runs only when script is executed directly</span>
</span><span id="__span-19-76"><a id="__codelineno-19-76" name="__codelineno-19-76" href="#__codelineno-19-76"></a><span class="sd">        print(&quot;Executing using &#39;asyncio.run()&#39; (for standard Python scripts)...&quot;)</span>
</span><span id="__span-19-77"><a id="__codelineno-19-77" name="__codelineno-19-77" href="#__codelineno-19-77"></a><span class="sd">        try:</span>
</span><span id="__span-19-78"><a id="__codelineno-19-78" name="__codelineno-19-78" href="#__codelineno-19-78"></a><span class="sd">            # This creates an event loop, runs your async function, and closes the loop.</span>
</span><span id="__span-19-79"><a id="__codelineno-19-79" name="__codelineno-19-79" href="#__codelineno-19-79"></a><span class="sd">            asyncio.run(run_stateful_conversation())</span>
</span><span id="__span-19-80"><a id="__codelineno-19-80" name="__codelineno-19-80" href="#__codelineno-19-80"></a><span class="sd">        except Exception as e:</span>
</span><span id="__span-19-81"><a id="__codelineno-19-81" name="__codelineno-19-81" href="#__codelineno-19-81"></a><span class="sd">            print(f&quot;An error occurred: {e}&quot;)</span>
</span><span id="__span-19-82"><a id="__codelineno-19-82" name="__codelineno-19-82" href="#__codelineno-19-82"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-19-83"><a id="__codelineno-19-83" name="__codelineno-19-83" href="#__codelineno-19-83"></a>
</span><span id="__span-19-84"><a id="__codelineno-19-84" name="__codelineno-19-84" href="#__codelineno-19-84"></a>    <span class="c1"># --- Inspect final session state after the conversation ---</span>
</span><span id="__span-19-85"><a id="__codelineno-19-85" name="__codelineno-19-85" href="#__codelineno-19-85"></a>    <span class="c1"># This block runs after either execution method completes.</span>
</span><span id="__span-19-86"><a id="__codelineno-19-86" name="__codelineno-19-86" href="#__codelineno-19-86"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Inspecting Final Session State ---&quot;</span><span class="p">)</span>
</span><span id="__span-19-87"><a id="__codelineno-19-87" name="__codelineno-19-87" href="#__codelineno-19-87"></a>    <span class="n">final_session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service_stateful</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-19-88"><a id="__codelineno-19-88" name="__codelineno-19-88" href="#__codelineno-19-88"></a>                                                         <span class="n">user_id</span><span class="o">=</span> <span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-19-89"><a id="__codelineno-19-89" name="__codelineno-19-89" href="#__codelineno-19-89"></a>                                                         <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_STATEFUL</span><span class="p">)</span>
</span><span id="__span-19-90"><a id="__codelineno-19-90" name="__codelineno-19-90" href="#__codelineno-19-90"></a>    <span class="k">if</span> <span class="n">final_session</span><span class="p">:</span>
</span><span id="__span-19-91"><a id="__codelineno-19-91" name="__codelineno-19-91" href="#__codelineno-19-91"></a>        <span class="c1"># Use .get() for safer access to potentially missing keys</span>
</span><span id="__span-19-92"><a id="__codelineno-19-92" name="__codelineno-19-92" href="#__codelineno-19-92"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Preference: </span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_preference_temperature_unit&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Not Set&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-19-93"><a id="__codelineno-19-93" name="__codelineno-19-93" href="#__codelineno-19-93"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Last Weather Report (from output_key): </span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_weather_report&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Not Set&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-19-94"><a id="__codelineno-19-94" name="__codelineno-19-94" href="#__codelineno-19-94"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Last City Checked (by tool): </span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_city_checked_stateful&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Not Set&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-19-95"><a id="__codelineno-19-95" name="__codelineno-19-95" href="#__codelineno-19-95"></a>        <span class="c1"># Print full state for detailed view</span>
</span><span id="__span-19-96"><a id="__codelineno-19-96" name="__codelineno-19-96" href="#__codelineno-19-96"></a>        <span class="c1"># print(f&quot;Full State Dict: {final_session.state}&quot;) # For detailed view</span>
</span><span id="__span-19-97"><a id="__codelineno-19-97" name="__codelineno-19-97" href="#__codelineno-19-97"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-19-98"><a id="__codelineno-19-98" name="__codelineno-19-98" href="#__codelineno-19-98"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">❌ Error: Could not retrieve final session state.&quot;</span><span class="p">)</span>
</span><span id="__span-19-99"><a id="__codelineno-19-99" name="__codelineno-19-99" href="#__codelineno-19-99"></a>
</span><span id="__span-19-100"><a id="__codelineno-19-100" name="__codelineno-19-100" href="#__codelineno-19-100"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-19-101"><a id="__codelineno-19-101" name="__codelineno-19-101" href="#__codelineno-19-101"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⚠️ Skipping state test conversation. Stateful root agent runner (&#39;runner_root_stateful&#39;) is not available.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p>透過檢視對話流程與最終 session state 的輸出，你可以確認以下幾點：</p>
<ul>
<li><strong>State Read（狀態讀取）：</strong> weather 工具（<code>get_weather_stateful</code>）正確地從 state 讀取了 <code>user_preference_temperature_unit</code>，一開始對 London 使用「Celsius」。</li>
<li><strong>State Update（狀態更新）：</strong> 直接修改成功地將儲存的偏好設定改為「Fahrenheit」。</li>
<li><strong>State Read（已更新）：</strong> 之後該工具在查詢 New York 天氣時讀取到了「Fahrenheit」，並進行了單位轉換。</li>
<li><strong>Tool State Write（工具狀態寫入）：</strong> 該工具成功地透過 <code>tool_context.state</code> 將 <code>last_city_checked_stateful</code>（第二次查詢天氣後的「New York」）寫入 state。</li>
<li><strong>Delegation（委派）：</strong> 即使在 state 被修改後，對 <code>greeting_agent</code> 的「Hi!」委派仍然正常運作。</li>
<li><strong><code>output_key</code>：</strong> <code>output_key="last_weather_report"</code> 成功地為<em>每一回合</em>儲存了 root agent 的<em>最終</em>回應，只要 root agent 是最終回應者。在這個流程中，最後的回應是問候語（"Hello, there!"），因此這筆資料覆蓋了 state key 中的天氣回報。</li>
<li><strong>Final State（最終狀態）：</strong> 最後確認偏好設定已持續為「Fahrenheit」。</li>
</ul>
<p>你現在已經成功整合 session state 來使用 <code>ToolContext</code> 個人化 agent 行為，並透過手動操作 state 測試了 <code>InMemorySessionService</code>，同時觀察到 <code>output_key</code> 如何提供一個簡單機制，將 agent 的最後回應儲存到 state。這些對於 state 管理的基礎認識，將有助於我們在下一步實作 callback 機制來建立安全防護措施。</p>
<hr />
<h2 id="5-before_model_callback-input-guardrail">步驟 5：加入安全防護 - 透過 <code>before_model_callback</code> 實作輸入防線（Input Guardrail）<a class="headerlink" href="#5-before_model_callback-input-guardrail" title="Permanent link">&para;</a></h2>
<p>我們的 Agent Team 正變得越來越強大，能記住偏好並有效運用工具。然而，在真實世界情境下，我們經常需要安全機制來在潛在有問題的請求進入核心大型語言模型（LLM）<em>之前</em>，就加以控管 agent 的行為。</p>
<p>Agent Development Kit (ADK) 提供了 <strong>Callbacks</strong> —— 允許你在 agent 執行生命週期中特定節點掛鉤（hook）的函式。<code>before_model_callback</code> 對於輸入安全特別有用。</p>
<p><strong>什麼是 <code>before_model_callback</code>？</strong></p>
<ul>
<li>這是一個你自行定義的 Python 函式，Agent Development Kit (ADK) 會在 agent 將彙整好的請求（包含對話歷史、指令與最新使用者訊息）送往底層 LLM <em>之前</em> 執行它。  </li>
<li><strong>用途：</strong> 檢查請求內容，必要時加以修改，或根據預設規則直接阻擋該請求。</li>
</ul>
<p><strong>常見應用情境：</strong></p>
<ul>
<li><strong>輸入驗證／過濾：</strong> 檢查使用者輸入是否符合標準，或是否包含不允許的內容（如個資或關鍵字）。  </li>
<li><strong>安全防線（Guardrails）：</strong> 防止有害、離題或違反政策的請求被送往 LLM 處理。  </li>
<li><strong>動態提示詞修改：</strong> 在送出 LLM 請求前，將即時資訊（例如 session state 中的內容）加入請求上下文。</li>
</ul>
<p><strong>運作方式：</strong></p>
<ol>
<li>
<p>定義一個接收 <code>callback_context: CallbackContext</code> 與 <code>llm_request: LlmRequest</code> 的函式。  </p>
<ul>
<li><code>callback_context</code>：可存取 agent 資訊、session state（<code>callback_context.state</code>）等。  </li>
<li><code>llm_request</code>：包含預計送往 LLM 的完整 payload（<code>contents</code>、<code>config</code>）。  </li>
</ul>
</li>
<li>
<p>在函式內部：</p>
<ul>
<li><strong>檢查（Inspect）：</strong> 檢視 <code>llm_request.contents</code>（特別是最後一則使用者訊息）。</li>
<li><strong>修改（請小心）：</strong> 你<em>可以</em>變更 <code>llm_request</code> 的部分內容。</li>
<li><strong>阻擋（安全防線）：</strong> 回傳 <code>LlmResponse</code> 物件。Agent Development Kit (ADK) 會立即將這個回應送回，<em>跳過</em>本回合的 LLM 呼叫。</li>
<li><strong>允許：</strong> 回傳 <code>None</code>。ADK 將以（可能已修改的）請求繼續呼叫 LLM。</li>
</ul>
</li>
</ol>
<p><strong>本步驟將會：</strong></p>
<ol>
<li>定義一個 <code>before_model_callback</code> 函式（<code>block_keyword_guardrail</code>），檢查使用者輸入是否包含特定關鍵字（"BLOCK"）。</li>
<li>將這個 callback 加入我們的 stateful root agent（步驟 4 的 <code>weather_agent_v4_stateful</code>）。</li>
<li>建立一個新的 runner，綁定這個已更新的 agent，但<em>共用同一個 stateful session service</em>，以維持狀態連續性。</li>
<li>測試此安全防線，分別傳送一般請求與包含關鍵字的請求。</li>
</ol>
<hr />
<p><strong>1. 定義 Guardrail Callback 函式</strong></p>
<p>這個函式會檢查 <code>llm_request</code> 內容中的最後一則使用者訊息。如果發現有 "BLOCK"（不分大小寫），則建立並回傳 <code>LlmResponse</code> 以阻擋流程；否則回傳 <code>None</code>。  </p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1"># @title 1. Define the before_model_callback Guardrail</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="c1"># Ensure necessary imports are available</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.agents.callback_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">CallbackContext</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.models.llm_request</span><span class="w"> </span><span class="kn">import</span> <span class="n">LlmRequest</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.models.llm_response</span><span class="w"> </span><span class="kn">import</span> <span class="n">LlmResponse</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.genai</span><span class="w"> </span><span class="kn">import</span> <span class="n">types</span> <span class="c1"># For creating response content</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">block_keyword_guardrail</span><span class="p">(</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>    <span class="n">callback_context</span><span class="p">:</span> <span class="n">CallbackContext</span><span class="p">,</span> <span class="n">llm_request</span><span class="p">:</span> <span class="n">LlmRequest</span>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LlmResponse</span><span class="p">]:</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="sd">    Inspects the latest user message for &#39;BLOCK&#39;. If found, blocks the LLM call</span>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="sd">    and returns a predefined LlmResponse. Otherwise, returns None to proceed.</span>
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a>    <span class="n">agent_name</span> <span class="o">=</span> <span class="n">callback_context</span><span class="o">.</span><span class="n">agent_name</span> <span class="c1"># Get the name of the agent whose model call is being intercepted</span>
</span><span id="__span-20-18"><a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: block_keyword_guardrail running for agent: </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
</span><span id="__span-20-19"><a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>
</span><span id="__span-20-20"><a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a>    <span class="c1"># Extract the text from the latest user message in the request history</span>
</span><span id="__span-20-21"><a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a>    <span class="n">last_user_message_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-20-22"><a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a>    <span class="k">if</span> <span class="n">llm_request</span><span class="o">.</span><span class="n">contents</span><span class="p">:</span>
</span><span id="__span-20-23"><a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a>        <span class="c1"># Find the most recent message with role &#39;user&#39;</span>
</span><span id="__span-20-24"><a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a>        <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">llm_request</span><span class="o">.</span><span class="n">contents</span><span class="p">):</span>
</span><span id="__span-20-25"><a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a>            <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;user&#39;</span> <span class="ow">and</span> <span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
</span><span id="__span-20-26"><a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a>                <span class="c1"># Assuming text is in the first part for simplicity</span>
</span><span id="__span-20-27"><a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a>                <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span><span id="__span-20-28"><a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a>                    <span class="n">last_user_message_text</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
</span><span id="__span-20-29"><a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a>                    <span class="k">break</span> <span class="c1"># Found the last user message text</span>
</span><span id="__span-20-30"><a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a>
</span><span id="__span-20-31"><a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: Inspecting last user message: &#39;</span><span class="si">{</span><span class="n">last_user_message_text</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39; ---&quot;</span><span class="p">)</span> <span class="c1"># Log first 100 chars</span>
</span><span id="__span-20-32"><a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a>
</span><span id="__span-20-33"><a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a>    <span class="c1"># --- Guardrail Logic ---</span>
</span><span id="__span-20-34"><a id="__codelineno-20-34" name="__codelineno-20-34" href="#__codelineno-20-34"></a>    <span class="n">keyword_to_block</span> <span class="o">=</span> <span class="s2">&quot;BLOCK&quot;</span>
</span><span id="__span-20-35"><a id="__codelineno-20-35" name="__codelineno-20-35" href="#__codelineno-20-35"></a>    <span class="k">if</span> <span class="n">keyword_to_block</span> <span class="ow">in</span> <span class="n">last_user_message_text</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span> <span class="c1"># Case-insensitive check</span>
</span><span id="__span-20-36"><a id="__codelineno-20-36" name="__codelineno-20-36" href="#__codelineno-20-36"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: Found &#39;</span><span class="si">{</span><span class="n">keyword_to_block</span><span class="si">}</span><span class="s2">&#39;. Blocking LLM call! ---&quot;</span><span class="p">)</span>
</span><span id="__span-20-37"><a id="__codelineno-20-37" name="__codelineno-20-37" href="#__codelineno-20-37"></a>        <span class="c1"># Optionally, set a flag in state to record the block event</span>
</span><span id="__span-20-38"><a id="__codelineno-20-38" name="__codelineno-20-38" href="#__codelineno-20-38"></a>        <span class="n">callback_context</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;guardrail_block_keyword_triggered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-20-39"><a id="__codelineno-20-39" name="__codelineno-20-39" href="#__codelineno-20-39"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: Set state &#39;guardrail_block_keyword_triggered&#39;: True ---&quot;</span><span class="p">)</span>
</span><span id="__span-20-40"><a id="__codelineno-20-40" name="__codelineno-20-40" href="#__codelineno-20-40"></a>
</span><span id="__span-20-41"><a id="__codelineno-20-41" name="__codelineno-20-41" href="#__codelineno-20-41"></a>        <span class="c1"># Construct and return an LlmResponse to stop the flow and send this back instead</span>
</span><span id="__span-20-42"><a id="__codelineno-20-42" name="__codelineno-20-42" href="#__codelineno-20-42"></a>        <span class="k">return</span> <span class="n">LlmResponse</span><span class="p">(</span>
</span><span id="__span-20-43"><a id="__codelineno-20-43" name="__codelineno-20-43" href="#__codelineno-20-43"></a>            <span class="n">content</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">Content</span><span class="p">(</span>
</span><span id="__span-20-44"><a id="__codelineno-20-44" name="__codelineno-20-44" href="#__codelineno-20-44"></a>                <span class="n">role</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="c1"># Mimic a response from the agent&#39;s perspective</span>
</span><span id="__span-20-45"><a id="__codelineno-20-45" name="__codelineno-20-45" href="#__codelineno-20-45"></a>                <span class="n">parts</span><span class="o">=</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">Part</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;I cannot process this request because it contains the blocked keyword &#39;</span><span class="si">{</span><span class="n">keyword_to_block</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)],</span>
</span><span id="__span-20-46"><a id="__codelineno-20-46" name="__codelineno-20-46" href="#__codelineno-20-46"></a>            <span class="p">)</span>
</span><span id="__span-20-47"><a id="__codelineno-20-47" name="__codelineno-20-47" href="#__codelineno-20-47"></a>            <span class="c1"># Note: You could also set an error_message field here if needed</span>
</span><span id="__span-20-48"><a id="__codelineno-20-48" name="__codelineno-20-48" href="#__codelineno-20-48"></a>        <span class="p">)</span>
</span><span id="__span-20-49"><a id="__codelineno-20-49" name="__codelineno-20-49" href="#__codelineno-20-49"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-20-50"><a id="__codelineno-20-50" name="__codelineno-20-50" href="#__codelineno-20-50"></a>        <span class="c1"># Keyword not found, allow the request to proceed to the LLM</span>
</span><span id="__span-20-51"><a id="__codelineno-20-51" name="__codelineno-20-51" href="#__codelineno-20-51"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: Keyword not found. Allowing LLM call for </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">. ---&quot;</span><span class="p">)</span>
</span><span id="__span-20-52"><a id="__codelineno-20-52" name="__codelineno-20-52" href="#__codelineno-20-52"></a>        <span class="k">return</span> <span class="kc">None</span> <span class="c1"># Returning None signals ADK to continue normally</span>
</span><span id="__span-20-53"><a id="__codelineno-20-53" name="__codelineno-20-53" href="#__codelineno-20-53"></a>
</span><span id="__span-20-54"><a id="__codelineno-20-54" name="__codelineno-20-54" href="#__codelineno-20-54"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ block_keyword_guardrail function defined.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p><strong>2. 更新 Root Agent 以使用 Callback</strong></p>
<p>我們重新定義 root agent，加入 <code>before_model_callback</code> 參數，並將其指向我們新建立的 guardrail 函式。為了清楚辨識，我們也會給它一個新的版本名稱。</p>
<p><em>重要提示：</em> 如果在前面的步驟中尚未定義，則需要在此 context 內重新定義子 agent（<code>greeting_agent</code>、<code>farewell_agent</code>）以及 stateful tool（<code>get_weather_stateful</code>），以確保 root agent 的定義能夠存取到所有元件。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1"># @title 2. Update Root Agent with before_model_callback</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="c1"># --- Redefine Sub-Agents (Ensures they exist in this context) ---</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="n">greeting_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>    <span class="c1"># Use a defined model constant</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>    <span class="n">greeting_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>        <span class="n">model</span><span class="o">=</span><span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;greeting_agent&quot;</span><span class="p">,</span> <span class="c1"># Keep original name for consistency</span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the Greeting Agent. Your ONLY task is to provide a friendly greeting using the &#39;say_hello&#39; tool. Do nothing else.&quot;</span><span class="p">,</span>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Handles simple greetings and hellos using the &#39;say_hello&#39; tool.&quot;</span><span class="p">,</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">say_hello</span><span class="p">],</span>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>    <span class="p">)</span>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Sub-Agent &#39;</span><span class="si">{</span><span class="n">greeting_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; redefined.&quot;</span><span class="p">)</span>
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Could not redefine Greeting agent. Check Model/API Key (</span><span class="si">{</span><span class="n">greeting_agent</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">). Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-21-18"><a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a>
</span><span id="__span-21-19"><a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a><span class="n">farewell_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-21-20"><a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-21-21"><a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a>    <span class="c1"># Use a defined model constant</span>
</span><span id="__span-21-22"><a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a>    <span class="n">farewell_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-21-23"><a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a>        <span class="n">model</span><span class="o">=</span><span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
</span><span id="__span-21-24"><a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;farewell_agent&quot;</span><span class="p">,</span> <span class="c1"># Keep original name</span>
</span><span id="__span-21-25"><a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the Farewell Agent. Your ONLY task is to provide a polite goodbye message using the &#39;say_goodbye&#39; tool. Do not perform any other actions.&quot;</span><span class="p">,</span>
</span><span id="__span-21-26"><a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Handles simple farewells and goodbyes using the &#39;say_goodbye&#39; tool.&quot;</span><span class="p">,</span>
</span><span id="__span-21-27"><a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">say_goodbye</span><span class="p">],</span>
</span><span id="__span-21-28"><a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a>    <span class="p">)</span>
</span><span id="__span-21-29"><a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Sub-Agent &#39;</span><span class="si">{</span><span class="n">farewell_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; redefined.&quot;</span><span class="p">)</span>
</span><span id="__span-21-30"><a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-21-31"><a id="__codelineno-21-31" name="__codelineno-21-31" href="#__codelineno-21-31"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Could not redefine Farewell agent. Check Model/API Key (</span><span class="si">{</span><span class="n">farewell_agent</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">). Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-21-32"><a id="__codelineno-21-32" name="__codelineno-21-32" href="#__codelineno-21-32"></a>
</span><span id="__span-21-33"><a id="__codelineno-21-33" name="__codelineno-21-33" href="#__codelineno-21-33"></a>
</span><span id="__span-21-34"><a id="__codelineno-21-34" name="__codelineno-21-34" href="#__codelineno-21-34"></a><span class="c1"># --- Define the Root Agent with the Callback ---</span>
</span><span id="__span-21-35"><a id="__codelineno-21-35" name="__codelineno-21-35" href="#__codelineno-21-35"></a><span class="n">root_agent_model_guardrail</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-21-36"><a id="__codelineno-21-36" name="__codelineno-21-36" href="#__codelineno-21-36"></a><span class="n">runner_root_model_guardrail</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-21-37"><a id="__codelineno-21-37" name="__codelineno-21-37" href="#__codelineno-21-37"></a>
</span><span id="__span-21-38"><a id="__codelineno-21-38" name="__codelineno-21-38" href="#__codelineno-21-38"></a><span class="c1"># Check all components before proceeding</span>
</span><span id="__span-21-39"><a id="__codelineno-21-39" name="__codelineno-21-39" href="#__codelineno-21-39"></a><span class="k">if</span> <span class="n">greeting_agent</span> <span class="ow">and</span> <span class="n">farewell_agent</span> <span class="ow">and</span> <span class="s1">&#39;get_weather_stateful&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;block_keyword_guardrail&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
</span><span id="__span-21-40"><a id="__codelineno-21-40" name="__codelineno-21-40" href="#__codelineno-21-40"></a>
</span><span id="__span-21-41"><a id="__codelineno-21-41" name="__codelineno-21-41" href="#__codelineno-21-41"></a>    <span class="c1"># Use a defined model constant</span>
</span><span id="__span-21-42"><a id="__codelineno-21-42" name="__codelineno-21-42" href="#__codelineno-21-42"></a>    <span class="n">root_agent_model</span> <span class="o">=</span> <span class="n">MODEL_GEMINI_2_0_FLASH</span>
</span><span id="__span-21-43"><a id="__codelineno-21-43" name="__codelineno-21-43" href="#__codelineno-21-43"></a>
</span><span id="__span-21-44"><a id="__codelineno-21-44" name="__codelineno-21-44" href="#__codelineno-21-44"></a>    <span class="n">root_agent_model_guardrail</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-21-45"><a id="__codelineno-21-45" name="__codelineno-21-45" href="#__codelineno-21-45"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_agent_v5_model_guardrail&quot;</span><span class="p">,</span> <span class="c1"># New version name for clarity</span>
</span><span id="__span-21-46"><a id="__codelineno-21-46" name="__codelineno-21-46" href="#__codelineno-21-46"></a>        <span class="n">model</span><span class="o">=</span><span class="n">root_agent_model</span><span class="p">,</span>
</span><span id="__span-21-47"><a id="__codelineno-21-47" name="__codelineno-21-47" href="#__codelineno-21-47"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Main agent: Handles weather, delegates greetings/farewells, includes input keyword guardrail.&quot;</span><span class="p">,</span>
</span><span id="__span-21-48"><a id="__codelineno-21-48" name="__codelineno-21-48" href="#__codelineno-21-48"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the main Weather Agent. Provide weather using &#39;get_weather_stateful&#39;. &quot;</span>
</span><span id="__span-21-49"><a id="__codelineno-21-49" name="__codelineno-21-49" href="#__codelineno-21-49"></a>                    <span class="s2">&quot;Delegate simple greetings to &#39;greeting_agent&#39; and farewells to &#39;farewell_agent&#39;. &quot;</span>
</span><span id="__span-21-50"><a id="__codelineno-21-50" name="__codelineno-21-50" href="#__codelineno-21-50"></a>                    <span class="s2">&quot;Handle only weather requests, greetings, and farewells.&quot;</span><span class="p">,</span>
</span><span id="__span-21-51"><a id="__codelineno-21-51" name="__codelineno-21-51" href="#__codelineno-21-51"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">get_weather_stateful</span><span class="p">],</span>
</span><span id="__span-21-52"><a id="__codelineno-21-52" name="__codelineno-21-52" href="#__codelineno-21-52"></a>        <span class="n">sub_agents</span><span class="o">=</span><span class="p">[</span><span class="n">greeting_agent</span><span class="p">,</span> <span class="n">farewell_agent</span><span class="p">],</span> <span class="c1"># Reference the redefined sub-agents</span>
</span><span id="__span-21-53"><a id="__codelineno-21-53" name="__codelineno-21-53" href="#__codelineno-21-53"></a>        <span class="n">output_key</span><span class="o">=</span><span class="s2">&quot;last_weather_report&quot;</span><span class="p">,</span> <span class="c1"># Keep output_key from Step 4</span>
</span><span id="__span-21-54"><a id="__codelineno-21-54" name="__codelineno-21-54" href="#__codelineno-21-54"></a>        <span class="n">before_model_callback</span><span class="o">=</span><span class="n">block_keyword_guardrail</span> <span class="c1"># &lt;&lt;&lt; Assign the guardrail callback</span>
</span><span id="__span-21-55"><a id="__codelineno-21-55" name="__codelineno-21-55" href="#__codelineno-21-55"></a>    <span class="p">)</span>
</span><span id="__span-21-56"><a id="__codelineno-21-56" name="__codelineno-21-56" href="#__codelineno-21-56"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Root Agent &#39;</span><span class="si">{</span><span class="n">root_agent_model_guardrail</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; created with before_model_callback.&quot;</span><span class="p">)</span>
</span><span id="__span-21-57"><a id="__codelineno-21-57" name="__codelineno-21-57" href="#__codelineno-21-57"></a>
</span><span id="__span-21-58"><a id="__codelineno-21-58" name="__codelineno-21-58" href="#__codelineno-21-58"></a>    <span class="c1"># --- Create Runner for this Agent, Using SAME Stateful Session Service ---</span>
</span><span id="__span-21-59"><a id="__codelineno-21-59" name="__codelineno-21-59" href="#__codelineno-21-59"></a>    <span class="c1"># Ensure session_service_stateful exists from Step 4</span>
</span><span id="__span-21-60"><a id="__codelineno-21-60" name="__codelineno-21-60" href="#__codelineno-21-60"></a>    <span class="k">if</span> <span class="s1">&#39;session_service_stateful&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
</span><span id="__span-21-61"><a id="__codelineno-21-61" name="__codelineno-21-61" href="#__codelineno-21-61"></a>        <span class="n">runner_root_model_guardrail</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
</span><span id="__span-21-62"><a id="__codelineno-21-62" name="__codelineno-21-62" href="#__codelineno-21-62"></a>            <span class="n">agent</span><span class="o">=</span><span class="n">root_agent_model_guardrail</span><span class="p">,</span>
</span><span id="__span-21-63"><a id="__codelineno-21-63" name="__codelineno-21-63" href="#__codelineno-21-63"></a>            <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span> <span class="c1"># Use consistent APP_NAME</span>
</span><span id="__span-21-64"><a id="__codelineno-21-64" name="__codelineno-21-64" href="#__codelineno-21-64"></a>            <span class="n">session_service</span><span class="o">=</span><span class="n">session_service_stateful</span> <span class="c1"># &lt;&lt;&lt; Use the service from Step 4</span>
</span><span id="__span-21-65"><a id="__codelineno-21-65" name="__codelineno-21-65" href="#__codelineno-21-65"></a>        <span class="p">)</span>
</span><span id="__span-21-66"><a id="__codelineno-21-66" name="__codelineno-21-66" href="#__codelineno-21-66"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Runner created for guardrail agent &#39;</span><span class="si">{</span><span class="n">runner_root_model_guardrail</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;, using stateful session service.&quot;</span><span class="p">)</span>
</span><span id="__span-21-67"><a id="__codelineno-21-67" name="__codelineno-21-67" href="#__codelineno-21-67"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-21-68"><a id="__codelineno-21-68" name="__codelineno-21-68" href="#__codelineno-21-68"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ Cannot create runner. &#39;session_service_stateful&#39; from Step 4 is missing.&quot;</span><span class="p">)</span>
</span><span id="__span-21-69"><a id="__codelineno-21-69" name="__codelineno-21-69" href="#__codelineno-21-69"></a>
</span><span id="__span-21-70"><a id="__codelineno-21-70" name="__codelineno-21-70" href="#__codelineno-21-70"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-21-71"><a id="__codelineno-21-71" name="__codelineno-21-71" href="#__codelineno-21-71"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ Cannot create root agent with model guardrail. One or more prerequisites are missing or failed initialization:&quot;</span><span class="p">)</span>
</span><span id="__span-21-72"><a id="__codelineno-21-72" name="__codelineno-21-72" href="#__codelineno-21-72"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">greeting_agent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   - Greeting Agent&quot;</span><span class="p">)</span>
</span><span id="__span-21-73"><a id="__codelineno-21-73" name="__codelineno-21-73" href="#__codelineno-21-73"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">farewell_agent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   - Farewell Agent&quot;</span><span class="p">)</span>
</span><span id="__span-21-74"><a id="__codelineno-21-74" name="__codelineno-21-74" href="#__codelineno-21-74"></a>    <span class="k">if</span> <span class="s1">&#39;get_weather_stateful&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   - &#39;get_weather_stateful&#39; tool&quot;</span><span class="p">)</span>
</span><span id="__span-21-75"><a id="__codelineno-21-75" name="__codelineno-21-75" href="#__codelineno-21-75"></a>    <span class="k">if</span> <span class="s1">&#39;block_keyword_guardrail&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   - &#39;block_keyword_guardrail&#39; callback&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p><strong>3. 互動測試 Guardrail</strong></p>
<p>讓我們來測試 guardrail 的行為。我們將使用<em>相同的 session</em>（<code>SESSION_ID_STATEFUL</code>），如步驟 4 中所示，以證明 session state 在這些變更之間會持續存在。</p>
<ol>
<li>發送一般的天氣查詢（應該通過 guardrail 並執行）。</li>
<li>發送包含 "BLOCK" 的請求（應該會被 callback 攔截）。</li>
<li>發送問候語（應該通過 root agent 的 guardrail，被委派並正常執行）。</li>
</ol>
<div class="language-python highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="c1"># @title 3. Interact to Test the Model Input Guardrail</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span> <span class="c1"># Ensure asyncio is imported</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="c1"># Ensure the runner for the guardrail agent is available</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="k">if</span> <span class="s1">&#39;runner_root_model_guardrail&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">runner_root_model_guardrail</span><span class="p">:</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>    <span class="c1"># Define the main async function for the guardrail test conversation.</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>    <span class="c1"># The &#39;await&#39; keywords INSIDE this function are necessary for async operations.</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_guardrail_test_conversation</span><span class="p">():</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Testing Model Input Guardrail ---&quot;</span><span class="p">)</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>        <span class="c1"># Use the runner for the agent with the callback and the existing stateful session ID</span>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>        <span class="c1"># Define a helper lambda for cleaner interaction calls</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>        <span class="n">interaction_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">query</span><span class="p">:</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="p">,</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>                                                         <span class="n">runner_root_model_guardrail</span><span class="p">,</span>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>                                                         <span class="n">USER_ID_STATEFUL</span><span class="p">,</span> <span class="c1"># Use existing user ID</span>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>                                                         <span class="n">SESSION_ID_STATEFUL</span> <span class="c1"># Use existing session ID</span>
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>                                                        <span class="p">)</span>
</span><span id="__span-22-18"><a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>        <span class="c1"># 1. Normal request (Callback allows, should use Fahrenheit from previous state change)</span>
</span><span id="__span-22-19"><a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Turn 1: Requesting weather in London (expect allowed, Fahrenheit) ---&quot;</span><span class="p">)</span>
</span><span id="__span-22-20"><a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a>        <span class="k">await</span> <span class="n">interaction_func</span><span class="p">(</span><span class="s2">&quot;What is the weather in London?&quot;</span><span class="p">)</span>
</span><span id="__span-22-21"><a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a>
</span><span id="__span-22-22"><a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a>        <span class="c1"># 2. Request containing the blocked keyword (Callback intercepts)</span>
</span><span id="__span-22-23"><a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Turn 2: Requesting with blocked keyword (expect blocked) ---&quot;</span><span class="p">)</span>
</span><span id="__span-22-24"><a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a>        <span class="k">await</span> <span class="n">interaction_func</span><span class="p">(</span><span class="s2">&quot;BLOCK the request for weather in Tokyo&quot;</span><span class="p">)</span> <span class="c1"># Callback should catch &quot;BLOCK&quot;</span>
</span><span id="__span-22-25"><a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a>
</span><span id="__span-22-26"><a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a>        <span class="c1"># 3. Normal greeting (Callback allows root agent, delegation happens)</span>
</span><span id="__span-22-27"><a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Turn 3: Sending a greeting (expect allowed) ---&quot;</span><span class="p">)</span>
</span><span id="__span-22-28"><a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a>        <span class="k">await</span> <span class="n">interaction_func</span><span class="p">(</span><span class="s2">&quot;Hello again&quot;</span><span class="p">)</span>
</span><span id="__span-22-29"><a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a>
</span><span id="__span-22-30"><a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a>    <span class="c1"># --- Execute the `run_guardrail_test_conversation` async function ---</span>
</span><span id="__span-22-31"><a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a>    <span class="c1"># Choose ONE of the methods below based on your environment.</span>
</span><span id="__span-22-32"><a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a>
</span><span id="__span-22-33"><a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a>    <span class="c1"># METHOD 1: Direct await (Default for Notebooks/Async REPLs)</span>
</span><span id="__span-22-34"><a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a>    <span class="c1"># If your environment supports top-level await (like Colab/Jupyter notebooks),</span>
</span><span id="__span-22-35"><a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a>    <span class="c1"># it means an event loop is already running, so you can directly await the function.</span>
</span><span id="__span-22-36"><a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attempting execution using &#39;await&#39; (default for notebooks)...&quot;</span><span class="p">)</span>
</span><span id="__span-22-37"><a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a>    <span class="k">await</span> <span class="n">run_guardrail_test_conversation</span><span class="p">()</span>
</span><span id="__span-22-38"><a id="__codelineno-22-38" name="__codelineno-22-38" href="#__codelineno-22-38"></a>
</span><span id="__span-22-39"><a id="__codelineno-22-39" name="__codelineno-22-39" href="#__codelineno-22-39"></a>    <span class="c1"># METHOD 2: asyncio.run (For Standard Python Scripts [.py])</span>
</span><span id="__span-22-40"><a id="__codelineno-22-40" name="__codelineno-22-40" href="#__codelineno-22-40"></a>    <span class="c1"># If running this code as a standard Python script from your terminal,</span>
</span><span id="__span-22-41"><a id="__codelineno-22-41" name="__codelineno-22-41" href="#__codelineno-22-41"></a>    <span class="c1"># the script context is synchronous. `asyncio.run()` is needed to</span>
</span><span id="__span-22-42"><a id="__codelineno-22-42" name="__codelineno-22-42" href="#__codelineno-22-42"></a>    <span class="c1"># create and manage an event loop to execute your async function.</span>
</span><span id="__span-22-43"><a id="__codelineno-22-43" name="__codelineno-22-43" href="#__codelineno-22-43"></a>    <span class="c1"># To use this method:</span>
</span><span id="__span-22-44"><a id="__codelineno-22-44" name="__codelineno-22-44" href="#__codelineno-22-44"></a>    <span class="c1"># 1. Comment out the `await run_guardrail_test_conversation()` line above.</span>
</span><span id="__span-22-45"><a id="__codelineno-22-45" name="__codelineno-22-45" href="#__codelineno-22-45"></a>    <span class="c1"># 2. Uncomment the following block:</span>
</span><span id="__span-22-46"><a id="__codelineno-22-46" name="__codelineno-22-46" href="#__codelineno-22-46"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-22-47"><a id="__codelineno-22-47" name="__codelineno-22-47" href="#__codelineno-22-47"></a><span class="sd">    import asyncio</span>
</span><span id="__span-22-48"><a id="__codelineno-22-48" name="__codelineno-22-48" href="#__codelineno-22-48"></a><span class="sd">    if __name__ == &quot;__main__&quot;: # Ensures this runs only when script is executed directly</span>
</span><span id="__span-22-49"><a id="__codelineno-22-49" name="__codelineno-22-49" href="#__codelineno-22-49"></a><span class="sd">        print(&quot;Executing using &#39;asyncio.run()&#39; (for standard Python scripts)...&quot;)</span>
</span><span id="__span-22-50"><a id="__codelineno-22-50" name="__codelineno-22-50" href="#__codelineno-22-50"></a><span class="sd">        try:</span>
</span><span id="__span-22-51"><a id="__codelineno-22-51" name="__codelineno-22-51" href="#__codelineno-22-51"></a><span class="sd">            # This creates an event loop, runs your async function, and closes the loop.</span>
</span><span id="__span-22-52"><a id="__codelineno-22-52" name="__codelineno-22-52" href="#__codelineno-22-52"></a><span class="sd">            asyncio.run(run_guardrail_test_conversation())</span>
</span><span id="__span-22-53"><a id="__codelineno-22-53" name="__codelineno-22-53" href="#__codelineno-22-53"></a><span class="sd">        except Exception as e:</span>
</span><span id="__span-22-54"><a id="__codelineno-22-54" name="__codelineno-22-54" href="#__codelineno-22-54"></a><span class="sd">            print(f&quot;An error occurred: {e}&quot;)</span>
</span><span id="__span-22-55"><a id="__codelineno-22-55" name="__codelineno-22-55" href="#__codelineno-22-55"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-22-56"><a id="__codelineno-22-56" name="__codelineno-22-56" href="#__codelineno-22-56"></a>
</span><span id="__span-22-57"><a id="__codelineno-22-57" name="__codelineno-22-57" href="#__codelineno-22-57"></a>    <span class="c1"># --- Inspect final session state after the conversation ---</span>
</span><span id="__span-22-58"><a id="__codelineno-22-58" name="__codelineno-22-58" href="#__codelineno-22-58"></a>    <span class="c1"># This block runs after either execution method completes.</span>
</span><span id="__span-22-59"><a id="__codelineno-22-59" name="__codelineno-22-59" href="#__codelineno-22-59"></a>    <span class="c1"># Optional: Check state for the trigger flag set by the callback</span>
</span><span id="__span-22-60"><a id="__codelineno-22-60" name="__codelineno-22-60" href="#__codelineno-22-60"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Inspecting Final Session State (After Guardrail Test) ---&quot;</span><span class="p">)</span>
</span><span id="__span-22-61"><a id="__codelineno-22-61" name="__codelineno-22-61" href="#__codelineno-22-61"></a>    <span class="c1"># Use the session service instance associated with this stateful session</span>
</span><span id="__span-22-62"><a id="__codelineno-22-62" name="__codelineno-22-62" href="#__codelineno-22-62"></a>    <span class="n">final_session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service_stateful</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-22-63"><a id="__codelineno-22-63" name="__codelineno-22-63" href="#__codelineno-22-63"></a>                                                         <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-22-64"><a id="__codelineno-22-64" name="__codelineno-22-64" href="#__codelineno-22-64"></a>                                                         <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_STATEFUL</span><span class="p">)</span>
</span><span id="__span-22-65"><a id="__codelineno-22-65" name="__codelineno-22-65" href="#__codelineno-22-65"></a>    <span class="k">if</span> <span class="n">final_session</span><span class="p">:</span>
</span><span id="__span-22-66"><a id="__codelineno-22-66" name="__codelineno-22-66" href="#__codelineno-22-66"></a>        <span class="c1"># Use .get() for safer access</span>
</span><span id="__span-22-67"><a id="__codelineno-22-67" name="__codelineno-22-67" href="#__codelineno-22-67"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Guardrail Triggered Flag: </span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;guardrail_block_keyword_triggered&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Not Set (or False)&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-22-68"><a id="__codelineno-22-68" name="__codelineno-22-68" href="#__codelineno-22-68"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Last Weather Report: </span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_weather_report&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Not Set&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Should be London weather if successful</span>
</span><span id="__span-22-69"><a id="__codelineno-22-69" name="__codelineno-22-69" href="#__codelineno-22-69"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Temperature Unit: </span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_preference_temperature_unit&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Not Set&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Should be Fahrenheit</span>
</span><span id="__span-22-70"><a id="__codelineno-22-70" name="__codelineno-22-70" href="#__codelineno-22-70"></a>        <span class="c1"># print(f&quot;Full State Dict: {final_session.state}&quot;) # For detailed view</span>
</span><span id="__span-22-71"><a id="__codelineno-22-71" name="__codelineno-22-71" href="#__codelineno-22-71"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-22-72"><a id="__codelineno-22-72" name="__codelineno-22-72" href="#__codelineno-22-72"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">❌ Error: Could not retrieve final session state.&quot;</span><span class="p">)</span>
</span><span id="__span-22-73"><a id="__codelineno-22-73" name="__codelineno-22-73" href="#__codelineno-22-73"></a>
</span><span id="__span-22-74"><a id="__codelineno-22-74" name="__codelineno-22-74" href="#__codelineno-22-74"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-22-75"><a id="__codelineno-22-75" name="__codelineno-22-75" href="#__codelineno-22-75"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⚠️ Skipping model guardrail test. Runner (&#39;runner_root_model_guardrail&#39;) is not available.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p>觀察執行流程：</p>
<ol>
<li><strong>倫敦天氣：</strong> 回呼函式針對 <code>weather_agent_v5_model_guardrail</code> 執行，檢查訊息內容，印出「未找到關鍵字，允許 LLM 呼叫。」並回傳 <code>None</code>。agent 繼續執行，呼叫 <code>get_weather_stateful</code> 工具（會使用步驟 4 狀態變更後的「Fahrenheit」偏好設定），並回傳天氣資訊。此回應會透過 <code>output_key</code> 更新 <code>last_weather_report</code>。  </li>
<li><strong>BLOCK 請求：</strong> 回呼函式再次針對 <code>weather_agent_v5_model_guardrail</code> 執行，檢查訊息，發現「BLOCK」，印出「阻擋 LLM 呼叫！」，設定狀態旗標，並回傳預先定義的 <code>LlmResponse</code>。該回合 agent 底層的大型語言模型 (LLM) <em>完全不會被呼叫</em>。使用者會看到回呼函式的阻擋訊息。  </li>
<li><strong>再次打招呼：</strong> 回呼函式針對 <code>weather_agent_v5_model_guardrail</code> 執行，允許請求。root agent 接著委派給 <code>greeting_agent</code>。<em>注意：root agent 上定義的 <code>before_model_callback</code> 不會自動套用到子 agent。</em> <code>greeting_agent</code> 會正常執行，呼叫其 <code>say_hello</code> 工具並回傳問候語。</li>
</ol>
<p>你已成功實作了一層輸入安全防護！<code>before_model_callback</code> 提供了一個強大的機制，能在昂貴或具潛在風險的大型語言模型 (LLM) 呼叫<em>之前</em>，強制執行規則並控制 agent 行為。接下來，我們將應用類似概念，為工具本身的使用加上防護欄。</p>
<h2 id="6-before_tool_callback">步驟 6：新增安全性 - 工具參數防護欄（<code>before_tool_callback</code>）<a class="headerlink" href="#6-before_tool_callback" title="Permanent link">&para;</a></h2>
<p>在步驟 5 中，我們新增了一個防護欄，用來在使用者輸入<em>進入</em>大型語言模型 (LLM) 前進行檢查並可能阻擋。現在，我們要在 LLM 決定要使用某個工具、但<em>實際執行該工具</em>之前，再加上一層控制。這對於驗證 LLM 想要傳遞給工具的<em>參數</em>特別有用。</p>
<p>Agent Development Kit (ADK) 提供了 <code>before_tool_callback</code>，正是為了這個目的。</p>
<p><strong>什麼是 <code>before_tool_callback</code>？</strong></p>
<ul>
<li>它是一個 Python 函式，會在特定工具函式執行<em>之前</em>被呼叫，時機點是在 LLM 已決定要使用該工具且已決定參數之後。  </li>
<li><strong>用途：</strong> 驗證工具參數、根據特定輸入阻止工具執行、動態修改參數，或強制執行資源使用政策。</li>
</ul>
<p><strong>常見使用情境：</strong></p>
<ul>
<li><strong>參數驗證：</strong> 檢查 LLM 提供的參數是否有效、是否在允許範圍內，或是否符合預期格式。  </li>
<li><strong>資源保護：</strong> 防止工具被傳入可能造成高成本、存取受限資料，或產生不良副作用的輸入（例如：針對特定參數阻擋 API 呼叫）。  </li>
<li><strong>動態參數修改：</strong> 在工具執行前，根據 session state 或其他情境資訊調整參數。</li>
</ul>
<p><strong>運作方式：</strong></p>
<ol>
<li>
<p>定義一個接受 <code>tool: BaseTool</code>、<code>args: Dict[str, Any]</code> 和 <code>tool_context: ToolContext</code> 的函式。  </p>
<ul>
<li><code>tool</code>：即將被呼叫的工具物件（可檢查 <code>tool.name</code>）。  </li>
<li><code>args</code>：LLM 為該工具產生的參數字典。  </li>
<li><code>tool_context</code>：可存取 session state（<code>tool_context.state</code>）、agent 資訊等。  </li>
</ul>
</li>
<li>
<p>在函式內部：  </p>
<ul>
<li><strong>檢查：</strong> 檢視 <code>tool.name</code> 及 <code>args</code> 參數字典。  </li>
<li><strong>修改：</strong> <em>直接</em>變更 <code>args</code> 字典中的值。若回傳 <code>None</code>，工具會以這些修改後的參數執行。  </li>
<li><strong>阻擋／覆寫（防護欄）：</strong> 回傳一個<strong>字典</strong>。Agent Development Kit (ADK) 會將此字典視為工具呼叫的<em>結果</em>，完全<em>跳過</em>原本的工具函式執行。此字典最好能符合該工具預期的回傳格式。  </li>
<li><strong>允許：</strong> 回傳 <code>None</code>。ADK 會以（可能已修改過的）參數執行實際的工具函式。</li>
</ul>
</li>
</ol>
<p><strong>在本步驟中，我們將：</strong></p>
<ol>
<li>定義一個 <code>before_tool_callback</code> 函式（<code>block_paris_tool_guardrail</code>），專門檢查 <code>get_weather_stateful</code> 工具是否被呼叫且城市為「Paris」。  </li>
<li>若偵測到「Paris」，該回呼函式會阻擋工具並回傳自訂錯誤字典。  </li>
<li>更新我們的 root agent（<code>weather_agent_v6_tool_guardrail</code>），同時包含 <code>before_model_callback</code> 及這個新的 <code>before_tool_callback</code>。  </li>
<li>為此 agent 建立新的 runner，並使用同一個具狀態的 session service。  </li>
<li>測試流程，請求允許城市與被阻擋城市（「Paris」）的天氣。</li>
</ol>
<hr />
<p><strong>1. 定義工具防護欄回呼函式</strong></p>
<p>此函式針對 <code>get_weather_stateful</code> 工具。它會檢查 <code>city</code> 參數。如果值為「Paris」，則回傳一個類似該工具錯誤回應的錯誤字典。否則，回傳 <code>None</code> 以允許工具執行。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1"># @title 1. Define the before_tool_callback Guardrail</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="c1"># Ensure necessary imports are available</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.tools.base_tool</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseTool</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.tools.tool_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToolContext</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span> <span class="c1"># For type hints</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">block_paris_tool_guardrail</span><span class="p">(</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>    <span class="n">tool</span><span class="p">:</span> <span class="n">BaseTool</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">tool_context</span><span class="p">:</span> <span class="n">ToolContext</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="sd">    Checks if &#39;get_weather_stateful&#39; is called for &#39;Paris&#39;.</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="sd">    If so, blocks the tool execution and returns a specific error dictionary.</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="sd">    Otherwise, allows the tool call to proceed by returning None.</span>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>    <span class="n">tool_name</span> <span class="o">=</span> <span class="n">tool</span><span class="o">.</span><span class="n">name</span>
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>    <span class="n">agent_name</span> <span class="o">=</span> <span class="n">tool_context</span><span class="o">.</span><span class="n">agent_name</span> <span class="c1"># Agent attempting the tool call</span>
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: block_paris_tool_guardrail running for tool &#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39; in agent &#39;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">&#39; ---&quot;</span><span class="p">)</span>
</span><span id="__span-23-19"><a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: Inspecting args: </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
</span><span id="__span-23-20"><a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>
</span><span id="__span-23-21"><a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a>    <span class="c1"># --- Guardrail Logic ---</span>
</span><span id="__span-23-22"><a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a>    <span class="n">target_tool_name</span> <span class="o">=</span> <span class="s2">&quot;get_weather_stateful&quot;</span> <span class="c1"># Match the function name used by FunctionTool</span>
</span><span id="__span-23-23"><a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a>    <span class="n">blocked_city</span> <span class="o">=</span> <span class="s2">&quot;paris&quot;</span>
</span><span id="__span-23-24"><a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a>
</span><span id="__span-23-25"><a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a>    <span class="c1"># Check if it&#39;s the correct tool and the city argument matches the blocked city</span>
</span><span id="__span-23-26"><a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a>    <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="n">target_tool_name</span><span class="p">:</span>
</span><span id="__span-23-27"><a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a>        <span class="n">city_argument</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;city&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="c1"># Safely get the &#39;city&#39; argument</span>
</span><span id="__span-23-28"><a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a>        <span class="k">if</span> <span class="n">city_argument</span> <span class="ow">and</span> <span class="n">city_argument</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">blocked_city</span><span class="p">:</span>
</span><span id="__span-23-29"><a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: Detected blocked city &#39;</span><span class="si">{</span><span class="n">city_argument</span><span class="si">}</span><span class="s2">&#39;. Blocking tool execution! ---&quot;</span><span class="p">)</span>
</span><span id="__span-23-30"><a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a>            <span class="c1"># Optionally update state</span>
</span><span id="__span-23-31"><a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a>            <span class="n">tool_context</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;guardrail_tool_block_triggered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-23-32"><a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: Set state &#39;guardrail_tool_block_triggered&#39;: True ---&quot;</span><span class="p">)</span>
</span><span id="__span-23-33"><a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a>
</span><span id="__span-23-34"><a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a>            <span class="c1"># Return a dictionary matching the tool&#39;s expected output format for errors</span>
</span><span id="__span-23-35"><a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a>            <span class="c1"># This dictionary becomes the tool&#39;s result, skipping the actual tool run.</span>
</span><span id="__span-23-36"><a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-23-37"><a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a>                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
</span><span id="__span-23-38"><a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a>                <span class="s2">&quot;error_message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Policy restriction: Weather checks for &#39;</span><span class="si">{</span><span class="n">city_argument</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; are currently disabled by a tool guardrail.&quot;</span>
</span><span id="__span-23-39"><a id="__codelineno-23-39" name="__codelineno-23-39" href="#__codelineno-23-39"></a>            <span class="p">}</span>
</span><span id="__span-23-40"><a id="__codelineno-23-40" name="__codelineno-23-40" href="#__codelineno-23-40"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-23-41"><a id="__codelineno-23-41" name="__codelineno-23-41" href="#__codelineno-23-41"></a>             <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: City &#39;</span><span class="si">{</span><span class="n">city_argument</span><span class="si">}</span><span class="s2">&#39; is allowed for tool &#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39;. ---&quot;</span><span class="p">)</span>
</span><span id="__span-23-42"><a id="__codelineno-23-42" name="__codelineno-23-42" href="#__codelineno-23-42"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-23-43"><a id="__codelineno-23-43" name="__codelineno-23-43" href="#__codelineno-23-43"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: Tool &#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39; is not the target tool. Allowing. ---&quot;</span><span class="p">)</span>
</span><span id="__span-23-44"><a id="__codelineno-23-44" name="__codelineno-23-44" href="#__codelineno-23-44"></a>
</span><span id="__span-23-45"><a id="__codelineno-23-45" name="__codelineno-23-45" href="#__codelineno-23-45"></a>
</span><span id="__span-23-46"><a id="__codelineno-23-46" name="__codelineno-23-46" href="#__codelineno-23-46"></a>    <span class="c1"># If the checks above didn&#39;t return a dictionary, allow the tool to execute</span>
</span><span id="__span-23-47"><a id="__codelineno-23-47" name="__codelineno-23-47" href="#__codelineno-23-47"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: Allowing tool &#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39; to proceed. ---&quot;</span><span class="p">)</span>
</span><span id="__span-23-48"><a id="__codelineno-23-48" name="__codelineno-23-48" href="#__codelineno-23-48"></a>    <span class="k">return</span> <span class="kc">None</span> <span class="c1"># Returning None allows the actual tool function to run</span>
</span><span id="__span-23-49"><a id="__codelineno-23-49" name="__codelineno-23-49" href="#__codelineno-23-49"></a>
</span><span id="__span-23-50"><a id="__codelineno-23-50" name="__codelineno-23-50" href="#__codelineno-23-50"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ block_paris_tool_guardrail function defined.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p><strong>2. 更新 Root Agent 以同時使用兩個 Callbacks</strong></p>
<p>我們再次重新定義 root agent（<code>weather_agent_v6_tool_guardrail</code>），這次在步驟 5 的基礎上，加入了 <code>before_tool_callback</code> 參數以及 <code>before_model_callback</code>。</p>
<p><em>自我完備執行注意事項：</em> 與步驟 5 類似，請確保在定義此 agent 之前，所有必要的前置項目（子 agent、tools、<code>before_model_callback</code>）都已經在執行環境中定義或可用。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="c1"># @title 2. Update Root Agent with BOTH Callbacks (Self-Contained)</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="c1"># --- Ensure Prerequisites are Defined ---</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="c1"># (Include or ensure execution of definitions for: Agent, LiteLlm, Runner, ToolContext,</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="c1">#  MODEL constants, say_hello, say_goodbye, greeting_agent, farewell_agent,</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="c1">#  get_weather_stateful, block_keyword_guardrail, block_paris_tool_guardrail)</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="c1"># --- Redefine Sub-Agents (Ensures they exist in this context) ---</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="n">greeting_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>    <span class="c1"># Use a defined model constant</span>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>    <span class="n">greeting_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a>        <span class="n">model</span><span class="o">=</span><span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;greeting_agent&quot;</span><span class="p">,</span> <span class="c1"># Keep original name for consistency</span>
</span><span id="__span-24-15"><a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the Greeting Agent. Your ONLY task is to provide a friendly greeting using the &#39;say_hello&#39; tool. Do nothing else.&quot;</span><span class="p">,</span>
</span><span id="__span-24-16"><a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Handles simple greetings and hellos using the &#39;say_hello&#39; tool.&quot;</span><span class="p">,</span>
</span><span id="__span-24-17"><a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">say_hello</span><span class="p">],</span>
</span><span id="__span-24-18"><a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a>    <span class="p">)</span>
</span><span id="__span-24-19"><a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Sub-Agent &#39;</span><span class="si">{</span><span class="n">greeting_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; redefined.&quot;</span><span class="p">)</span>
</span><span id="__span-24-20"><a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-24-21"><a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Could not redefine Greeting agent. Check Model/API Key (</span><span class="si">{</span><span class="n">greeting_agent</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">). Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-24-22"><a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a>
</span><span id="__span-24-23"><a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a><span class="n">farewell_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-24-24"><a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-24-25"><a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a>    <span class="c1"># Use a defined model constant</span>
</span><span id="__span-24-26"><a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a>    <span class="n">farewell_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-24-27"><a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a>        <span class="n">model</span><span class="o">=</span><span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
</span><span id="__span-24-28"><a id="__codelineno-24-28" name="__codelineno-24-28" href="#__codelineno-24-28"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;farewell_agent&quot;</span><span class="p">,</span> <span class="c1"># Keep original name</span>
</span><span id="__span-24-29"><a id="__codelineno-24-29" name="__codelineno-24-29" href="#__codelineno-24-29"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the Farewell Agent. Your ONLY task is to provide a polite goodbye message using the &#39;say_goodbye&#39; tool. Do not perform any other actions.&quot;</span><span class="p">,</span>
</span><span id="__span-24-30"><a id="__codelineno-24-30" name="__codelineno-24-30" href="#__codelineno-24-30"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Handles simple farewells and goodbyes using the &#39;say_goodbye&#39; tool.&quot;</span><span class="p">,</span>
</span><span id="__span-24-31"><a id="__codelineno-24-31" name="__codelineno-24-31" href="#__codelineno-24-31"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">say_goodbye</span><span class="p">],</span>
</span><span id="__span-24-32"><a id="__codelineno-24-32" name="__codelineno-24-32" href="#__codelineno-24-32"></a>    <span class="p">)</span>
</span><span id="__span-24-33"><a id="__codelineno-24-33" name="__codelineno-24-33" href="#__codelineno-24-33"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Sub-Agent &#39;</span><span class="si">{</span><span class="n">farewell_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; redefined.&quot;</span><span class="p">)</span>
</span><span id="__span-24-34"><a id="__codelineno-24-34" name="__codelineno-24-34" href="#__codelineno-24-34"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-24-35"><a id="__codelineno-24-35" name="__codelineno-24-35" href="#__codelineno-24-35"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Could not redefine Farewell agent. Check Model/API Key (</span><span class="si">{</span><span class="n">farewell_agent</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">). Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-24-36"><a id="__codelineno-24-36" name="__codelineno-24-36" href="#__codelineno-24-36"></a>
</span><span id="__span-24-37"><a id="__codelineno-24-37" name="__codelineno-24-37" href="#__codelineno-24-37"></a><span class="c1"># --- Define the Root Agent with Both Callbacks ---</span>
</span><span id="__span-24-38"><a id="__codelineno-24-38" name="__codelineno-24-38" href="#__codelineno-24-38"></a><span class="n">root_agent_tool_guardrail</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-24-39"><a id="__codelineno-24-39" name="__codelineno-24-39" href="#__codelineno-24-39"></a><span class="n">runner_root_tool_guardrail</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-24-40"><a id="__codelineno-24-40" name="__codelineno-24-40" href="#__codelineno-24-40"></a>
</span><span id="__span-24-41"><a id="__codelineno-24-41" name="__codelineno-24-41" href="#__codelineno-24-41"></a><span class="k">if</span> <span class="p">(</span><span class="s1">&#39;greeting_agent&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">greeting_agent</span> <span class="ow">and</span>
</span><span id="__span-24-42"><a id="__codelineno-24-42" name="__codelineno-24-42" href="#__codelineno-24-42"></a>    <span class="s1">&#39;farewell_agent&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">farewell_agent</span> <span class="ow">and</span>
</span><span id="__span-24-43"><a id="__codelineno-24-43" name="__codelineno-24-43" href="#__codelineno-24-43"></a>    <span class="s1">&#39;get_weather_stateful&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span>
</span><span id="__span-24-44"><a id="__codelineno-24-44" name="__codelineno-24-44" href="#__codelineno-24-44"></a>    <span class="s1">&#39;block_keyword_guardrail&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span>
</span><span id="__span-24-45"><a id="__codelineno-24-45" name="__codelineno-24-45" href="#__codelineno-24-45"></a>    <span class="s1">&#39;block_paris_tool_guardrail&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()):</span>
</span><span id="__span-24-46"><a id="__codelineno-24-46" name="__codelineno-24-46" href="#__codelineno-24-46"></a>
</span><span id="__span-24-47"><a id="__codelineno-24-47" name="__codelineno-24-47" href="#__codelineno-24-47"></a>    <span class="n">root_agent_model</span> <span class="o">=</span> <span class="n">MODEL_GEMINI_2_0_FLASH</span>
</span><span id="__span-24-48"><a id="__codelineno-24-48" name="__codelineno-24-48" href="#__codelineno-24-48"></a>
</span><span id="__span-24-49"><a id="__codelineno-24-49" name="__codelineno-24-49" href="#__codelineno-24-49"></a>    <span class="n">root_agent_tool_guardrail</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-24-50"><a id="__codelineno-24-50" name="__codelineno-24-50" href="#__codelineno-24-50"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_agent_v6_tool_guardrail&quot;</span><span class="p">,</span> <span class="c1"># New version name</span>
</span><span id="__span-24-51"><a id="__codelineno-24-51" name="__codelineno-24-51" href="#__codelineno-24-51"></a>        <span class="n">model</span><span class="o">=</span><span class="n">root_agent_model</span><span class="p">,</span>
</span><span id="__span-24-52"><a id="__codelineno-24-52" name="__codelineno-24-52" href="#__codelineno-24-52"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Main agent: Handles weather, delegates, includes input AND tool guardrails.&quot;</span><span class="p">,</span>
</span><span id="__span-24-53"><a id="__codelineno-24-53" name="__codelineno-24-53" href="#__codelineno-24-53"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the main Weather Agent. Provide weather using &#39;get_weather_stateful&#39;. &quot;</span>
</span><span id="__span-24-54"><a id="__codelineno-24-54" name="__codelineno-24-54" href="#__codelineno-24-54"></a>                    <span class="s2">&quot;Delegate greetings to &#39;greeting_agent&#39; and farewells to &#39;farewell_agent&#39;. &quot;</span>
</span><span id="__span-24-55"><a id="__codelineno-24-55" name="__codelineno-24-55" href="#__codelineno-24-55"></a>                    <span class="s2">&quot;Handle only weather, greetings, and farewells.&quot;</span><span class="p">,</span>
</span><span id="__span-24-56"><a id="__codelineno-24-56" name="__codelineno-24-56" href="#__codelineno-24-56"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">get_weather_stateful</span><span class="p">],</span>
</span><span id="__span-24-57"><a id="__codelineno-24-57" name="__codelineno-24-57" href="#__codelineno-24-57"></a>        <span class="n">sub_agents</span><span class="o">=</span><span class="p">[</span><span class="n">greeting_agent</span><span class="p">,</span> <span class="n">farewell_agent</span><span class="p">],</span>
</span><span id="__span-24-58"><a id="__codelineno-24-58" name="__codelineno-24-58" href="#__codelineno-24-58"></a>        <span class="n">output_key</span><span class="o">=</span><span class="s2">&quot;last_weather_report&quot;</span><span class="p">,</span>
</span><span id="__span-24-59"><a id="__codelineno-24-59" name="__codelineno-24-59" href="#__codelineno-24-59"></a>        <span class="n">before_model_callback</span><span class="o">=</span><span class="n">block_keyword_guardrail</span><span class="p">,</span> <span class="c1"># Keep model guardrail</span>
</span><span id="__span-24-60"><a id="__codelineno-24-60" name="__codelineno-24-60" href="#__codelineno-24-60"></a>        <span class="n">before_tool_callback</span><span class="o">=</span><span class="n">block_paris_tool_guardrail</span> <span class="c1"># &lt;&lt;&lt; Add tool guardrail</span>
</span><span id="__span-24-61"><a id="__codelineno-24-61" name="__codelineno-24-61" href="#__codelineno-24-61"></a>    <span class="p">)</span>
</span><span id="__span-24-62"><a id="__codelineno-24-62" name="__codelineno-24-62" href="#__codelineno-24-62"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Root Agent &#39;</span><span class="si">{</span><span class="n">root_agent_tool_guardrail</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; created with BOTH callbacks.&quot;</span><span class="p">)</span>
</span><span id="__span-24-63"><a id="__codelineno-24-63" name="__codelineno-24-63" href="#__codelineno-24-63"></a>
</span><span id="__span-24-64"><a id="__codelineno-24-64" name="__codelineno-24-64" href="#__codelineno-24-64"></a>    <span class="c1"># --- Create Runner, Using SAME Stateful Session Service ---</span>
</span><span id="__span-24-65"><a id="__codelineno-24-65" name="__codelineno-24-65" href="#__codelineno-24-65"></a>    <span class="k">if</span> <span class="s1">&#39;session_service_stateful&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
</span><span id="__span-24-66"><a id="__codelineno-24-66" name="__codelineno-24-66" href="#__codelineno-24-66"></a>        <span class="n">runner_root_tool_guardrail</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
</span><span id="__span-24-67"><a id="__codelineno-24-67" name="__codelineno-24-67" href="#__codelineno-24-67"></a>            <span class="n">agent</span><span class="o">=</span><span class="n">root_agent_tool_guardrail</span><span class="p">,</span>
</span><span id="__span-24-68"><a id="__codelineno-24-68" name="__codelineno-24-68" href="#__codelineno-24-68"></a>            <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-24-69"><a id="__codelineno-24-69" name="__codelineno-24-69" href="#__codelineno-24-69"></a>            <span class="n">session_service</span><span class="o">=</span><span class="n">session_service_stateful</span> <span class="c1"># &lt;&lt;&lt; Use the service from Step 4/5</span>
</span><span id="__span-24-70"><a id="__codelineno-24-70" name="__codelineno-24-70" href="#__codelineno-24-70"></a>        <span class="p">)</span>
</span><span id="__span-24-71"><a id="__codelineno-24-71" name="__codelineno-24-71" href="#__codelineno-24-71"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Runner created for tool guardrail agent &#39;</span><span class="si">{</span><span class="n">runner_root_tool_guardrail</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;, using stateful session service.&quot;</span><span class="p">)</span>
</span><span id="__span-24-72"><a id="__codelineno-24-72" name="__codelineno-24-72" href="#__codelineno-24-72"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-24-73"><a id="__codelineno-24-73" name="__codelineno-24-73" href="#__codelineno-24-73"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ Cannot create runner. &#39;session_service_stateful&#39; from Step 4/5 is missing.&quot;</span><span class="p">)</span>
</span><span id="__span-24-74"><a id="__codelineno-24-74" name="__codelineno-24-74" href="#__codelineno-24-74"></a>
</span><span id="__span-24-75"><a id="__codelineno-24-75" name="__codelineno-24-75" href="#__codelineno-24-75"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-24-76"><a id="__codelineno-24-76" name="__codelineno-24-76" href="#__codelineno-24-76"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ Cannot create root agent with tool guardrail. Prerequisites missing.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p><strong>3. 互動測試工具防護欄（Tool Guardrail）</strong></p>
<p>讓我們再次使用前述步驟中的相同有狀態 session（<code>SESSION_ID_STATEFUL</code>）來測試互動流程。</p>
<ol>
<li>查詢「New York」的天氣：通過兩個 callback，工具正常執行（使用 session state 中偏好的華氏溫度）。</li>
<li>查詢「Paris」的天氣：通過 <code>before_model_callback</code>。大型語言模型 (LLM) 決定呼叫 <code>get_weather_stateful(city='Paris')</code>。<code>before_tool_callback</code> 進行攔截，阻擋該工具，並回傳錯誤字典。agent 會轉傳此錯誤。</li>
<li>查詢「London」的天氣：通過兩個 callback，工具正常執行。</li>
</ol>
<div class="language-python highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1"># @title 3. Interact to Test the Tool Argument Guardrail</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span> <span class="c1"># Ensure asyncio is imported</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="c1"># Ensure the runner for the tool guardrail agent is available</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="k">if</span> <span class="s1">&#39;runner_root_tool_guardrail&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">runner_root_tool_guardrail</span><span class="p">:</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>    <span class="c1"># Define the main async function for the tool guardrail test conversation.</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>    <span class="c1"># The &#39;await&#39; keywords INSIDE this function are necessary for async operations.</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_tool_guardrail_test</span><span class="p">():</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Testing Tool Argument Guardrail (&#39;Paris&#39; blocked) ---&quot;</span><span class="p">)</span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>        <span class="c1"># Use the runner for the agent with both callbacks and the existing stateful session</span>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>        <span class="c1"># Define a helper lambda for cleaner interaction calls</span>
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a>        <span class="n">interaction_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">query</span><span class="p">:</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="p">,</span>
</span><span id="__span-25-14"><a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a>                                                         <span class="n">runner_root_tool_guardrail</span><span class="p">,</span>
</span><span id="__span-25-15"><a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a>                                                         <span class="n">USER_ID_STATEFUL</span><span class="p">,</span> <span class="c1"># Use existing user ID</span>
</span><span id="__span-25-16"><a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a>                                                         <span class="n">SESSION_ID_STATEFUL</span> <span class="c1"># Use existing session ID</span>
</span><span id="__span-25-17"><a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a>                                                        <span class="p">)</span>
</span><span id="__span-25-18"><a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a>        <span class="c1"># 1. Allowed city (Should pass both callbacks, use Fahrenheit state)</span>
</span><span id="__span-25-19"><a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Turn 1: Requesting weather in New York (expect allowed) ---&quot;</span><span class="p">)</span>
</span><span id="__span-25-20"><a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a>        <span class="k">await</span> <span class="n">interaction_func</span><span class="p">(</span><span class="s2">&quot;What&#39;s the weather in New York?&quot;</span><span class="p">)</span>
</span><span id="__span-25-21"><a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a>
</span><span id="__span-25-22"><a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a>        <span class="c1"># 2. Blocked city (Should pass model callback, but be blocked by tool callback)</span>
</span><span id="__span-25-23"><a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Turn 2: Requesting weather in Paris (expect blocked by tool guardrail) ---&quot;</span><span class="p">)</span>
</span><span id="__span-25-24"><a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a>        <span class="k">await</span> <span class="n">interaction_func</span><span class="p">(</span><span class="s2">&quot;How about Paris?&quot;</span><span class="p">)</span> <span class="c1"># Tool callback should intercept this</span>
</span><span id="__span-25-25"><a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a>
</span><span id="__span-25-26"><a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a>        <span class="c1"># 3. Another allowed city (Should work normally again)</span>
</span><span id="__span-25-27"><a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Turn 3: Requesting weather in London (expect allowed) ---&quot;</span><span class="p">)</span>
</span><span id="__span-25-28"><a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a>        <span class="k">await</span> <span class="n">interaction_func</span><span class="p">(</span><span class="s2">&quot;Tell me the weather in London.&quot;</span><span class="p">)</span>
</span><span id="__span-25-29"><a id="__codelineno-25-29" name="__codelineno-25-29" href="#__codelineno-25-29"></a>
</span><span id="__span-25-30"><a id="__codelineno-25-30" name="__codelineno-25-30" href="#__codelineno-25-30"></a>    <span class="c1"># --- Execute the `run_tool_guardrail_test` async function ---</span>
</span><span id="__span-25-31"><a id="__codelineno-25-31" name="__codelineno-25-31" href="#__codelineno-25-31"></a>    <span class="c1"># Choose ONE of the methods below based on your environment.</span>
</span><span id="__span-25-32"><a id="__codelineno-25-32" name="__codelineno-25-32" href="#__codelineno-25-32"></a>
</span><span id="__span-25-33"><a id="__codelineno-25-33" name="__codelineno-25-33" href="#__codelineno-25-33"></a>    <span class="c1"># METHOD 1: Direct await (Default for Notebooks/Async REPLs)</span>
</span><span id="__span-25-34"><a id="__codelineno-25-34" name="__codelineno-25-34" href="#__codelineno-25-34"></a>    <span class="c1"># If your environment supports top-level await (like Colab/Jupyter notebooks),</span>
</span><span id="__span-25-35"><a id="__codelineno-25-35" name="__codelineno-25-35" href="#__codelineno-25-35"></a>    <span class="c1"># it means an event loop is already running, so you can directly await the function.</span>
</span><span id="__span-25-36"><a id="__codelineno-25-36" name="__codelineno-25-36" href="#__codelineno-25-36"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attempting execution using &#39;await&#39; (default for notebooks)...&quot;</span><span class="p">)</span>
</span><span id="__span-25-37"><a id="__codelineno-25-37" name="__codelineno-25-37" href="#__codelineno-25-37"></a>    <span class="k">await</span> <span class="n">run_tool_guardrail_test</span><span class="p">()</span>
</span><span id="__span-25-38"><a id="__codelineno-25-38" name="__codelineno-25-38" href="#__codelineno-25-38"></a>
</span><span id="__span-25-39"><a id="__codelineno-25-39" name="__codelineno-25-39" href="#__codelineno-25-39"></a>    <span class="c1"># METHOD 2: asyncio.run (For Standard Python Scripts [.py])</span>
</span><span id="__span-25-40"><a id="__codelineno-25-40" name="__codelineno-25-40" href="#__codelineno-25-40"></a>    <span class="c1"># If running this code as a standard Python script from your terminal,</span>
</span><span id="__span-25-41"><a id="__codelineno-25-41" name="__codelineno-25-41" href="#__codelineno-25-41"></a>    <span class="c1"># the script context is synchronous. `asyncio.run()` is needed to</span>
</span><span id="__span-25-42"><a id="__codelineno-25-42" name="__codelineno-25-42" href="#__codelineno-25-42"></a>    <span class="c1"># create and manage an event loop to execute your async function.</span>
</span><span id="__span-25-43"><a id="__codelineno-25-43" name="__codelineno-25-43" href="#__codelineno-25-43"></a>    <span class="c1"># To use this method:</span>
</span><span id="__span-25-44"><a id="__codelineno-25-44" name="__codelineno-25-44" href="#__codelineno-25-44"></a>    <span class="c1"># 1. Comment out the `await run_tool_guardrail_test()` line above.</span>
</span><span id="__span-25-45"><a id="__codelineno-25-45" name="__codelineno-25-45" href="#__codelineno-25-45"></a>    <span class="c1"># 2. Uncomment the following block:</span>
</span><span id="__span-25-46"><a id="__codelineno-25-46" name="__codelineno-25-46" href="#__codelineno-25-46"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-25-47"><a id="__codelineno-25-47" name="__codelineno-25-47" href="#__codelineno-25-47"></a><span class="sd">    import asyncio</span>
</span><span id="__span-25-48"><a id="__codelineno-25-48" name="__codelineno-25-48" href="#__codelineno-25-48"></a><span class="sd">    if __name__ == &quot;__main__&quot;: # Ensures this runs only when script is executed directly</span>
</span><span id="__span-25-49"><a id="__codelineno-25-49" name="__codelineno-25-49" href="#__codelineno-25-49"></a><span class="sd">        print(&quot;Executing using &#39;asyncio.run()&#39; (for standard Python scripts)...&quot;)</span>
</span><span id="__span-25-50"><a id="__codelineno-25-50" name="__codelineno-25-50" href="#__codelineno-25-50"></a><span class="sd">        try:</span>
</span><span id="__span-25-51"><a id="__codelineno-25-51" name="__codelineno-25-51" href="#__codelineno-25-51"></a><span class="sd">            # This creates an event loop, runs your async function, and closes the loop.</span>
</span><span id="__span-25-52"><a id="__codelineno-25-52" name="__codelineno-25-52" href="#__codelineno-25-52"></a><span class="sd">            asyncio.run(run_tool_guardrail_test())</span>
</span><span id="__span-25-53"><a id="__codelineno-25-53" name="__codelineno-25-53" href="#__codelineno-25-53"></a><span class="sd">        except Exception as e:</span>
</span><span id="__span-25-54"><a id="__codelineno-25-54" name="__codelineno-25-54" href="#__codelineno-25-54"></a><span class="sd">            print(f&quot;An error occurred: {e}&quot;)</span>
</span><span id="__span-25-55"><a id="__codelineno-25-55" name="__codelineno-25-55" href="#__codelineno-25-55"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-25-56"><a id="__codelineno-25-56" name="__codelineno-25-56" href="#__codelineno-25-56"></a>
</span><span id="__span-25-57"><a id="__codelineno-25-57" name="__codelineno-25-57" href="#__codelineno-25-57"></a>    <span class="c1"># --- Inspect final session state after the conversation ---</span>
</span><span id="__span-25-58"><a id="__codelineno-25-58" name="__codelineno-25-58" href="#__codelineno-25-58"></a>    <span class="c1"># This block runs after either execution method completes.</span>
</span><span id="__span-25-59"><a id="__codelineno-25-59" name="__codelineno-25-59" href="#__codelineno-25-59"></a>    <span class="c1"># Optional: Check state for the tool block trigger flag</span>
</span><span id="__span-25-60"><a id="__codelineno-25-60" name="__codelineno-25-60" href="#__codelineno-25-60"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Inspecting Final Session State (After Tool Guardrail Test) ---&quot;</span><span class="p">)</span>
</span><span id="__span-25-61"><a id="__codelineno-25-61" name="__codelineno-25-61" href="#__codelineno-25-61"></a>    <span class="c1"># Use the session service instance associated with this stateful session</span>
</span><span id="__span-25-62"><a id="__codelineno-25-62" name="__codelineno-25-62" href="#__codelineno-25-62"></a>    <span class="n">final_session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service_stateful</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-25-63"><a id="__codelineno-25-63" name="__codelineno-25-63" href="#__codelineno-25-63"></a>                                                         <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-25-64"><a id="__codelineno-25-64" name="__codelineno-25-64" href="#__codelineno-25-64"></a>                                                         <span class="n">session_id</span><span class="o">=</span> <span class="n">SESSION_ID_STATEFUL</span><span class="p">)</span>
</span><span id="__span-25-65"><a id="__codelineno-25-65" name="__codelineno-25-65" href="#__codelineno-25-65"></a>    <span class="k">if</span> <span class="n">final_session</span><span class="p">:</span>
</span><span id="__span-25-66"><a id="__codelineno-25-66" name="__codelineno-25-66" href="#__codelineno-25-66"></a>        <span class="c1"># Use .get() for safer access</span>
</span><span id="__span-25-67"><a id="__codelineno-25-67" name="__codelineno-25-67" href="#__codelineno-25-67"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tool Guardrail Triggered Flag: </span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;guardrail_tool_block_triggered&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Not Set (or False)&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-25-68"><a id="__codelineno-25-68" name="__codelineno-25-68" href="#__codelineno-25-68"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Last Weather Report: </span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_weather_report&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Not Set&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Should be London weather if successful</span>
</span><span id="__span-25-69"><a id="__codelineno-25-69" name="__codelineno-25-69" href="#__codelineno-25-69"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Temperature Unit: </span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_preference_temperature_unit&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Not Set&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Should be Fahrenheit</span>
</span><span id="__span-25-70"><a id="__codelineno-25-70" name="__codelineno-25-70" href="#__codelineno-25-70"></a>        <span class="c1"># print(f&quot;Full State Dict: {final_session.state}&quot;) # For detailed view</span>
</span><span id="__span-25-71"><a id="__codelineno-25-71" name="__codelineno-25-71" href="#__codelineno-25-71"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-25-72"><a id="__codelineno-25-72" name="__codelineno-25-72" href="#__codelineno-25-72"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">❌ Error: Could not retrieve final session state.&quot;</span><span class="p">)</span>
</span><span id="__span-25-73"><a id="__codelineno-25-73" name="__codelineno-25-73" href="#__codelineno-25-73"></a>
</span><span id="__span-25-74"><a id="__codelineno-25-74" name="__codelineno-25-74" href="#__codelineno-25-74"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-25-75"><a id="__codelineno-25-75" name="__codelineno-25-75" href="#__codelineno-25-75"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⚠️ Skipping tool guardrail test. Runner (&#39;runner_root_tool_guardrail&#39;) is not available.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p>分析輸出結果：</p>
<ol>
<li><strong>New York：</strong> <code>before_model_callback</code> 允許請求。大型語言模型 (LLM) 請求 <code>get_weather_stateful</code>。<code>before_tool_callback</code> 執行，檢查參數（<code>{'city': 'New York'}</code>），發現不是 "Paris"，印出 "Allowing tool..."，並回傳 <code>None</code>。實際的 <code>get_weather_stateful</code> 函式執行，從 state 讀取 "Fahrenheit"，並回傳天氣報告。agent 轉發這個結果，並透過 <code>output_key</code> 儲存。</li>
<li><strong>Paris：</strong> <code>before_model_callback</code> 允許請求。大型語言模型 (LLM) 請求 <code>get_weather_stateful(city='Paris')</code>。<code>before_tool_callback</code> 執行，檢查參數，偵測到 "Paris"，印出 "Blocking tool execution!"，設置 state 標誌，並回傳錯誤字典 <code>{'status': 'error', 'error_message': 'Policy restriction...'}</code>。實際的 <code>get_weather_stateful</code> 函式<strong>從未被執行</strong>。agent 收到錯誤字典（<em>就像是工具的輸出</em>），並根據該錯誤訊息組成回應。</li>
<li><strong>London：</strong> 行為與 New York 相同，通過兩個 callback 並成功執行工具。新的 London 天氣報告會覆蓋 state 中的 <code>last_weather_report</code>。</li>
</ol>
<p>你現在已經新增了一層關鍵的安全防護，不僅控制<em>什麼</em>可以傳遞給大型語言模型 (LLM)，還能根據 LLM 產生的特定參數，控制 agent 的工具如何被使用。像 <code>before_model_callback</code> 和 <code>before_tool_callback</code> 這樣的 Callback，對於打造健壯、安全且符合政策規範的 agent 應用至關重要。</p>
<hr />
<h2 id="agent-team">結論：你的 Agent Team 已經準備就緒！<a class="headerlink" href="#agent-team" title="Permanent link">&para;</a></h2>
<p>恭喜你！你已經成功從建立單一、基礎的天氣 agent，進階到利用 Agent Development Kit (ADK) 建構一個複雜的多 agent 團隊。</p>
<p><strong>讓我們回顧一下你完成了哪些事情：</strong></p>
<ul>
<li>你從一個<strong>基礎 agent</strong>開始，配備單一工具（<code>get_weather</code>）。</li>
<li>你利用 LiteLLM 探索了 ADK 的<strong>多模型彈性</strong>，用不同的大型語言模型 (LLM)（如 Gemini、GPT-4o 和 Claude）運行相同核心邏輯。</li>
<li>你實踐了<strong>模組化</strong>，建立專門的子 agent（<code>greeting_agent</code>、<code>farewell_agent</code>），並讓 root agent 能<strong>自動委派</strong>。</li>
<li>你讓 agent 具備<strong>記憶功能</strong>，透過 <strong>session state</strong> 記住使用者偏好（<code>temperature_unit</code>）及過往互動（<code>output_key</code>）。</li>
<li>你實作了關鍵的<strong>安全防護措施</strong>，同時用 <code>before_model_callback</code>（阻擋特定輸入關鍵字）及 <code>before_tool_callback</code>（根據參數如城市 "Paris" 阻擋工具執行）。</li>
</ul>
<p>透過打造這個循序漸進的 Weather Bot 團隊，你已經親身體驗了開發複雜智慧應用所需的 ADK 核心概念。</p>
<p><strong>重點整理：</strong></p>
<ul>
<li><strong>Agents &amp; Tools：</strong> 定義能力與推理的基本組件。清楚的指令與 docstring 極為重要。</li>
<li><strong>Runners &amp; Session Services：</strong> 負責 agent 執行與維護對話脈絡的引擎與記憶管理系統。</li>
<li><strong>Delegation（委派）：</strong> 設計多 agent 團隊能帶來專業分工、模組化，以及更佳的複雜任務管理。Agent <code>description</code> 是自動流程的關鍵。</li>
<li><strong>Session State（<code>ToolContext</code>、<code>output_key</code>）：</strong> 打造具脈絡感知、個人化、多輪對話 agent 的核心。</li>
<li><strong>Callbacks（<code>before_model</code>、<code>before_tool</code>）：</strong> 強大的鉤子，可在關鍵操作（LLM 呼叫或工具執行）<em>之前</em>實作安全、驗證、政策控管與動態調整。</li>
<li><strong>彈性（<code>LiteLlm</code>）：</strong> ADK 讓你能依任務需求選擇最佳 LLM，兼顧效能、成本與功能。</li>
</ul>
<p><strong>接下來可以做什麼？</strong></p>
<p>你的 Weather Bot 團隊是一個很棒的起點。以下是一些進一步探索 ADK 並強化應用的建議：</p>
<ol>
<li><strong>串接真實天氣 API：</strong> 將 <code>get_weather</code> 工具中的 <code>mock_weather_db</code>，改為呼叫真實的天氣 API（如 OpenWeatherMap、WeatherAPI）。</li>
<li><strong>更複雜的 state：</strong> 在 session state 儲存更多使用者偏好（例如預設地點、通知設定）或對話摘要。</li>
<li><strong>優化委派邏輯：</strong> 嘗試不同的 root agent 指令或子 agent 描述，微調委派邏輯。你能否新增一個 "forecast" agent？</li>
<li><strong>進階 Callback：</strong><ul>
<li>使用 <code>after_model_callback</code>，在 LLM 產生回應<em>之後</em>，進行格式化或淨化。</li>
<li>使用 <code>after_tool_callback</code>，處理或記錄工具回傳的結果。</li>
<li>實作 <code>before_agent_callback</code> 或 <code>after_agent_callback</code>，用於 agent 層級的進入/離開邏輯。</li>
</ul>
</li>
<li><strong>錯誤處理：</strong> 改善 agent 處理工具錯誤或非預期 API 回應的方式。也許可以在工具內加入重試邏輯。</li>
<li><strong>持久化 session 儲存：</strong> 探索 <code>InMemorySessionService</code> 以外的持久化 session state 方案（例如使用 Firestore 或 Cloud SQL 資料庫——需自訂實作或等待未來 ADK 整合）。</li>
<li><strong>串流 UI：</strong> 將 agent 團隊與網頁框架（如 ADK Streaming Quickstart 展示的 FastAPI）整合，打造即時聊天介面。</li>
</ol>
<p>Agent Development Kit (ADK) 為建構先進 LLM 應用提供了堅實基礎。只要掌握本教學涵蓋的工具、state、委派與 Callback 等概念，你就能駕馭日益複雜的 agent 系統。</p>
<p>祝你開發順利！</p>









  




                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../" class="md-footer__link md-footer__link--prev" aria-label="Previous: ADK 教學指南！">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                ADK 教學指南！
              </div>
            </div>
          </a>
        
        
          
          <a href="../../agents/" class="md-footer__link md-footer__link--next" aria-label="Next: Agents">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Agents
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright Google 2025&nbsp;&nbsp;|&nbsp;&nbsp;<a href="//policies.google.com/terms">服務條款</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="//policies.google.com/privacy">隱私權政策</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="#__consent">管理 Cookie</a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            


  


<h4>Cookie 同意</h4>
<p>我們使用 Cookie 來辨識重複造訪與偏好設定， 並評估我們文件的成效，以及使用者是否能找到所需資訊。經您同意後， 您將協助我們持續優化文件品質。</p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
    
      
        
  
  
    
    
  
  <li class="task-list-item">
    <label class="task-list-control">
      <input type="checkbox" name="analytics" checked>
      <span class="task-list-indicator"></span>
      Google Analytics
    </label>
  </li>

      
    
    
      
        
  
  
    
    
  
  <li class="task-list-item">
    <label class="task-list-control">
      <input type="checkbox" name="github" checked>
      <span class="task-list-indicator"></span>
      GitHub
    </label>
  </li>

      
    
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Accept</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Manage settings</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script>
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.annotate", "content.code.copy", "content.code.select", "content.tabs.link", "content.tooltips", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.progress", "navigation.path", "navigation.top", "navigation.tracking", "toc.follow"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>